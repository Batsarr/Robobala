<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Robot LQR - Panel Sterowania v42.6 (FINAL)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bayes-optimizer@0.3.1/dist/bayes-optimizer.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 15px; background-color: #282c34; color: #fff; font-size: 14px; }
        h1 { color: #61dafb; font-size: 1.8em; }
        h2 { color: #61dafb; font-size: 1.4em; margin-top: 0; margin-bottom: 15px; }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; align-items: start; max-width: 1920px; margin: auto; }
        .card { background-color: #3a3f47; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .info-grid, .status-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px; text-align: left; font-size: 1em; margin-top: 10px; align-items: center;}
        .info-grid strong, .status-grid strong { color: #a2f279; }
        button { background-color: #61dafb; color: #282c34; border: none; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, opacity 0.3s, box-shadow 0.2s; font-size: 0.9em; }
        button:hover { background-color: #a2f279; }
        button:disabled { background-color: #4a4f58; color: #888; cursor: not-allowed; opacity: 0.6; }
        .gamepad-flash { box-shadow: 0 0 10px 3px #a2f279 !important; }
        #emergencyStopBtn { background-color: #ff6347; color: white; width: 100%; margin-top: 15px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 10px; }
        .control-label { font-size: 1.1em; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider.round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ff6347; transition: .4s; border-radius: 28px; }
        .slider.round:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #a2f279; }
        input:checked + .slider:before { transform: translateX(22px); }
        input:disabled + .slider { background-color: #4a4f58; cursor: not-allowed; }
        fieldset { border: 1px solid #4a4f58; border-radius: 8px; margin-top: 15px; padding: 10px 15px; }
        legend { color: #61dafb; font-weight: bold; padding: 0 10px; font-size: 1.1em; }
        #joystickWrapper { position: relative; width: 180px; height: 180px; border-radius: 50%; background-color: #4a4f58; border: 3px solid #61dafb; margin: 15px auto; touch-action: none; }
        #joystickCanvas { width: 100%; height: 100%; display: block; }
        #chart-wrapper { position: relative; height: 320px; border-radius: 8px; overflow: hidden; background-color: #20232a; }
        #log-history { text-align: left; height: 350px; overflow-y: auto; background-color: #20232a; padding: 10px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; }
        .status-indicator { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
        .status-ok { background-color: #a2f279; }
        .status-warn { background-color: #f7b731; }
        .status-error { background-color: #ff6347; }
        .status-disconnected { background-color: #888; }
        #emergency-banner { display: none; background-color: #ff6347; color: white; padding: 10px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        .angle-display { display: flex; align-items: center; justify-content: space-between; }
        .angle-indicator-wrapper { position: relative; width: 34px; height: 34px; background-color: #20232a; border-radius: 50%; border: 1px solid #61dafb; }
        .angle-indicator-needle { position: absolute; bottom: 50%; left: calc(50% - 1px); width: 2px; height: 50%; background-color: #ff6347; transform-origin: bottom center; transition: transform 0.1s linear; }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; font-size: 0.9em; }
        .chart-controls label { color: #fff; }
        .setting-container { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 8px 0; }
        .setting-container label { font-size: 1em; font-weight: bold; color: #a2f279; text-align: left; }
        .numeric-input-wrapper { display: flex; align-items: center; flex-shrink: 0; }
        .numeric-input-wrapper button { background-color: #4a4f58; color: #61dafb; padding: 4px 8px; font-size: 1em; line-height: 1; min-width: 30px; }
        .numeric-input-wrapper input[type=number] { width: 90px; text-align: center; font-size: 1em; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 5px; margin: 0 4px; padding: 4px; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .manual-tune-row { background-color: #2a2f35; padding: 10px; border-radius: 6px; margin-bottom: 12px; }
        .pwm-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pwm-input-row label { font-weight: bold; color: #a2f279; }
        .pwm-button-row { display: flex; justify-content: flex-end; gap: 10px; }
        .pwm-button-row button { flex-grow: 1; max-width: 100px; }
        .test-btn { background-color: #a2f279; }
        .stop-btn { background-color: #ff6347; }
        .auto-btn { background-color: #f7b731; }
        .trim-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .trim-controls span { font-weight: bold; }
        .trim-controls button { min-width: 40px; font-size: 1.2em; }
        .dpad-container { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 5px; max-width: 150px; margin: 15px auto; }
        .dpad-btn { background-color: #61dafb; color: #282c34; border-radius: 5px; font-size: 2em; line-height: 1; padding: 5px; cursor: pointer; border: none; }
        .dpad-btn:hover { background-color: #a2f279; }
        #dpad-up { grid-column: 2; grid-row: 1; }
        #dpad-left { grid-column: 1; grid-row: 2; }
        #dpad-right { grid-column: 3; grid-row: 2; }
        #dpad-down { grid-column: 2; grid-row: 3; }
        #dpad-stop { grid-column: 2; grid-row: 2; background-color: #ff6347; color: white; }
        .dpad-input-group { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 10px 0; }
        .dpad-input-group label { text-align: right; font-weight: bold; color: #a2f279; }
        .dpad-input-group input { width: 100%; box-sizing: border-box; }
        .accordion-header { background-color: #4a4f58; color: #61dafb; cursor: pointer; padding: 12px 15px; border: none; text-align: left; outline: none; font-size: 1.1em; font-weight: bold; width: 100%; border-radius: 8px; margin-top: 5px; transition: background-color 0.3s; position: relative; }
        .accordion-header:hover { background-color: #5a6068; }
        .accordion-header.active { background-color: #61dafb; color: #282c34; border-bottom-left-radius: 0; border-bottom-right-radius: 0;}
        .accordion-header::after { content: '+'; position: absolute; right: 15px; font-size: 1.4em; transition: transform 0.3s; }
        .accordion-header.active::after { content: '-'; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background-color: #3a3f47; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}
        .accordion-content.active { padding: 15px; }
        .pwm-info { background-color: #20232a; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #61dafb; }
        .pwm-info strong { color: #a2f279; }
        .parameter-group { background-color: #20232a; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
        .parameter-group h5 { color: #61dafb; margin: 0 0 8px 0; font-size: 1.1em; }
        .help-icon { display: inline-block; width: 16px; height: 16px; border-radius: 50%; background-color: #61dafb; color: #282c34; font-size: 12px; font-weight: bold; text-align: center; line-height: 16px; margin-left: 8px; cursor: pointer; user-select: none; }
        .help-text { background-color: #20232a; color: #fff; border-radius: 6px; padding: 10px; border: 1px solid #61dafb; margin-top: 8px; text-align: left; font-size: 0.9em; line-height: 1.4; width: 100%; box-sizing: border-box; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding-top: 0; padding-bottom: 0; grid-column: 1 / -1; }
        .help-text.visible { max-height: 200px; padding-top: 10px; padding-bottom: 10px; }
        .sequence-step { display: grid; grid-template-columns: 1fr 100px auto; gap: 10px; align-items: center; background-color: #2a2f35; padding: 8px; border-radius: 6px; margin-bottom: 8px; transition: background-color: 0.3s; }
        .sequence-step.executing { background-color: #a2f279; color: #282c34; }
        .sequence-step.executing select, .sequence-step.executing input { color: #282c34; border-color: #282c34; }
        .sequence-step select, .sequence-step input { width: 100%; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 4px; padding: 5px; }
        .sequence-step .remove-step-btn { background-color: #ff6347; padding: 5px 10px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background-color: #3a3f47; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .mapping-row { display: grid; grid-template-columns: 1fr 100px 100px; gap: 10px; align-items: center; margin-bottom: 10px; }
        .mapping-label { text-align: left; font-weight: bold; }
        .mapping-button { font-size: 0.8em; padding: 6px 8px; }
        .mapping-display { background-color: #20232a; padding: 6px; border-radius: 4px; font-family: monospace; }
        .preset-actions { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        #applySelectedPresetBtn { background-color: #a2f279; }
        #saveCurrentAsPresetBtn { background-color: #61dafb; }
        #bopt-progress-bar-container { width: 100%; background-color: #20232a; border-radius: 5px; overflow: hidden; margin: 10px 0; border: 1px solid #61dafb;}
        #bopt-progress-bar { width: 0%; height: 20px; background-color: #a2f279; transition: width 0.5s ease; }
        .bopt-status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 15px; text-align: left; margin-bottom: 15px; }
        .bopt-status-grid strong { color: #61dafb; }
        #bopt-best-params-display, #bopt-current-params-display { background-color: #20232a; border-radius: 5px; padding: 10px; font-family: monospace; text-align: left; white-space: pre; font-size: 0.9em; line-height: 1.5; }
    </style>
</head>
<body>
    <div id="emergency-banner">ZATRZYMANIE AWARYJNE</div>
    <div id="gamepad-mapping-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Mapowanie Przyciskow Gamepada</h2>
            <div id="gamepad-mapping-list"></div>
            <button id="close-modal-btn" style="margin-top: 20px;">Zamknij</button>
        </div>
    </div>

    <h1>Robot LQR - Panel Sterowania</h1>
    <div class="main-grid">
        <div class="card" id="controls-card">
            <h2>Sterowanie</h2>
            <div id="joystickWrapper"><canvas id="joystickCanvas"></canvas></div>
            <div class="control-row"><span class="control-label">Balansowanie</span><label class="switch"><input type="checkbox" id="balanceSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">Trzymaj Pozycje</span><label class="switch"><input type="checkbox" id="holdPositionSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">Tryb Predkosci</span><label class="switch"><input type="checkbox" id="speedModeSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">LQR Aktywny</span><label class="switch"><input type="checkbox" id="lqrEnabledSwitch" checked><span class="slider round"></span></label></div>
            
            <fieldset style="margin-top:20px;"><legend>Ustawienia Globalne</legend>
                <div class="setting-container">
                    <label for="globalPowerLimitInput">Globalny Limit Mocy (%)<span class="help-icon">?</span></label>
                    <div class="numeric-input-wrapper"><button id="globalPowerLimitMinus">-</button><input type="number" class="config-value" id="globalPowerLimitInput" min="10" max="100" step="1" value="100"><button id="globalPowerLimitPlus">+</button></div>
                    <div class="help-text">Ogranicza maksymalna moc (PWM) wysylana do silnikow. Uzyj, aby globalnie "uspokoic" lub "wzmocnic" robota bez zmiany logiki regulatorow.</div>
                </div>
            </fieldset>

            <fieldset style="padding: 10px 10px 5px 10px; margin-top:20px;"><legend>Strojenie Joysticka</legend>
                <div class="setting-container"><label for="joystickOutputScaleInput">Skala Wyjscia (%)</label><div class="numeric-input-wrapper"><button id="joystickOutputScaleMinus">-</button><input type="number" class="config-value" id="joystickOutputScaleInput" min="10" max="100" step="5" value="100"><button id="joystickOutputScalePlus">+</button></div></div>
                <div class="setting-container"><label for="expoJoystickInput">Expo Joysticka (%)</label><div class="numeric-input-wrapper"><button id="expoJoystickMinus">-</button><input type="number" class="config-value" id="expoJoystickInput" min="0" max="90" step="1" value="0"><button id="expoJoystickPlus">+</button></div></div>
                <div class="setting-container"><label for="maxSpeedJoystickInput">Max. predkosc (imp/s)</label><div class="numeric-input-wrapper"><button id="maxSpeedJoystickMinus">-</button><input type="number" class="config-value" id="maxSpeedJoystickInput" min="200" max="4000" step="100" value="800"><button id="maxSpeedJoystickPlus">+</button></div></div>
                <div class="setting-container"><label for="joystickAngleSensitivityInput">Czulosc Kata (st.)</label><div class="numeric-input-wrapper"><button id="joystickAngleSensitivityMinus">-</button><input type="number" class="config-value" id="joystickAngleSensitivityInput" min="1" max="30" step="0.5" value="10"><button id="joystickAngleSensitivityPlus">+</button></div></div>
                <div class="setting-container"><label for="turnFactorInput">Czulosc Skretu (%)</label><div class="numeric-input-wrapper"><button id="turnFactorMinus">-</button><input type="number" class="config-value" id="turnFactorInput" min="0" max="100" step="5" value="25"><button id="turnFactorPlus">+</button></div></div>
            </fieldset>

            <button id="open-gamepad-modal-btn" style="width: 100%; background-color:#f7b731; margin-top: 15px;">Mapowanie Przyciskow Gamepada</button>
            <button id="resetZeroBtn" style="margin-top:10px; width:100%;">Resetuj Osie</button>

            <div class="trim-controls">
                <button id="trimMinusBtn">-</button>
                <span>Korekta Pionu (Pitch)</span>
                <button id="trimPlusBtn">+</button>
            </div>
            <div class="trim-controls">
                <button id="trimRollMinusBtn">-</button>
                <span>Korekta Przechylu (Roll)</span>
                <button id="trimRollPlusBtn">+</button>
            </div>
            
            <button id="resetEncodersBtn" style="margin-top:10px; background-color:#f7b731; width: 100%;">Resetuj Enkodery</button>
            
            <button id="emergencyStopBtn">STOP AWARYJNY</button>
        </div>
        
        <div class="card">
            <h2>Status Robota</h2>
            <button id="connectBleBtn" style="width: 100%; margin-bottom: 15px;">POLACZ Z ROBOTEM</button>
            <div class="status-grid">
                <strong>Polaczenie:</strong> <div><span id="connectionStatus" class="status-indicator status-disconnected"></span> <span id="connectionText">Rozlaczony</span></div>
                <strong>Gamepad:</strong> <span id="gamepadStatus" style="font-weight:bold; color: #f7b731;">Brak</span>
                <strong>Tryb Pracy:</strong> <span id="robotStateVal" style="font-weight:bold; color: #61dafb;">IDLE</span>
            </div>
            <div class="info-grid">
                <strong>Kat (Pitch):</strong> <div class="angle-display"><span id="angleVal">0.0 &deg;</span><div class="angle-indicator-wrapper"><div id="angleIndicator" class="angle-indicator-needle"></div></div></div>
                <strong>Predkosc (imp/s):</strong> <span id="speedVal">0</span>
                <strong>Zadany Kat:</strong> <span id="targetAngleVal">0.0 &deg;</span>
                <strong>Zadana Predkosc:</strong> <span id="speedSetpointVal">0</span>
                <strong>LQR Wyjscie:</strong> <span id="lqrOutputVal">0</span>
                <strong>Enkoder L:</strong> <span id="encoderLeftVal">0</span>
                <strong>Enkoder P:</strong> <span id="encoderRightVal">0</span>
            </div>

            <fieldset style="margin-top: 15px;">
                <legend>Rejestrator Danych (CSV)</legend>
                <div class="setting-container">
                    <label for="loggingTimeInput">Czas zbierania (s)</label>
                    <div class="numeric-input-wrapper">
                        <button id="loggingTimeMinus">-</button><input type="number" id="loggingTimeInput" min="1" max="30" step="1" value="5"><button id="loggingTimePlus">+</button>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button id="startLoggingBtn" style="flex:2;">Rozpocznij Zbieranie Danych</button>
                    <button id="cancelLoggingBtn" style="background-color: #ff6347; display:none; flex:1;">Anuluj</button>
                </div>
                <div id="loggingStatus" style="margin-top:8px; font-weight:bold; color:#61dafb;">Czekam na polecenie</div>
                <button id="downloadCsvBtn" style="width:100%; margin-top:10px; background-color:#a2f279;" disabled>Pobierz Plik CSV</button>
            </fieldset>
        </div>
        
        <div class="card">
             <button class="accordion-header" onclick="toggleAccordion(this)">Sterowanie Autonomiczne</button>
             <div class="accordion-content">
                <fieldset>
                    <legend>Sterowanie Precyzyjne (D-Pad)</legend>
                    <div class="dpad-input-group"><label for="dpadDistInput">Dystans (cm):</label><input type="number" id="dpadDistInput" value="20"></div>
                    <div class="dpad-input-group"><label for="dpadAngleInput">Kat (st.):</label><input type="number" id="dpadAngleInput" value="90"></div>
                    <div class="dpad-container">
                        <button id="dpad-up" class="dpad-btn" data-dpad="up">&#8593;</button>
                        <button id="dpad-left" class="dpad-btn" data-dpad="left">&#8592;</button>
                        <button id="dpad-stop" class="dpad-btn" data-dpad="stop">&#215;</button>
                        <button id="dpad-right" class="dpad-btn" data-dpad="right">&#8594;</button>
                        <button id="dpad-down" class="dpad-btn" data-dpad="down">&#8595;</button>
                    </div>
                     <div class="setting-container">
                        <label for="rotationPGainInput">Sila Obrotu<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button id="rotationPGainMinus">-</button><input type="number" class="config-value" id="rotationPGainInput" min="0.1" max="10" step="0.1" value="1.5"><button id="rotationPGainPlus">+</button></div>
                        <div class="help-text"><strong>Wplyw:</strong> Sila, z jaka robot wykonuje obrot do celu. Wieksza wartosc = szybszy obrot.</div>
                    </div>
                </fieldset>
                
                <fieldset style="margin-top: 15px;">
                    <legend>Kreator Sekwencji Ruchow</legend>
                    <div id="sequence-list"></div>
                    <button id="add-sequence-step-btn" style="width:100%; margin: 10px 0;">Dodaj Krok</button>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button id="run-sequence-btn" style="background-color: #a2f279;">Uruchom</button>
                        <button id="stop-sequence-btn" style="background-color: #ff6347;" disabled>Zatrzymaj</button>
                        <button id="clear-sequence-btn" style="background-color: #f7b731;">Wyczysc</button>
                    </div>
                </fieldset>

                <fieldset style="margin-top: 15px;">
                    <legend>Diagnostyka</legend>
                     <button id="calibrateMpuBtn" style="width:100%; background-color:#f7b731;">Kalibruj MPU (DMP)</button>
                </fieldset>
            </div>
        </div>
        
        <div class="card">
            <button class="accordion-header" onclick="toggleAccordion(this)">Wykres Telemetryczny</button>
            <div class="accordion-content">
                <div id="chart-wrapper"><canvas id="telemetryChart"></canvas></div>
                <div class="chart-controls" id="chartControls"></div>
            </div>
        </div>

        <div class="card">
            <h2>Konfiguracja</h2>
            <fieldset>
                <legend>Profile Ustawien LQR</legend>
                <div class="profile-controls">
                    <select id="lqrPresetSelect" style="width: 100%; padding: 5px;"></select>
                </div>
                 <div class="preset-actions">
                    <button id="applySelectedPresetBtn">Zastosuj Wybrany Preset</button>
                    <button id="saveCurrentAsPresetBtn">Zapisz Aktualne jako Nowy Preset</button>
                </div>
            </fieldset>
            
            <div id="allSettings">
                <button class="accordion-header" onclick="toggleAccordion(this)">0. Parametry Fizyczne Modelu</button>
                <div class="accordion-content">
                    <div class="setting-container"><label title="Masa korpusu, masztu i elektroniki">Masa korpusu (kg)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="mBodyInput" step="0.001" value="0.160"></div></div>
                    <div class="setting-container"><label title="Masa jednego koła razem z silnikiem">Masa koła (kg)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="mWheelInput" step="0.001" value="0.040"></div></div>
                    <div class="setting-container"><label title="Pionowa odległość od osi kół do środka ciężkości korpusu">Odl. osi do CoM (m)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="lInput" step="0.001" value="0.102"></div></div>
                    <div class="setting-container"><label title="Promień koła (połowa średnicy)">Promień koła (m)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="rWheelInput" step="0.001" value="0.041"></div></div>
                    <hr style="border-color: #4a4f58; margin: 10px 0;">
                    <div class="setting-container"><label title="Obliczony moment bezwładności korpusu">I_body (kg·m²)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="iBodyInput" step="0.000001" value="0.001832"></div></div>
                    <div class="setting-container"><label title="Obliczony moment bezwładności koła">I_wheel (kg·m²)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="iWheelInput" step="0.000001" value="0.000034"></div></div>
                    <hr style="border-color: #4a4f58; margin: 10px 0;">
                    <div class="setting-container"><label title="Zmierzona lub z noty katalogowej rezystancja silnika">Rezystancja (Ω)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="motorResistanceInput" step="0.01" value="3.75"></div></div>
                    <div class="setting-container"><label title="Stała momentu obrotowego silnika">Kt (Nm/A)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="motorKtInput" step="0.0001" value="0.0858"></div></div>
                    <div class="setting-container"><label title="Stała prędkości (siły przeciwelektromotorycznej) silnika">Kv (rad/s/V)</label><div class="numeric-input-wrapper"><input type="number" class="phys-param" id="motorKvInput" step="0.01" value="9.25"></div></div>
                    <button id="updatePhysicalParamsBtn" style="width:100%; margin-top:15px; background-color: #a2f279;">Aktualizuj Model Fizyczny Robota</button>
                </div>
                
                <button class="accordion-header" onclick="toggleAccordion(this)">1. Wagi LQR (Strojenie Niestandardowe)</button>
                <div class="accordion-content">
                    <div class="setting-container">
                        <label for="q1AngleInput">Q1 - Kara za Kat<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button id="q1AngleMinus">-</button><input type="number" class="lqr-input config-value" id="q1AngleInput" min="0" max="1000" step="5" value="100"><button id="q1AnglePlus">+</button></div>
                        <div class="help-text"><strong>Wplyw:</strong> Sztywnosc utrzymania pionu. <strong>Wiecej:</strong> Robot bardziej agresywnie walczy o utrzymanie pionu. <strong>Mniej:</strong> Robot jest bardziej 'miekki', pozwala na wieksze wychylenia.</div>
                    </div>
                    <div class="setting-container">
                        <label for="q2AngularVelInput">Q2 - Kara za Pred. Katowa<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button id="q2AngularVelMinus">-</button><input type="number" class="lqr-input config-value" id="q2AngularVelInput" min="0" max="100" step="1" value="10"><button id="q2AngularVelPlus">+</button></div>
                        <div class="help-text"><strong>Wplyw:</strong> Tlumienie drgan i oscylacji. <strong>Wiecej:</strong> Mocniej hamuje szybkie zmiany kata, uspokaja robota. <strong>Mniej:</strong> Reakcje sa szybsze, ale moze wibrowac.</div>
                    </div>
                    <div class="setting-container">
                        <label for="q3PositionInput">Q3 - Kara za Pozycje<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button id="q3PositionMinus">-</button><input type="number" class="lqr-input config-value" id="q3PositionInput" min="0" max="1000" step="10" value="1"><button id="q3PositionPlus">+</button></div>
                        <div class="help-text"><strong>Wplyw:</strong> Jak wazne jest dla LQR trzymanie pozycji (uzywane przez regulator kaskadowy).</div>
                    </div>
                    <div class="setting-container">
                        <label for="q4VelocityInput">Q4 - Kara za Predkosc<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button id="q4VelocityMinus">-</button><input type="number" class="lqr-input config-value" id="q4VelocityInput" min="0" max="100" step="1" value="5"><button id="q4VelocityPlus">+</button></div>
                        <div class="help-text"><strong>Wplyw:</strong> Jak wazne jest dla LQR trzymanie zerowej predkosci.</div>
                    </div>
                    <div class="setting-container">
                        <label for="rControlInput">R - Kara za Sterowanie<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button id="rControlMinus">-</button><input type="number" class="lqr-input config-value" id="rControlInput" min="0.001" max="10" step="0.01" value="0.1"><button id="rControlPlus">+</button></div>
                        <div class="help-text"><strong>Wplyw:</strong> Oszczednosc energii. <strong>Wiecej:</strong> Robot uzywa mniej mocy. <strong>Mniej:</strong> Robot uzywa pelnej dostepnej mocy.</div>
                    </div>
                    <div class="setting-container">
                        <label for="lqrOutputScalarInput">Skala Wyjscia LQR</label>
                        <div class="numeric-input-wrapper"><button id="lqrOutputScalarMinus">-</button><input type="number" class="config-value" id="lqrOutputScalarInput" min="0.1" max="50.0" step="0.1" value="20.0"><button id="lqrOutputScalarPlus">+</button></div>
                    </div>
                </div>
                
                <button class="accordion-header" onclick="toggleAccordion(this)">2. Strojenie Kaskadowe (Pozycja/Predkosc)</button>
                <div class="accordion-content">
                    <div class="setting-container">
                        <label for="positionErrorGainInput">Sila Powrotu (P Pozycji)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper">
                            <button id="positionErrorGainMinus">-</button>
                            <input type="number" class="config-value" id="positionErrorGainInput" min="0" max="10" step="0.1" value="2.5">
                            <button id="positionErrorGainPlus">+</button>
                        </div>
                        <div class="help-text"><strong>Wplyw:</strong> Sila, z jaka robot wraca do celu. Wieksza wartosc = szybszy, bardziej agresywny ruch.</div>
                    </div>
                    <div class="setting-container">
                        <label for="positionDampingGainInput">Sila Hamowania (D Pozycji)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper">
                            <button id="positionDampingGainMinus">-</button>
                            <input type="number" class="config-value" id="positionDampingGainInput" min="0" max="15" step="0.1" value="0.5">
                            <button id="positionDampingGainPlus">+</button>
                        </div>
                        <div class="help-text"><strong>Wplyw:</strong> Tlumienie ruchu. Wieksza wartosc = robot mocniej hamuje, zblizajac sie do celu.</div>
                    </div>
                    <hr style="border-color: #4a4f58; margin: 10px 0;">
                    <div class="setting-container">
                        <label for="speedPGainInput">Sila Reakcji na Predkosc (P)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper">
                            <button id="speedPGainMinus">-</button>
                            <input type="number" class="config-value" id="speedPGainInput" min="0" max="0.1" step="0.001" value="0.005">
                            <button id="speedPGainPlus">+</button>
                        </div>
                        <div class="help-text"><strong>Wplyw:</strong> Jak bardzo robot ma sie pochylac, aby skorygowac blad predkosci. Kluczowy parametr do plynnej jazdy.</div>
                    </div>
                    <hr style="border-color: #4a4f58; margin: 10px 0;">
                    <div class="setting-container">
                        <label for="maxSpeedFromPosInput">Max. Predkosc z Pozycji (imp/s)</label>
                        <div class="numeric-input-wrapper"><button id="maxSpeedFromPosMinus">-</button><input type="number" class="config-value" id="maxSpeedFromPosInput" min="100" max="4000" step="50" value="1000"><button id="maxSpeedFromPosPlus">+</button></div>
                    </div>
                     <div class="setting-container">
                        <label for="holdPositionMarginPulsesInput">Margines Bledu Pozycji (impulsy)</label>
                        <div class="numeric-input-wrapper"><button id="holdPositionMarginPulsesMinus">-</button><input type="number" class="config-value" id="holdPositionMarginPulsesInput" min="0" max="100" step="1" value="15"><button id="holdPositionMarginPulsesPlus">+</button></div>
                    </div>
                     <div class="setting-container">
                        <label for="headingCorrectionFactorInput">Sila Korekty Kursu</label>
                        <div class="numeric-input-wrapper"><button id="headingCorrectionFactorMinus">-</button><input type="number" class="config-value" id="headingCorrectionFactorInput" min="0" max="5" step="0.05" value="0.4"><button id="headingCorrectionFactorPlus">+</button></div>
                    </div>
                    <div class="setting-container">
                        <label for="rollCorrectionGainInput">Korekta Przechylu (Roll)</label>
                        <div class="numeric-input-wrapper"><button id="rollCorrectionGainMinus">-</button><input type="number" class="config-value" id="rollCorrectionGainInput" min="0" max="5" step="0.05" value="0.5"><button id="rollCorrectionGainPlus">+</button></div>
                    </div>
                </div>
                
                <button class="accordion-header" onclick="toggleAccordion(this)">3. Parametry Sprzetowe</button>
                <div class="accordion-content">
                    <div class="parameter-group">
                        <h5>Kalibracja Mechaniczna</h5>
                        <div class="setting-container">
                            <label for="wheelDiameterCmInput">Srednica kola (cm)</label>
                            <div class="numeric-input-wrapper"><button id="wheelDiameterCmMinus">-</button><input type="number" class="config-value" id="wheelDiameterCmInput" min="3" max="30" step="0.1" value="8.2"><button id="wheelDiameterCmPlus">+</button></div>
                        </div>
                        <div class="setting-container">
                            <label for="trackWidthCmInput">Rozstaw kol (cm)</label>
                            <div class="numeric-input-wrapper"><button id="trackWidthCmMinus">-</button><input type="number" class="config-value" id="trackWidthCmInput" min="5" max="50" step="0.1" value="12.0"><button id="trackWidthCmPlus">+</button></div>
                        </div>
                        <div class="setting-container">
                            <label for="encoderPprInput">Impulsy na obrot (PPR)</label>
                            <div class="numeric-input-wrapper"><button id="encoderPprMinus">-</button><input type="number" class="config-value" id="encoderPprInput" min="100" max="5000" step="10" value="820"><button id="encoderPprPlus">+</button></div>
                        </div>
                    </div>
                </div>

                <button class="accordion-header" onclick="toggleAccordion(this)">4. Kalibracja PWM Silnikow</button>
                <div class="accordion-content">
                    <div class="pwm-info">
                        <strong>Info:</strong> Użyj przycisku <strong>"Auto"</strong>, aby automatycznie znaleźć próg startowy silnika, lub <strong>"Testuj"</strong>, aby sprawdzić ręcznie wpisaną wartość.
                        <strong>Ważne:</strong> Przed testem podnieś robota, aby koła mogły się swobodnie kręcić!
                    </div>
                    <div class="setting-container">
                        <label for="pwmTuneStartInput">Rozpocznij auto-szukanie od PWM</label>
                        <div class="numeric-input-wrapper">
                            <button id="pwmTuneStartMinus">-</button>
                            <input type="number" id="pwmTuneStartInput" min="1" max="800" step="10" value="400">
                            <button id="pwmTuneStartPlus">+</button>
                        </div>
                    </div>
                    <hr style="border-color: #4a4f58; margin: 15px 0;">
                    
                    <div class="manual-tune-row" data-motor="left" data-direction="fwd">
                        <div class="pwm-input-row">
                            <label>Lewy (Przod)</label>
                            <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmLeftFwdInput" min="0" max="1023" step="1" value="632"><button class="tune-plus">+</button></div>
                        </div>
                        <div class="pwm-button-row">
                            <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button>
                        </div>
                    </div>
                    <div class="manual-tune-row" data-motor="left" data-direction="bwd">
                         <div class="pwm-input-row">
                            <label>Lewy (Tyl)</label>
                            <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmLeftBwdInput" min="0" max="1023" step="1" value="634"><button class="tune-plus">+</button></div>
                        </div>
                        <div class="pwm-button-row">
                            <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button>
                        </div>
                    </div>
                    <div class="manual-tune-row" data-motor="right" data-direction="fwd">
                        <div class="pwm-input-row">
                            <label>Prawy (Przod)</label>
                            <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmRightFwdInput" min="0" max="1023" step="1" value="626"><button class="tune-plus">+</button></div>
                        </div>
                        <div class="pwm-button-row">
                           <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button>
                        </div>
                    </div>
                    <div class="manual-tune-row" data-motor="right" data-direction="bwd">
                        <div class="pwm-input-row">
                            <label>Prawy (Tyl)</label>
                            <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmRightBwdInput" min="0" max="1023" step="1" value="621"><button class="tune-plus">+</button></div>
                        </div>
                        <div class="pwm-button-row">
                           <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button>
                        </div>
                    </div>

                    <button id="manualTuneStopAll" style="width:100%; margin-top:15px; background-color:#ff6347;">ZATRZYMAJ WSZYSTKIE SILNIKI</button>
                </div>
            </div>
            
            <div class="button-group" style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button id="loadBtn">Wczytaj z Robota</button>
                <button id="saveBtn">Zapisz na Robocie</button>
            </div>
        </div>
        
        <div class="card">
             <button class="accordion-header" onclick="toggleAccordion(this)">Automatyczne Strojenie (Optymalizacja Bayesowska)</button>
             <div class="accordion-content">
                <fieldset>
                    <legend>Ustawienia Optymalizacji</legend>
                    <div class="setting-container"><label>Tryb:</label>
                        <div style="display:flex; gap: 5px;">
                            <button id="boptModeBalance" style="background-color:#a2f279; flex:1;">Strojenie Balansu</button>
                            <button id="boptModeDrive" style="flex:1;">Strojenie Jazdy</button>
                        </div>
                    </div>
                    <div class="setting-container"><label for="boptIterationsInput">Liczba Iteracji</label><input type="number" id="boptIterationsInput" value="20" min="5" max="100"></div>
                    
                    <div id="boptBalanceSettings" style="display:block;">
                        <div class="setting-container"><label for="boptImpulsePowerInput">Sila Impulsu</label><div class="numeric-input-wrapper"><button id="boptImpulsePowerMinus">-</button><input type="number" id="boptImpulsePowerInput" min="50" max="250" step="10" value="120"><button id="boptImpulsePowerPlus">+</button></div></div>
                        <div class="setting-container"><label for="boptUseImpulseTest">Test z impulsem<span class="help-icon">?</span></label><label class="switch"><input type="checkbox" id="boptUseImpulseTest" checked><span class="slider round"></span></label>
                            <div class="help-text">Wlacz, aby testowac odpornosc na zaklocenia (strojenie dynamiczne). Wylacz, aby testowac tylko balans w miejscu (strojenie statyczne).</div>
                        </div>
                        <hr style="border-color: #4a4f58; margin: 15px 0;">
                        <div style="background-color: #2a2f35; padding: 10px; border-radius: 6px;">
                            <label>Zarzadzanie baza dla testu statycznego</label>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                                <button id="boptSaveSafeBaseBtn" style="background-color: #61dafb; color: #282c34;">Zapisz Aktualne jako Baza</button>
                                <button id="boptRestoreSafeBaseBtn" style="background-color: #f7b731;">Przywroc Baze</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="boptDriveSettings" style="display:none;">
                         <div class="setting-container"><label for="boptDriveDistanceInput">Dystans testowy (cm)</label><input type="number" id="boptDriveDistanceInput" value="50" min="10" max="200"></div>
                    </div>

                </fieldset>
                <div style="display:flex; gap:10px; justify-content:center; margin: 15px 0;">
                    <button id="startBoptBtn" style="background-color: #a2f279;">START</button>
                    <button id="stopBoptBtn" style="background-color: #ff6347;" disabled>ZATRZYMAJ</button>
                    <button id="boptRunTestBtn" style="background-color: #f7b731;" disabled>Uruchom Test</button>
                </div>
                 <fieldset>
                    <legend>Postep</legend>
                    <div id="bopt-progress-bar-container"><div id="bopt-progress-bar"></div></div>
                    <div class="bopt-status-grid">
                        <strong>Iteracja:</strong> <span id="boptIterationStatus">-- / --</span>
                        <strong>Najlepszy Fitness:</strong> <span id="boptBestFitnessStatus">-.----</span>
                    </div>
                    <h5 style="color:#61dafb; margin: 10px 0 5px 0;">Proponowane Parametry do Testu:</h5>
                    <div id="bopt-current-params-display">Czekam na rozpoczecie...</div>
                    <hr style="border-color: #4a4f58; margin: 15px 0;">
                    <h5 style="color:#61dafb; margin: 10px 0 5px 0;">Najlepsze Znalezione Parametry:</h5>
                    <div id="bopt-best-params-display">Najlepsze parametry pojawia sie tutaj...</div>
                    <button id="boptSavePresetBtn" style="width:100%; margin-top:10px; background-color:#61dafb;" disabled>Zapisz znalezione jako Preset</button>
                </fieldset>
            </div>
        </div>

        <div class="card" id="log-card">
            <button class="accordion-header active" onclick="toggleAccordion(this)">Logi Systemowe</button>
            <div class="accordion-content active">
                <div id="log-history"></div>
                <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button onclick="clearLogs()" style="background-color: #f7b731;">Wyczysc Logi</button>
                </div>
            </div>
        </div>
    </div>

<script>
        const debouncedSenders = {};
    let isMappingButton = false;
    let actionToMap = null;
    let lastBestBoptParams = null; 
    let loggedData = [];

    document.addEventListener('DOMContentLoaded', () => {
        initJoystick();
        setupChartControls();
        populatePresetSelect();
        setupNumericInputs();
        setupEventListeners();
        setupManualTuneButtons(); 
        setupSequenceControls();
        setupDpadControls();
        setupGamepadMappingModal();
        loadGamepadMappings();
        renderMappingModal();
        pollGamepad();
        window.addEventListener('resize', initJoystick);
        document.querySelectorAll('.accordion-header.active').forEach(header => {
            const content = header.nextElementSibling;
            if (content) { content.style.maxHeight = content.scrollHeight + "px"; }
        });
    });

    const CUSTOM_PRESET_PREFIX = 'lqr_custom_preset_v42.6_';
    let bleDevice, rxCharacteristic, txCharacteristic;
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const RX_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a9";
    const TX_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    let bleBuffer = '';
    
    let isBoptRunning = false;
    let bayesianOptimizer;
    let resolveTestResultPromise;
    let currentBoptParams = null;
    let boptIterationCounter = 0;
    let boptTotalIterations = 0;

    const joystickCanvas = document.getElementById('joystickCanvas');
    const joystickCtx = joystickCanvas.getContext('2d');
    let joystickCenter, joystickRadius, knobRadius, isDragging = false;
    let lastJoystickSendTime = 0;
    const JOYSTICK_SEND_INTERVAL = 50;
    let gamepadIndex = null;
    let lastGamepadState = [];
    let lastGamepadAxes = { x: 0, y: 0 };
    let gamepadMappings = {};
    const GAMEPAD_MAPPING_KEY = 'lqr_gamepad_mappings_v42';
    const GAMEPAD_AXIS_THRESHOLD = 0.15;
    
    let isSequenceRunning = false;
    let currentSequenceStep = 0;
    const MAX_SEQUENCE_STEPS = 10;
    let lastKnownRobotState = 'IDLE';

    const availableActions = {
        'toggle_balance': { label: 'Wlacz/Wylacz Balansowanie', elementId: 'balanceSwitch' },
        'toggle_hold_position': { label: 'Wlacz/Wylacz Trzymanie Pozycji', elementId: 'holdPositionSwitch' },
        'toggle_speed_mode': { label: 'Wlacz/Wylacz Tryb Predkosci', elementId: 'speedModeSwitch' },
        'emergency_stop': { label: 'STOP AWARYJNY', elementId: 'emergencyStopBtn' },
        'reset_zero': { label: 'Resetuj Osie (Pion)', elementId: 'resetZeroBtn' },
        'trim_plus': { label: 'Korekta Pionu (+)', elementId: 'trimPlusBtn' },
        'trim_minus': { label: 'Korekta Pionu (-)', elementId: 'trimMinusBtn' },
        'bopt_run_test': { label: 'Uruchom Test BOPT', elementId: 'boptRunTestBtn' }
    };
    
    const availableTelemetry = {
        'pitch': { label: 'Pitch (Kat)', color: '#61dafb' },
        'target_angle': { label: 'Zadany Kat', color: '#a2f279' },
        'speed': { label: 'Predkosc', color: '#f7b731' },
        'speed_setpoint': { label: 'Zadana Predkosc', color: '#ff6347' },
        'lqr_output': { label: 'LQR Wyjscie', color: '#ff9ff3' },
    };

    const builtInPresetsData = {
        '1': { name: "1. Agresywny / Sztywny", params: { q1Angle: 450, q2AngularVel: 20, q3Position: 1, q4Velocity: 1, rControl: 0.01, lqrOutputScalar: 25.0 }},
        '2': { name: "2. Zbalansowany (Startowy)", params: { q1Angle: 100, q2AngularVel: 10, q3Position: 1, q4Velocity: 5, rControl: 0.1, lqrOutputScalar: 20.0 }},
        '3': { name: "3. Plynny / Miekki", params: { q1Angle: 50, q2AngularVel: 5, q3Position: 2, q4Velocity: 10, rControl: 0.5, lqrOutputScalar: 18.0 }},
    };

    function initJoystick() { const wrapper = document.getElementById('joystickWrapper'); const size = wrapper.clientWidth; joystickCanvas.width = size; joystickCanvas.height = size; joystickCenter = { x: size / 2, y: size / 2 }; joystickRadius = size / 2 * 0.75; knobRadius = size / 2 * 0.25; drawJoystick(joystickCenter.x, joystickCenter.y); }
    function drawJoystick(x, y) { joystickCtx.clearRect(0, 0, joystickCanvas.width, joystickCanvas.height); joystickCtx.beginPath(); joystickCtx.arc(joystickCenter.x, joystickCenter.y, joystickRadius, 0, 2 * Math.PI); joystickCtx.fillStyle = 'rgba(255, 255, 255, 0.1)'; joystickCtx.fill(); joystickCtx.beginPath(); joystickCtx.arc(x, y, knobRadius, 0, 2 * Math.PI); joystickCtx.fillStyle = '#61dafb'; joystickCtx.fill(); }
    function getJoystickPosition(event) { const rect = joystickCanvas.getBoundingClientRect(); const touch = event.touches ? event.touches[0] : event; return { x: touch.clientX - rect.left, y: touch.clientY - rect.top }; }
    function handleJoystickStart(event) { event.preventDefault(); isDragging = true; }
    function handleJoystickMove(event) { if (!isDragging) return; event.preventDefault(); let { x, y } = getJoystickPosition(event); const dx = x - joystickCenter.x; const dy = y - joystickCenter.y; const distance = Math.sqrt(dx * dx + dy * dy); if (distance > joystickRadius) { x = joystickCenter.x + (dx / distance) * joystickRadius; y = joystickCenter.y + (dy / distance) * joystickRadius; } drawJoystick(x, y); const now = Date.now(); if (now - lastJoystickSendTime > JOYSTICK_SEND_INTERVAL) { const joyX = (x - joystickCenter.x) / joystickRadius; const joyY = -(y - joystickCenter.y) / joystickRadius; sendBleMessage({ type: 'joystick', x: joyX, y: joyY }); lastJoystickSendTime = now; } }
    function handleJoystickEnd(event) { if (!isDragging) return; event.preventDefault(); isDragging = false; drawJoystick(joystickCenter.x, joystickCenter.y); sendBleMessage({ type: 'joystick', x: 0, y: 0 }); }
    function pollGamepad() { if (gamepadIndex !== null) { const gp = navigator.getGamepads()[gamepadIndex]; if (gp) { if (isMappingButton && actionToMap) { gp.buttons.forEach((button, i) => { if (button.pressed && !lastGamepadState[i]) { Object.keys(gamepadMappings).forEach(key => { if (gamepadMappings[key] === actionToMap) delete gamepadMappings[key]; }); gamepadMappings[i] = actionToMap; saveGamepadMappings(); addLogMessage(`[UI] Akcja '${availableActions[actionToMap].label}' przypisana do przycisku ${i}.`, 'success'); isMappingButton = false; actionToMap = null; renderMappingModal(); } }); } else { gp.buttons.forEach((button, i) => { if (button.pressed && !lastGamepadState[i]) { const action = gamepadMappings[i]; if (action && availableActions[action]) { const element = document.getElementById(availableActions[action].elementId); if (element && !element.disabled) { element.click(); flashElement(element); } } } }); } lastGamepadState = gp.buttons.map(b => b.pressed); let x = gp.axes[0]; let y = gp.axes[1]; if (Math.abs(x) < GAMEPAD_AXIS_THRESHOLD) x = 0; if (Math.abs(y) < GAMEPAD_AXIS_THRESHOLD) y = 0; if (x !== lastGamepadAxes.x || y !== lastGamepadAxes.y) { sendBleMessage({ type: 'joystick', x: x, y: -y }); lastGamepadAxes = { x, y }; } } } requestAnimationFrame(pollGamepad); }
    window.addEventListener('gamepadconnected', (e) => { gamepadIndex = e.gamepad.index; document.getElementById('gamepadStatus').textContent = 'Polaczony'; document.getElementById('gamepadStatus').style.color = '#a2f279'; addLogMessage(`[UI] Gamepad polaczony: ${e.gamepad.id}`, 'success'); });
    window.addEventListener('gamepaddisconnected', (e) => { gamepadIndex = null; document.getElementById('gamepadStatus').textContent = 'Brak'; document.getElementById('gamepadStatus').style.color = '#f7b731'; addLogMessage('[UI] Gamepad rozlaczony.', 'warn'); });
    function startMapping(action, buttonElement) { if (gamepadIndex === null) { addLogMessage("Podlacz gamepada, aby rozpoczac mapowanie!", "warn"); return; } isMappingButton = true; actionToMap = action; document.querySelectorAll('.mapping-button').forEach(btn => btn.textContent = "Przypisz"); buttonElement.textContent = "Czekam..."; addLogMessage(`[UI] Nasluchiwanie na przycisk dla akcji: ${availableActions[action].label}...`, "info"); }
    function renderMappingModal() { const list = document.getElementById('gamepad-mapping-list'); list.innerHTML = ''; for (const [action, config] of Object.entries(availableActions)) { const row = document.createElement('div'); row.className = 'mapping-row'; const buttonIndex = Object.keys(gamepadMappings).find(key => gamepadMappings[key] === action); row.innerHTML = `<span class="mapping-label">${config.label}</span><span class="mapping-display">${buttonIndex !== undefined ? `Przycisk ${buttonIndex}` : 'Brak'}</span><button class="mapping-button" data-action="${action}">Przypisz</button>`; list.appendChild(row); } list.querySelectorAll('.mapping-button').forEach(button => { button.addEventListener('click', (e) => { const action = e.target.dataset.action; startMapping(action, e.target); }); }); }
    const debounce = (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; };
    function addLogMessage(message, level = 'info') { const logHistory = document.getElementById('log-history'); if (!logHistory) return; const timestamp = new Date().toLocaleTimeString(); let color = '#fff'; if (level === 'error') color = '#ff6347'; else if (level === 'warn') color = '#f7b731'; else if (level === 'success') color = '#a2f279'; const logEntry = document.createElement('div'); logEntry.style.color = color; logEntry.textContent = `[${timestamp}] ${message}`; logHistory.prepend(logEntry); while (logHistory.children.length > 200) { logHistory.removeChild(logHistory.lastChild); } }
    function clearLogs() { document.getElementById('log-history').innerHTML = ''; }
    function toggleAccordion(header) { const content = header.nextElementSibling; header.classList.toggle('active'); if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = '0px'; } else { content.style.maxHeight = content.scrollHeight + "px"; } }
    function updateAccordionHeight(content) { if (content && content.style.maxHeight !== '0px') { content.style.maxHeight = content.scrollHeight + 'px'; } }
    async function connectBLE() { addLogMessage('[UI] Prosze o wybranie urzadzenia Bluetooth...', 'info'); try { bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }], optionalServices: [SERVICE_UUID] }); addLogMessage(`[UI] Laczenie z ${bleDevice.name}...`, 'info'); document.getElementById('connectBleBtn').disabled = true; document.getElementById('connectionText').textContent = 'Laczenie...'; bleDevice.addEventListener('gattserverdisconnected', onDisconnected); const server = await bleDevice.gatt.connect(); const service = await server.getPrimaryService(SERVICE_UUID); rxCharacteristic = await service.getCharacteristic(RX_UUID); txCharacteristic = await service.getCharacteristic(TX_UUID); await txCharacteristic.startNotifications(); txCharacteristic.addEventListener('characteristicvaluechanged', handleBleNotification); document.getElementById('connectionStatus').className = 'status-indicator status-ok'; document.getElementById('connectionText').textContent = 'Polaczony'; addLogMessage('[UI] Polaczono! Automatyczna synchronizacja za 1s...', 'success'); setTimeout(() => sendBleMessage({ type: 'load_from_eeprom' }), 1000); } catch (error) { addLogMessage(`[UI] Blad polaczenia BLE: ${error}`, 'error'); document.getElementById('connectionStatus').className = 'status-indicator status-error'; document.getElementById('connectionText').textContent = 'Blad polaczenia'; document.getElementById('connectBleBtn').disabled = false; } }
    function onDisconnected() { addLogMessage('[UI] Rozlaczono z robotem.', 'warn'); document.getElementById('connectionStatus').className = 'status-indicator status-disconnected'; document.getElementById('connectionText').textContent = 'Rozlaczony'; ['balanceSwitch', 'holdPositionSwitch', 'speedModeSwitch'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = false; }); document.getElementById('connectBleBtn').disabled = false; rxCharacteristic = null; txCharacteristic = null; if (isBoptRunning) stopBOPT(false); }
    function handleBleNotification(event) { const value = event.target.value; const decoder = new TextDecoder('utf-8'); const chunk = decoder.decode(value); bleBuffer += chunk; let newlineIndex; while ((newlineIndex = bleBuffer.indexOf('\n')) !== -1) { const line = bleBuffer.substring(0, newlineIndex).trim(); bleBuffer = bleBuffer.substring(newlineIndex + 1); if (line) { try { const data = JSON.parse(line); processCompleteMessage(data); } catch (e) { addLogMessage(`[UI] Blad parsowania JSON: ${e}. Dane: ${line}`, 'error'); } } } }
    async function sendBleMessage(message) { if (!rxCharacteristic) { return; } try { const encoder = new TextEncoder(); await rxCharacteristic.writeValueWithoutResponse(encoder.encode(JSON.stringify(message) + '\n')); } catch (error) { addLogMessage(`[UI] Blad wysylania danych BLE: ${error}`, 'error'); } }
    
    function processCompleteMessage(data) {
        let previousRobotState = lastKnownRobotState;
        if (data.type === 'telemetry' && data.robot_state) {
            lastKnownRobotState = data.robot_state;
        }

        switch (data.type) {
            case 'telemetry':
                updateTelemetryUI(data);
                updateChart(data);
                checkAndExecuteNextSequenceStep(previousRobotState);
                break;
            case 'full_config':
                applyFullConfig(data.params);
                break;
            case 'log':
                addLogMessage(`[ROBOT] ${data.message}`, data.level);
                break;
            case 'logging_data_point':
                if (loggedData) loggedData.push(data.d);
                break;
            case 'logging_finished':
                handleLoggingFinished(data.points_collected);
                break;
            case 'ga_result':
                if (resolveTestResultPromise) { resolveTestResultPromise(data.fitness); }
                break;
            case 'drive_test_result':
                if (resolveTestResultPromise) { resolveTestResultPromise(data.fitness); }
                break;
            case 'single_pwm_result':
                const p = data.params;
                const inputId = `minPwm${p.motor.charAt(0).toUpperCase() + p.motor.slice(1)}${p.direction.charAt(0).toUpperCase() + p.direction.slice(1)}Input`;
                const inputField = document.getElementById(inputId);
                if (inputField) {
                    const tuneRow = inputField.closest('.manual-tune-row');
                    inputField.value = p.value;
                    addLogMessage(`[UI] Auto-strojenie dla ${p.motor} ${p.direction} zakonczone. Wynik: ${p.value}`, 'success');
                    debouncedSenders['set_min_pwm']();
                    if(tuneRow){
                        const autoBtn = tuneRow.querySelector('.auto-btn');
                        autoBtn.disabled = false;
                        autoBtn.textContent = 'Auto';
                    }
                }
                break;
        }
    }
    
    function applyFullConfig(params) {
        const parameterMapping = {
            'q1_angle': 'q1AngleInput', 'q2_angular_vel': 'q2AngularVelInput', 'q3_position': 'q3PositionInput', 'q4_velocity': 'q4VelocityInput', 'r_control': 'rControlInput', 'lqr_output_scalar': 'lqrOutputScalarInput',
            'expo_joystick': 'expoJoystickInput', 'max_speed_joystick': 'maxSpeedJoystickInput', 'turn_factor': 'turnFactorInput', 'joystick_output_scale': 'joystickOutputScaleInput', 'joystick_angle_sensitivity': 'joystickAngleSensitivityInput',
            'position_error_gain': 'positionErrorGainInput', 'position_d_gain': 'positionDampingGainInput', 'speed_p_gain': 'speedPGainInput', 'max_speed_from_pos': 'maxSpeedFromPosInput',
            'hold_position_margin_pulses': 'holdPositionMarginPulsesInput', 'heading_correction_factor': 'headingCorrectionFactorInput', 'rotation_p_gain': 'rotationPGainInput', 'roll_correction_gain': 'rollCorrectionGainInput',
            'wheel_diameter_cm': 'wheelDiameterCmInput', 'track_width_cm': 'trackWidthCmInput', 'encoder_ppr': 'encoderPprInput',
            'min_pwm_left_fwd': 'minPwmLeftFwdInput', 'min_pwm_left_bwd': 'minPwmLeftBwdInput', 'min_pwm_right_fwd': 'minPwmRightFwdInput', 'min_pwm_right_bwd': 'minPwmRightBwdInput', 'global_power_limit': 'globalPowerLimitInput'
        };
        for(const [key_snake, inputId] of Object.entries(parameterMapping)){
            if(params[key_snake] !== undefined){
                const input = document.getElementById(inputId);
                if(input){
                    let value = params[key_snake];
                    if (key_snake === 'turn_factor' || key_snake === 'joystick_output_scale' || key_snake === 'expo_joystick') value *= 100;
                    if (key_snake === 'global_power_limit') value = Math.round(value * 100 / 1023);
                    input.value = value;
                }
            }
        }
        addLogMessage("[UI] Parametry robota zsynchronizowane z panelem.", "info");
    }
    function updateTelemetryUI(data) { if (data.robot_state !== undefined) document.getElementById('robotStateVal').textContent = data.robot_state; if (data.pitch !== undefined) { document.getElementById('angleVal').textContent = data.pitch.toFixed(1) + ' \u00B0'; document.getElementById('angleIndicator').style.transform = `rotate(${data.pitch}deg)`; } if (data.speed !== undefined) document.getElementById('speedVal').textContent = parseFloat(data.speed).toFixed(0); if (data.speed_setpoint !== undefined) document.getElementById('speedSetpointVal').textContent = parseFloat(data.speed_setpoint).toFixed(0); if (data.target_angle !== undefined) document.getElementById('targetAngleVal').textContent = parseFloat(data.target_angle).toFixed(1) + ' \u00B0'; if (data.lqr_output !== undefined) document.getElementById('lqrOutputVal').textContent = parseFloat(data.lqr_output).toFixed(2); if (data.encoder_left !== undefined) document.getElementById('encoderLeftVal').textContent = data.encoder_left; if (data.encoder_right !== undefined) document.getElementById('encoderRightVal').textContent = data.encoder_right; const emergencyBanner = document.getElementById('emergency-banner'); if (emergencyBanner) emergencyBanner.style.display = data.emergency_stop ? 'block' : 'none'; }
    
    function updateBoptProgress(iteration, total, bestFitness = null, bestParams = null) {
        document.getElementById('bopt-progress-bar').style.width = `${(iteration / total) * 100}%`;
        document.getElementById('boptIterationStatus').textContent = `${iteration} / ${total}`;
        if (bestFitness && bestParams) {
            lastBestBoptParams = bestParams;
            document.getElementById('boptSavePresetBtn').disabled = false;
            document.getElementById('boptBestFitnessStatus').textContent = bestFitness.toFixed(4);
            let paramsText = '';
            const isBalanceMode = document.getElementById('boptBalanceSettings').style.display === 'block';
            if (isBalanceMode) {
                 paramsText = ` q1: ${bestParams.q1_angle.toFixed(1)}\n q2: ${bestParams.q2_angular_vel.toFixed(1)}\n  r: ${bestParams.r_control.toFixed(3)}\n sc: ${bestParams.lqr_output_scalar.toFixed(1)}`;
                if(bestParams.q3_position !== undefined) paramsText += `\n q3: ${bestParams.q3_position.toFixed(1)}`;
                if(bestParams.q4_velocity !== undefined) paramsText += `\n q4: ${bestParams.q4_velocity.toFixed(1)}`;
            } else {
                 paramsText = ` pos_p: ${bestParams.position_error_gain.toFixed(3)}\n pos_d: ${bestParams.position_d_gain.toFixed(3)}\n spd_p: ${bestParams.speed_p_gain.toFixed(4)}`;
            }
            document.getElementById('bopt-best-params-display').textContent = paramsText;
        }
    }

    const telemetryChart = new Chart(document.getElementById('telemetryChart'), { type: 'line', data: { labels: Array(100).fill(''), datasets: [] }, options: { animation: false, responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { type: 'linear', display: true, position: 'left', ticks: { color: '#61dafb' }, title: { display: true, text: 'Wartosc', color: '#61dafb' } }, y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#a2f279' }, title: { display: true, text: 'Sila / Wyjscie', color: '#a2f279' }, grid: { drawOnChartArea: false }, } }, plugins: { legend: { labels: { color: '#fff' } } } } });
    function updateChart(data) { const chartData = telemetryChart.data; if (chartData.labels.length >= 100) chartData.labels.shift(); chartData.labels.push(''); for (const [key, value] of Object.entries(data)) { if (availableTelemetry[key] && value !== undefined) { let dataset = chartData.datasets.find(ds => ds.label === availableTelemetry[key].label); if (!dataset) continue; if (dataset.data.length >= 100) dataset.data.shift(); dataset.data.push(value); } } chartData.datasets.forEach(ds => { if (ds.data.length < chartData.labels.length) { if (ds.data.length >= 100) ds.data.shift(); ds.data.push(null); } }); telemetryChart.update('none'); }
    function setupChartControls() { const container = document.getElementById('chartControls'); container.innerHTML = ''; Object.keys(availableTelemetry).forEach((key) => { const label = document.createElement('label'), checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = key; checkbox.checked = (key === 'pitch' || key === 'target_angle'); checkbox.addEventListener('change', (e) => { const varName = e.target.value; if (e.target.checked) { const chartData = telemetryChart.data; if (!chartData.datasets.find(ds => ds.label === availableTelemetry[varName].label)) { const axisId = (varName.includes('output') || varName.includes('out')) ? 'y1' : 'y'; chartData.datasets.push({ label: availableTelemetry[varName].label, data: Array(chartData.labels.length).fill(null), borderColor: availableTelemetry[varName].color, fill: false, tension: 0.1, pointRadius: 0, yAxisID: axisId }); } } else { const chartData = telemetryChart.data; const datasetIndex = chartData.datasets.findIndex(ds => ds.label === availableTelemetry[varName].label); if (datasetIndex > -1) { chartData.datasets.splice(datasetIndex, 1); } } telemetryChart.update(); }); label.appendChild(checkbox); label.append(` ${availableTelemetry[key].label}`); container.appendChild(label); if (checkbox.checked) { checkbox.dispatchEvent(new Event('change')); } }); }
    function populatePresetSelect() { const select = document.getElementById('lqrPresetSelect'); select.innerHTML = ''; for (const [index, preset] of Object.entries(builtInPresetsData)) { const option = document.createElement('option'); option.value = index; option.textContent = preset.name; select.appendChild(option); } for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith(CUSTOM_PRESET_PREFIX)) { const presetName = key.substring(CUSTOM_PRESET_PREFIX.length); const option = document.createElement('option'); option.value = key; option.textContent = `Wlasny: ${presetName}`; select.appendChild(option); } } }
    async function applySelectedPreset() { const select = document.getElementById('lqrPresetSelect'); const selectedValue = select.value; let presetData; if (selectedValue.startsWith(CUSTOM_PRESET_PREFIX)) { presetData = JSON.parse(localStorage.getItem(selectedValue)); if (presetData) addLogMessage(`[UI] Ladowanie wlasnego presetu '${selectedValue.substring(CUSTOM_PRESET_PREFIX.length)}'.`, 'info'); } else { presetData = builtInPresetsData[selectedValue]?.params; if (presetData) addLogMessage(`[UI] Ladowanie wbudowanego presetu '${builtInPresetsData[selectedValue].name}'.`, 'info'); } if (presetData) { for (const [key, value] of Object.entries(presetData)) { const input = document.getElementById(key + 'Input'); if (input) { input.value = value; input.dispatchEvent(new Event('change', { bubbles: true })); } } addLogMessage('[UI] Zastosowano i wyslano wartosci presetu do robota.', 'info'); } else { addLogMessage(`[UI] Blad: nie znaleziono danych dla presetu '${selectedValue}'.`, 'error'); } }
    function saveCurrentAsPreset() { const presetName = prompt("Podaj nazwe dla nowego presetu:", ""); if (presetName && presetName.trim() !== "") { const presetData = {}; const keysToSave = ['q1Angle', 'q2AngularVel', 'q3Position', 'q4Velocity', 'rControl', 'lqrOutputScalar']; keysToSave.forEach(key => { const input = document.getElementById(key + 'Input'); if (input) presetData[key] = parseFloat(input.value); }); localStorage.setItem(CUSTOM_PRESET_PREFIX + presetName.trim(), JSON.stringify(presetData)); addLogMessage(`[UI] Zapisano wlasny preset '${presetName.trim()}'.`, 'info'); populatePresetSelect(); } else { addLogMessage('[UI] Anulowano zapisywanie presetu.', 'warn'); } }
    function setupNumericInputs() { document.querySelectorAll('.numeric-input-wrapper').forEach(wrapper => { const container = wrapper.closest('.setting-container') || wrapper.closest('.pwm-input-row'); if (!container) return; const input = container.querySelector('input[type=number]'); const minusBtn = wrapper.querySelector('button:first-child'); const plusBtn = wrapper.querySelector('button:last-child'); if (!input || !minusBtn || !plusBtn || input.disabled) return; const step = parseFloat(input.step) || 1; const isFloat = input.step.includes('.'); const updateValue = (amount) => { let current = parseFloat(input.value); if (isNaN(current)) current = 0; let newValue = current + amount; if (isFloat) { const dp = (step.toString().split('.')[1] || '').length; newValue = parseFloat(newValue.toFixed(dp)); } const min = parseFloat(input.min); const max = parseFloat(input.max); if (!isNaN(min)) newValue = Math.max(min, newValue); if (!isNaN(max)) newValue = Math.min(max, newValue); input.value = newValue; input.dispatchEvent(new Event('change', { bubbles: true })); }; minusBtn.addEventListener('click', () => updateValue(-step)); plusBtn.addEventListener('click', () => updateValue(step)); }); }
    
    function setupEventListeners() {
        joystickCanvas.addEventListener('mousedown', handleJoystickStart); document.addEventListener('mousemove', handleJoystickMove); document.addEventListener('mouseup', handleJoystickEnd);
        joystickCanvas.addEventListener('touchstart', handleJoystickStart, { passive: false }); document.addEventListener('touchmove', handleJoystickMove, { passive: false }); document.addEventListener('touchend', handleJoystickEnd); document.addEventListener('touchcancel', handleJoystickEnd);
        document.getElementById('connectBleBtn').addEventListener('click', connectBLE);
        ['balanceSwitch', 'holdPositionSwitch', 'speedModeSwitch', 'lqrEnabledSwitch'].forEach(id => { document.getElementById(id).addEventListener('change', (e) => { const typeMap = { 'balanceSwitch': 'balance_toggle', 'holdPositionSwitch': 'hold_position_toggle', 'speedModeSwitch': 'speed_mode_toggle', 'lqrEnabledSwitch': 'lqr_enabled_toggle' }; sendBleMessage({ type: typeMap[id], enabled: e.target.checked }); }); });
        document.getElementById('resetZeroBtn').addEventListener('click', () => sendBleMessage({ type: 'reset_zero' }));
        document.getElementById('trimPlusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_zero', value: 1 }));
        document.getElementById('trimMinusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_zero', value: -1 }));
        document.getElementById('trimRollPlusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_roll', value: 1 }));
        document.getElementById('trimRollMinusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_roll', value: -1 }));
        document.getElementById('emergencyStopBtn').addEventListener('click', () => sendBleMessage({ type: 'emergency_stop' }));
        document.getElementById('saveBtn').addEventListener('click', () => { if (confirm("Czy na pewno chcesz nadpisac ustawienia w pamieci robota?")) sendBleMessage({ type: 'save_tunings' }); });
        document.getElementById('loadBtn').addEventListener('click', () => { if (confirm("UWAGA! Spowoduje to nadpisanie wszystkich niezapisanych zmian. Kontynuowac?")) sendBleMessage({ type: 'load_from_eeprom' }); });
        document.getElementById('calibrateMpuBtn').addEventListener('click', () => sendBleMessage({ type: 'calibrate_mpu' }));
        document.getElementById('resetEncodersBtn').addEventListener('click', () => sendBleMessage({ type: 'reset_encoders' }));
        document.getElementById('startLoggingBtn').addEventListener('click', startLogging);
        document.getElementById('cancelLoggingBtn').addEventListener('click', cancelLogging);
        document.getElementById('downloadCsvBtn').addEventListener('click', downloadCSV);

        const parameterMapping = { 'q1AngleInput': 'q1_angle', 'q2AngularVelInput': 'q2_angular_vel', 'q3PositionInput': 'q3_position', 'q4VelocityInput': 'q4_velocity', 'rControlInput': 'r_control', 'lqrOutputScalarInput': 'lqr_output_scalar', 'expoJoystickInput': 'expo_joystick', 'maxSpeedJoystickInput': 'max_speed_joystick', 'turnFactorInput': 'turn_factor', 'joystickOutputScaleInput': 'joystick_output_scale', 'joystickAngleSensitivityInput': 'joystick_angle_sensitivity', 'positionErrorGainInput': 'position_error_gain', 'positionDampingGainInput': 'position_d_gain', 'speedPGainInput': 'speed_p_gain', 'maxSpeedFromPosInput': 'max_speed_from_pos', 'holdPositionMarginPulsesInput': 'hold_position_margin_pulses', 'headingCorrectionFactorInput': 'heading_correction_factor', 'rotationPGainInput': 'rotation_p_gain', 'rollCorrectionGainInput': 'roll_correction_gain', 'wheelDiameterCmInput': 'wheel_diameter_cm', 'trackWidthCmInput': 'track_width_cm', 'encoderPprInput': 'encoder_ppr', 'minPwmLeftFwdInput': 'min_pwm_left_fwd', 'minPwmLeftBwdInput': 'min_pwm_left_bwd', 'minPwmRightFwdInput': 'min_pwm_right_fwd', 'minPwmRightBwdInput': 'min_pwm_right_bwd', 'globalPowerLimitInput': 'global_power_limit' };
        const configGroups = { 'lqr_update': ['q1AngleInput', 'q2AngularVelInput', 'q3PositionInput', 'q4VelocityInput', 'rControlInput', 'lqrOutputScalarInput'], 'set_joystick_tuning': ['joystickOutputScaleInput', 'expoJoystickInput', 'maxSpeedJoystickInput', 'joystickAngleSensitivityInput', 'turnFactorInput'], 'calibration_update': ['wheelDiameterCmInput', 'trackWidthCmInput', 'encoderPprInput', 'headingCorrectionFactorInput', 'positionErrorGainInput', 'positionDampingGainInput', 'rotationPGainInput', 'speedPGainInput', 'maxSpeedFromPosInput', 'holdPositionMarginPulsesInput', 'globalPowerLimitInput', 'rollCorrectionGainInput'], 'set_min_pwm': ['minPwmLeftFwdInput', 'minPwmLeftBwdInput', 'minPwmRightFwdInput', 'minPwmRightBwdInput'] };
        for (const [type, keys] of Object.entries(configGroups)) { debouncedSenders[type] = debounce(() => { const params = {}; keys.forEach(inputId => { const input = document.getElementById(inputId); if (input) { const snakeKey = parameterMapping[inputId]; if (!snakeKey) { console.error(`Brak mapowania dla parametru o ID: ${inputId}`); return; } let value = parseFloat(input.value); if (snakeKey === 'turn_factor' || snakeKey === 'joystick_output_scale' || snakeKey === 'expo_joystick') value /= 100; if (snakeKey === 'global_power_limit') value = Math.round(value * 1023 / 100); params[snakeKey] = value; } }); sendBleMessage({ type, params }); }, 350); keys.forEach(inputId => { const input = document.getElementById(inputId); if (input && !input.readOnly) input.addEventListener('change', debouncedSenders[type]); }); }

        document.getElementById('applySelectedPresetBtn').addEventListener('click', applySelectedPreset);
        document.getElementById('saveCurrentAsPresetBtn').addEventListener('click', saveCurrentAsPreset);
        document.querySelectorAll('.help-icon').forEach(icon => { icon.addEventListener('click', (e) => { e.stopPropagation(); const container = icon.closest('.setting-container, .control-row'); const helpText = container.querySelector('.help-text'); if (helpText) { helpText.classList.toggle('visible'); const accordionContent = container.closest('.accordion-content'); if (accordionContent) updateAccordionHeight(accordionContent); } }); });
        
        document.getElementById('startBoptBtn').addEventListener('click', startBOPT);
        document.getElementById('boptRunTestBtn').addEventListener('click', handleRunTestBtnClick);
        document.getElementById('stopBoptBtn').addEventListener('click', () => stopBOPT(true));
        document.getElementById('boptSavePresetBtn').addEventListener('click', saveBoptPreset);

        const boptModeBalanceBtn = document.getElementById('boptModeBalance');
        const boptModeDriveBtn = document.getElementById('boptModeDrive');
        const balanceSettings = document.getElementById('boptBalanceSettings');
        const driveSettings = document.getElementById('boptDriveSettings');
        boptModeBalanceBtn.addEventListener('click', () => { boptModeBalanceBtn.style.backgroundColor = '#a2f279'; boptModeDriveBtn.style.backgroundColor = ''; balanceSettings.style.display = 'block'; driveSettings.style.display = 'none'; });
        boptModeDriveBtn.addEventListener('click', () => { boptModeDriveBtn.style.backgroundColor = '#a2f279'; boptModeBalanceBtn.style.backgroundColor = ''; balanceSettings.style.display = 'none'; driveSettings.style.display = 'block'; });
        
        document.getElementById('updatePhysicalParamsBtn').addEventListener('click', () => {
            const params = {};
            document.querySelectorAll('.phys-param').forEach(input => {
                let key = input.id.replace('Input', '').replace(/([A-Z])/g, '_$1').toLowerCase();
                params[key] = parseFloat(input.value);
            });
            sendBleMessage({ type: 'update_physical_params', params });
            addLogMessage('[UI] Wyslano aktualizacje parametrow fizycznych do robota.', 'info');
        });

        document.getElementById('boptSaveSafeBaseBtn').addEventListener('click', () => { sendBleMessage({ type: 'ga_save_safe_params' }); addLogMessage('[UI] Wyslano polecenie zapisu bezpiecznej bazy LQR.', 'info'); });
        document.getElementById('boptRestoreSafeBaseBtn').addEventListener('click', () => { if (confirm("Spowoduje to przywrocenie bezpiecznych parametrow i nadpisanie aktualnych ustawien LQR. Kontynuowac?")) { sendBleMessage({ type: 'ga_restore_safe_params' }); addLogMessage('[UI] Wyslano polecenie przywrocenia bezpiecznej bazy LQR.', 'info'); setTimeout(() => sendBleMessage({ type: 'load_from_eeprom' }), 500); } });
    }

    async function startBOPT() {
        if (!bleDevice) { addLogMessage('Polacz z robotem przed rozpoczeciem optymalizacji.', 'warn'); return; }
        if (isBoptRunning) return;

        isBoptRunning = true;
        setBoptUiLock(true);
        lastBestBoptParams = null;
        document.getElementById('boptSavePresetBtn').disabled = true;
        
        const isBalanceMode = document.getElementById('boptBalanceSettings').style.display === 'block';
        let space;

        if (isBalanceMode) {
            addLogMessage('[UI] Rozpoczeto optymalizacje BALANSU.', 'success');
            await sendBleMessage({ type: 'ga_save_safe_params' });
            const useImpulse = document.getElementById('boptUseImpulseTest').checked;
            space = [ { name: 'q1_angle', domain: [1, 1000] }, { name: 'q2_angular_vel', domain: [0.1, 100] }, { name: 'r_control', domain: [0.001, 10] }, { name: 'lqr_output_scalar', domain: [0.1, 50] } ];
            if (useImpulse) { space.push({ name: 'q3_position', domain: [0, 100] }); space.push({ name: 'q4_velocity', domain: [0, 100] }); }
        } else {
            addLogMessage('[UI] Rozpoczeto interaktywne strojenie JAZDY.', 'success');
            space = [ { name: 'position_error_gain', domain: [0.1, 10.0] }, { name: 'position_d_gain', domain: [0.0, 15.0] }, { name: 'speed_p_gain', domain: [0.0001, 0.1] } ];
        }

        bayesianOptimizer = new bayes.Optimizer({ space });
        boptTotalIterations = parseInt(document.getElementById('boptIterationsInput').value);
        boptIterationCounter = 0;
        
        document.getElementById('startBoptBtn').disabled = true;
        document.getElementById('stopBoptBtn').disabled = false;

        runNextBoptIteration();
    }
    
    async function runNextBoptIteration() {
        if (!isBoptRunning || boptIterationCounter >= boptTotalIterations) {
            if(isBoptRunning) addLogMessage('[UI] Optymalizacja zakonczona!', 'success');
            stopBOPT(false);
            return;
        }
        boptIterationCounter++;
        updateBoptProgress(boptIterationCounter - 1, boptTotalIterations);

        addLogMessage(`[UI] Iteracja ${boptIterationCounter}/${boptTotalIterations}: Oczekiwanie na test...`, 'info');
        currentBoptParams = await bayesianOptimizer.ask();
        
        let paramsText = '';
        const isBalanceMode = document.getElementById('boptBalanceSettings').style.display === 'block';
        if (isBalanceMode) {
            paramsText = ` q1: ${currentBoptParams.q1_angle.toFixed(1)}\n q2: ${currentBoptParams.q2_angular_vel.toFixed(1)}\n  r: ${currentBoptParams.r_control.toFixed(3)}\n sc: ${currentBoptParams.lqr_output_scalar.toFixed(2)}`;
            if(currentBoptParams.q3_position !== undefined) paramsText += `\n q3: ${currentBoptParams.q3_position.toFixed(1)}`;
            if(currentBoptParams.q4_velocity !== undefined) paramsText += `\n q4: ${currentBoptParams.q4_velocity.toFixed(1)}`;
        } else {
            paramsText = ` pos_p: ${currentBoptParams.position_error_gain.toFixed(3)}\n pos_d: ${currentBoptParams.position_d_gain.toFixed(3)}\n spd_p: ${currentBoptParams.speed_p_gain.toFixed(4)}`;
        }
        document.getElementById('bopt-current-params-display').textContent = paramsText;
        document.getElementById('boptRunTestBtn').disabled = false;
        
        if (isBalanceMode) {
            handleRunTestBtnClick();
        }
    }

    async function handleRunTestBtnClick() {
        if (!isBoptRunning || !currentBoptParams) return;

        document.getElementById('boptRunTestBtn').disabled = true;
        addLogMessage(`[UI] Uruchamianie testu dla iteracji ${boptIterationCounter}...`, 'info');

        const isBalanceMode = document.getElementById('boptBalanceSettings').style.display === 'block';
        let testCommand;
        
        if (isBalanceMode) {
            await sendBleMessage({ type: 'lqr_update', params: currentBoptParams });
            const useImpulse = document.getElementById('boptUseImpulseTest').checked;
            testCommand = useImpulse ? {type: 'ga_execute_impulse_and_measure'} : {type: 'ga_run_static_stability_test'};
            await sendBleMessage({ type: 'ga_set_impulse', power: parseFloat(document.getElementById('boptImpulsePowerInput').value) });
        } else {
            await sendBleMessage({ type: 'calibration_update', params: currentBoptParams });
            const distance = parseFloat(document.getElementById('boptDriveDistanceInput').value);
            testCommand = { type: 'run_drive_test', distance_cm: distance };
        }

        await new Promise(r => setTimeout(r, 200));
        await sendBleMessage(testCommand);

        const fitnessPromise = new Promise(resolve => { resolveTestResultPromise = resolve; });
        const fitness = await fitnessPromise;

        if (!isBoptRunning || fitness < 0) {
            addLogMessage('[UI] Test przerwany lub anulowany.', 'warn');
            return;
        }

        addLogMessage(`[UI] Otrzymano wynik (fitness): ${fitness.toFixed(4)}`, 'info');
        await bayesianOptimizer.tell(currentBoptParams, fitness);
        
        const [bestParams, bestFitness] = await bayesianOptimizer.getBest();
        
        updateBoptProgress(boptIterationCounter, boptTotalIterations, bestFitness, bestParams);

        runNextBoptIteration();
    }
    
    function stopBOPT(sendCmd) {
        if (!isBoptRunning) return;
        isBoptRunning = false;
        if(resolveTestResultPromise) resolveTestResultPromise(-1);
        setBoptUiLock(false);
        document.getElementById('boptRunTestBtn').disabled = true;
        document.getElementById('bopt-current-params-display').textContent = 'Anulowano.';

        if (sendCmd) {
            addLogMessage('[UI] Zatrzymywanie optymalizacji i przywracanie stanu...', 'info');
            sendBleMessage({ type: 'ga_restore_safe_params' });
            setTimeout(() => { 
                sendBleMessage({ type: 'command_stop' });
                sendBleMessage({ type: 'load_from_eeprom' });
            }, 200);
        }
    }

    function setBoptUiLock(isLocked) {
        document.querySelectorAll('button, input, select').forEach(el => {
            const parentCard = el.closest('.card');
            if (parentCard && parentCard.contains(document.getElementById('startBoptBtn'))) {
                if (el.id !== 'stopBoptBtn' && el.id !== 'boptRunTestBtn') el.disabled = isLocked;
            } else {
                if (el.id !== 'emergencyStopBtn' && el.id !== 'connectBleBtn') {
                    el.disabled = isLocked;
                }
            }
        });
        document.getElementById('startBoptBtn').disabled = isLocked;
        document.getElementById('stopBoptBtn').disabled = !isLocked;
        document.getElementById('connectBleBtn').disabled = isLocked || !!bleDevice;
    }

    async function saveBoptPreset() {
        if (!lastBestBoptParams) { addLogMessage('Brak danych do zapisu.', 'warn'); return; }
        const bestFitness = parseFloat(document.getElementById('boptBestFitnessStatus').textContent);
        const presetName = prompt("Podaj nazwe dla presetu:", `BOPT_Fit_${bestFitness.toFixed(4)}`);
        
        if (presetName && presetName.trim() !== "") {
            const isBalanceMode = document.getElementById('boptBalanceSettings').style.display === 'block';
            let presetData = {};
            if (isBalanceMode) {
                presetData = { q1Angle: lastBestBoptParams.q1_angle, q2AngularVel: lastBestBoptParams.q2_angular_vel, q3Position: lastBestBoptParams.q3_position || parseFloat(document.getElementById('q3PositionInput').value), q4Velocity: lastBestBoptParams.q4_velocity || parseFloat(document.getElementById('q4VelocityInput').value), rControl: lastBestBoptParams.r_control, lqrOutputScalar: lastBestBoptParams.lqr_output_scalar };
            } else {
                presetData = { q1Angle: parseFloat(document.getElementById('q1AngleInput').value), q2AngularVel: parseFloat(document.getElementById('q2AngularVelInput').value), q3Position: parseFloat(document.getElementById('q3PositionInput').value), q4Velocity: parseFloat(document.getElementById('q4VelocityInput').value), rControl: parseFloat(document.getElementById('rControlInput').value), lqrOutputScalar: parseFloat(document.getElementById('lqrOutputScalarInput').value), positionErrorGain: lastBestBoptParams.position_error_gain, positionDampingGain: lastBestBoptParams.position_d_gain, speedPGain: lastBestBoptParams.speed_p_gain };
            }
            localStorage.setItem(CUSTOM_PRESET_PREFIX + presetName.trim(), JSON.stringify(presetData));
            addLogMessage(`[UI] Zapisano wlasny preset '${presetName.trim()}'.`, 'success');
            populatePresetSelect();
        }
    }
    
    let loggingInterval;
    function startLogging() {
        const durationS = parseInt(document.getElementById('loggingTimeInput').value);
        if (isNaN(durationS) || durationS <= 0) {
            addLogMessage('[UI] Podaj poprawny czas zbierania danych.', 'error');
            return;
        }
        sendBleMessage({type: 'start_logging', duration_s: durationS});
        
        document.getElementById('startLoggingBtn').style.display = 'none';
        document.getElementById('cancelLoggingBtn').style.display = 'block';
        document.getElementById('downloadCsvBtn').disabled = true;
        loggedData = [];

        let timeLeft = durationS;
        const statusEl = document.getElementById('loggingStatus');
        statusEl.textContent = `Zbieram dane... (${timeLeft}s)`;
        loggingInterval = setInterval(() => {
            timeLeft--;
            statusEl.textContent = `Zbieram dane... (${timeLeft}s)`;
            if (timeLeft <= 0) clearInterval(loggingInterval);
        }, 1000);
    }
    
    function cancelLogging() {
        sendBleMessage({type: 'stop_logging'});
        clearInterval(loggingInterval);
        document.getElementById('startLoggingBtn').style.display = 'block';
        document.getElementById('cancelLoggingBtn').style.display = 'none';
        document.getElementById('loggingStatus').textContent = 'Anulowano.';
        addLogMessage('[UI] Zbieranie danych anulowane przez uzytkownika.', 'warn');
    }

    function handleLoggingFinished(points) {
        clearInterval(loggingInterval);
        document.getElementById('startLoggingBtn').style.display = 'block';
        document.getElementById('cancelLoggingBtn').style.display = 'none';
        if (points > 0) {
            document.getElementById('loggingStatus').textContent = `Zebrano ${points} punktow. Gotowe do pobrania.`;
            document.getElementById('downloadCsvBtn').disabled = false;
        } else {
            document.getElementById('loggingStatus').textContent = 'Nie zebrano zadnych danych.';
        }
    }

    function downloadCSV() {
        if (loggedData.length === 0) {
            addLogMessage('[UI] Brak danych do wyeksportowania.', 'warn');
            return;
        }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "czas_ms,pitch,predkosc,zadana_predkosc,wyjscie_lqr\n";
        
        loggedData.forEach(rowArray => {
            let row = rowArray.join(",");
            csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "dane_robota.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addLogMessage('[UI] Wyeksportowano dane do pliku CSV.', 'success');
    }

    function setupManualTuneButtons() { document.querySelectorAll('.manual-tune-row').forEach(row => { const motor = row.dataset.motor; const direction = row.dataset.direction; const input = row.querySelector('.tune-input'); const testBtn = row.querySelector('.test-btn'); const stopBtn = row.querySelector('.stop-btn'); const autoBtn = row.querySelector('.auto-btn'); testBtn.addEventListener('click', () => { sendBleMessage({ type: 'manual_tune_motor', motor, direction, pwm: parseInt(input.value) }); }); stopBtn.addEventListener('click', () => { sendBleMessage({ type: 'manual_tune_motor', motor, direction, pwm: 0 }); }); autoBtn.addEventListener('click', (e) => { if (confirm("UWAGA! Upewnij sie, ze robot jest uniesiony, a kola moga sie swobodnie obracac. Kontynuowac?")) { const startValue = parseInt(document.getElementById('pwmTuneStartInput').value); sendBleMessage({ type: 'autotune_single_pwm', motor, direction, start_pwm: startValue }); e.target.disabled = true; e.target.textContent = 'Szukanie...'; addLogMessage(`[UI] Rozpoczynam auto-strojenie dla ${motor} ${direction}...`, 'info'); } }); }); document.getElementById('manualTuneStopAll').addEventListener('click', () => { sendBleMessage({ type: 'manual_tune_stop_all' }); }); }
    function setupSequenceControls() { document.getElementById('add-sequence-step-btn').addEventListener('click', addSequenceStep); document.getElementById('run-sequence-btn').addEventListener('click', runSequence); document.getElementById('stop-sequence-btn').addEventListener('click', stopSequenceExecution); document.getElementById('clear-sequence-btn').addEventListener('click', clearSequence); }
    function addSequenceStep() { const list = document.getElementById('sequence-list'); if (list.children.length >= MAX_SEQUENCE_STEPS) return; const stepDiv = document.createElement('div'); stepDiv.className = 'sequence-step'; stepDiv.innerHTML = ` <select class="sequence-type"> <option value="move_fwd">Przod (cm)</option><option value="move_bwd">Tyl (cm)</option> <option value="rotate_r">Obrot Prawo (st.)</option><option value="rotate_l">Obrot Lewo (st.)</option> </select> <input type="number" class="sequence-value" value="10"> <button class="remove-step-btn">&times;</button> `; list.appendChild(stepDiv); updateAccordionHeight(list.closest('.accordion-content')); stepDiv.querySelector('.remove-step-btn').addEventListener('click', () => { stepDiv.remove(); updateAccordionHeight(list.closest('.accordion-content')); }); }
    function runSequence() { if (isSequenceRunning) return; if (lastKnownRobotState !== 'IDLE' && lastKnownRobotState !== 'HOLDING_POSITION') { addLogMessage(`[UI] Nie mozna rozpoczac sekwencji. Robot w stanie '${lastKnownRobotState}'.`, 'error'); return; } const steps = document.querySelectorAll('.sequence-step'); if (steps.length === 0) return; isSequenceRunning = true; currentSequenceStep = 0; updateSequenceUI(); addLogMessage(`[UI] Rozpoczeto sekwencje z ${steps.length} krokow.`, 'info'); executeNextSequenceStep(); }
    function stopSequenceExecution() { if (!isSequenceRunning) return; isSequenceRunning = false; sendBleMessage({ type: 'command_stop' }); updateSequenceUI(); addLogMessage('[UI] Sekwencja zatrzymana.', 'warn'); }
    function clearSequence() { if (isSequenceRunning) stopSequenceExecution(); const list = document.getElementById('sequence-list'); list.innerHTML = ''; updateAccordionHeight(list.closest('.accordion-content')); }
    function updateSequenceUI() { document.querySelectorAll('.sequence-step').forEach((step, index) => { step.classList.toggle('executing', isSequenceRunning && index === currentSequenceStep); }); document.getElementById('run-sequence-btn').disabled = isSequenceRunning; document.getElementById('add-sequence-step-btn').disabled = isSequenceRunning; document.getElementById('clear-sequence-btn').disabled = isSequenceRunning; document.getElementById('stop-sequence-btn').disabled = !isSequenceRunning; }
    function checkAndExecuteNextSequenceStep(previousState) { if (!isSequenceRunning) return; const isRobotIdle = lastKnownRobotState.includes('IDLE') || lastKnownRobotState.includes('HOLDING') || lastKnownRobotState.includes('GA_READY'); const wasRobotWorking = previousState.includes('MOVE') || previousState.includes('ROTATE'); if (isRobotIdle && wasRobotWorking) { addLogMessage(`[UI] Krok ${currentSequenceStep + 1} zakonczony.`, 'info'); currentSequenceStep++; executeNextSequenceStep(); } }
    function executeNextSequenceStep() { const steps = document.querySelectorAll('.sequence-step'); if (!isSequenceRunning || currentSequenceStep >= steps.length) { if (isSequenceRunning) { isSequenceRunning = false; addLogMessage('[UI] Sekwencja ukonczona.', 'info'); } updateSequenceUI(); return; } updateSequenceUI(); const stepNode = steps[currentSequenceStep]; const type = stepNode.querySelector('.sequence-type').value; const value = parseFloat(stepNode.querySelector('.sequence-value').value); let command = {}; switch (type) { case 'move_fwd': command = { type: 'execute_move', distance_cm: value }; break; case 'move_bwd': command = { type: 'execute_move', distance_cm: -value }; break; case 'rotate_r': command = { type: 'execute_rotate', angle_deg: value }; break; case 'rotate_l': command = { type: 'execute_rotate', angle_deg: -value }; break; } addLogMessage(`[UI] Wysylanie kroku ${currentSequenceStep + 1}/${steps.length}: ${command.type}(${value}).`, 'info'); sendBleMessage(command); }
    function setupDpadControls() { document.querySelectorAll('.dpad-btn').forEach(btn => { btn.addEventListener('click', (e) => { const action = e.currentTarget.dataset.dpad; if (action === 'up') sendBleMessage({ type: 'execute_move', distance_cm: parseFloat(document.getElementById('dpadDistInput').value) }); else if (action === 'down') sendBleMessage({ type: 'execute_move', distance_cm: -parseFloat(document.getElementById('dpadDistInput').value) }); else if (action === 'left') sendBleMessage({ type: 'execute_rotate', angle_deg: -parseFloat(document.getElementById('dpadAngleInput').value) }); else if (action === 'right') sendBleMessage({ type: 'execute_rotate', angle_deg: parseFloat(document.getElementById('dpadAngleInput').value) }); else if (action === 'stop') sendBleMessage({ type: 'command_stop' }); }); }); }
    function setupGamepadMappingModal() { document.getElementById('open-gamepad-modal-btn').addEventListener('click', () => { document.getElementById('gamepad-mapping-modal').style.display = 'flex'; }); document.getElementById('close-modal-btn').addEventListener('click', () => { document.getElementById('gamepad-mapping-modal').style.display = 'none'; }); }
    function flashElement(element) { if (!element) return; const target = element.tagName === 'INPUT' ? element.closest('.switch') || element.closest('.control-row') || element : element; target.classList.add('gamepad-flash'); setTimeout(() => target.classList.remove('gamepad-flash'), 300); }
    function loadGamepadMappings() { const saved = localStorage.getItem(GAMEPAD_MAPPING_KEY); gamepadMappings = saved ? JSON.parse(saved) : {}; }
    function saveGamepadMappings() { localStorage.setItem(GAMEPAD_MAPPING_KEY, JSON.stringify(gamepadMappings)); }

</script>

</body>
</html>