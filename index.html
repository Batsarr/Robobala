<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RoboBala</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body class="ui-locked">
    <div id="emergency-banner">ZATRZYMANIE AWARYJNE</div>
    <div id="gamepad-mapping-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Mapowanie Przyciskow Gamepada</h2>
            <div id="gamepad-mapping-list"></div>
            <button id="close-modal-btn" style="margin-top: 20px;">Zamknij</button>
        </div>
    </div>
    <div id="calibration-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Kalibracja IMU (Czujnik Nachylenia)</h2>
            <p>Aby skalibrowac czujnik IMU, powoli obroc robota we wszystkich kierunkach: do przodu, do tylu, na boki i wokol wlasnej osi pionowej. Wykonaj co najmniej 3 pelne obroty w kazdej plaszczyznie.</p>
            <p><strong>Dla akcelerometru (Accel) wazne:</strong> Trzymaj robota nieruchomo na okolo 10 sekund w kazdej z 6 pozycji (szescian): gora, dol, przednia strona, tylna strona, lewa strona, prawa strona. Powtarzaj obroty i zatrzymania, az progres osiagnie co najmniej 3/4 dla kazdej osi. Obroty powinny byc wolne i plynne.</p>
            <div class="calib-axis" style="display: flex; align-items: center; margin: 10px 0; justify-content: space-between;">
                <span>Sys (System):</span><progress id="calib-sys-bar" value="0" max="3" style="flex: 1; margin: 0 10px;"></progress><span id="calib-sys-text">0</span>/3
            </div>
            <div class="calib-axis" style="display: flex; align-items: center; margin: 10px 0; justify-content: space-between;">
                <span>Accel (Przyspieszenie):</span><progress id="calib-accel-bar" value="0" max="3" style="flex: 1; margin: 0 10px;"></progress><span id="calib-accel-text">0</span>/3
            </div>
            <div class="calib-axis" style="display: flex; align-items: center; margin: 10px 0; justify-content: space-between;">
                <span>Gyro (Obroty):</span><progress id="calib-gyro-bar" value="0" max="3" style="flex: 1; margin: 0 10px;"></progress><span id="calib-gyro-text">0</span>/3
            </div>
            <div class="calib-axis" style="display: flex; align-items: center; margin: 10px 0; justify-content: space-between;">
                <span>Mag (Magnetyczne):</span><progress id="calib-mag-bar" value="0" max="3" style="flex: 1; margin: 0 10px;"></progress><span id="calib-mag-text">0</span>/3
            </div>
            <div style="display:flex; gap:8px;">
                <button id="calib-update-btn" style="flex:1;">Aktualizuj Status</button>
                <button id="calib-close-btn" style="flex:1;">Zamknij</button>
            </div>
            <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                <button id="calib-save-btn" style="display:none; background:#61dafb; padding:6px 12px; border-radius:6px;">Zapisz offset do EEPROM</button>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 400px;">
            <h2>üîó Kod QR Po≈ÇƒÖczenia</h2>
            <p style="font-size: 0.9em; color: #aaa; margin-bottom: 15px;">Zeskanuj kod QR z innego urzƒÖdzenia, aby po≈ÇƒÖczyƒá siƒô z tym robotem.</p>
            <div id="qr-device-info" style="margin-bottom: 15px; padding: 10px; background: #333; border-radius: 6px;">
                <strong>Nazwa urzƒÖdzenia:</strong> <span id="qr-device-name">---</span>
            </div>
            <div id="qr-code-container" style="display: flex; justify-content: center; padding: 20px; background: white; border-radius: 8px; margin-bottom: 15px;"></div>
            <div style="font-size: 0.85em; color: #888; margin-bottom: 15px;">
                <strong>Link:</strong> <input id="qr-link-input" type="text" readonly style="width: 100%; padding: 5px; font-family: monospace; font-size: 0.85em; background: #222; color: #61dafb; border: 1px solid #444; border-radius: 4px; margin-top: 5px;">
            </div>
            <div style="background: #2a3a2a; border: 1px solid #4caf50; border-radius: 6px; padding: 10px; margin-bottom: 15px;">
                <p style="font-size: 0.85em; color: #a2f279; margin: 0; text-align: center;">
                    üí° <strong>Kod QR jest sta≈Çy</strong> - mo≈ºesz go wydrukowaƒá i u≈ºywaƒá wielokrotnie!
                </p>
            </div>
            <div style="display: flex; gap: 8px;">
                <button id="qr-print-btn" style="flex: 1; background: #f7b731;">üñ®Ô∏è Drukuj</button>
                <button id="qr-copy-link-btn" style="flex: 1; background: #61dafb;">üìã Kopiuj</button>
                <button id="qr-close-btn" style="flex: 1;">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- UWAGA: Nazwa "RoboBala" jest oficjalnƒÖ nazwƒÖ projektu i NIE powinna byƒá zmieniana.
         Zmieniaj tylko numer wersji (v23.2 ‚Üí v23.3 itd.) przy aktualizacjach. -->
    <h1>RoboBala v23.2</h1>
    <div class="main-grid">
        <div class="card" id="controls-card">
            <h2>Sterowanie</h2>
            <div id="joystickWrapper"><canvas id="joystickCanvas"></canvas></div>
            <div class="control-row">
                <span class="control-label">Balansowanie <span class="help-icon" title="W≈ÇƒÖcza g≈Ç√≥wnƒÖ pƒôtlƒô PID odpowiedzialnƒÖ za utrzymanie robota w pionie. Robot aktywnie koryguje swoje po≈Ço≈ºenie wykorzystujƒÖc dane z czujnika IMU.">?</span></span>
                <label class="switch"><input type="checkbox" id="balanceSwitch"><span class="slider round"></span></label>
            </div>
            <div class="control-row">
                <span class="control-label">Trzymaj Pozycje <span class="help-icon" title="Aktywuje pƒôtlƒô PID pozycji - robot stara siƒô pozostaƒá w miejscu, kompensujƒÖc dryf. Wymaga dzia≈ÇajƒÖcego balansowania.">?</span></span>
                <label class="switch"><input type="checkbox" id="holdPositionSwitch"><span class="slider round"></span></label>
            </div>
            <div class="control-row">
                <span class="control-label">Tryb Predkosci <span class="help-icon" title="Zmienia tryb sterowania z pozycyjnego na prƒôdko≈õciowy. Joystick kontroluje prƒôdko≈õƒá jazdy zamiast docelowej pozycji.">?</span></span>
                <label class="switch"><input type="checkbox" id="speedModeSwitch"><span class="slider round"></span></label>
            </div>
            <div class="control-row">
                <span class="control-label">Wylacz Magnetometr <span class="help-icon" title="Wy≈ÇƒÖcza magnetometr w algorytmie fuzji sensor√≥w. Przydatne gdy magnetometr jest zak≈Ç√≥cany przez silniki lub metalowe elementy.">?</span></span>
                <label class="switch"><input type="checkbox" id="disableMagnetometerSwitch"><span class="slider round"></span></label>
            </div>
            <button id="open-gamepad-modal-btn" style="width: 100%; background-color:#f7b731; margin-top: 15px;">Mapowanie Przyciskow Gamepada</button>
            <fieldset style="margin-top:10px; border: 1px solid #444; padding: 10px; border-radius: 6px;">
                <legend style="color: #61dafb; font-weight: bold;">Korekta monta≈ºu (EEPROM)</legend>
                <button id="resetZeroBtn" style="width:100%;">Ustaw punkt 0 (Pitch)</button>
                <div class="trim-controls">
                    <button id="pitchTrimMinus01Btn">-0.1</button>
                    <button id="pitchTrimMinus001Btn">-0.01</button>
                    <span>Pitch: <span id="trimValueDisplay">0.00</span>¬∞</span>
                    <button id="pitchTrimPlus001Btn">+0.01</button>
                    <button id="pitchTrimPlus01Btn">+0.1</button>
                </div>
                <button id="resetRollZeroBtn" style="margin-top:10px; width:100%;">Ustaw punkt 0 (Roll)</button>
                <div class="trim-controls">
                    <button id="rollTrimMinus01Btn">-0.1</button>
                    <button id="rollTrimMinus001Btn">-0.01</button>
                    <span>Roll: <span id="rollTrimValueDisplay">0.00</span>¬∞</span>
                    <button id="rollTrimPlus001Btn">+0.01</button>
                    <button id="rollTrimPlus01Btn">+0.1</button>
                </div>
            </fieldset>
            <fieldset style="margin-top:10px; border: 1px solid #a2f279; padding: 10px; border-radius: 6px;">
                <legend style="color: #a2f279; font-weight: bold;">Offset pionu (EEPROM)</legend>
                <button id="resetPitchOffsetBtn" style="width:100%;">Zeruj offset (Pitch)</button>
                <div class="trim-controls">
                    <button id="pitchOffsetMinus01Btn">-0.1</button>
                    <button id="pitchOffsetMinus001Btn">-0.01</button>
                    <span>Pitch: <span id="pitchOffsetDisplay">0.00</span>¬∞</span>
                    <button id="pitchOffsetPlus001Btn">+0.01</button>
                    <button id="pitchOffsetPlus01Btn">+0.1</button>
                </div>
                <button id="resetRollOffsetBtn" style="margin-top:10px; width:100%;">Zeruj offset (Roll)</button>
                <div class="trim-controls">
                    <button id="rollOffsetMinus01Btn">-0.1</button>
                    <button id="rollOffsetMinus001Btn">-0.01</button>
                    <span>Roll: <span id="rollOffsetDisplay">0.00</span>¬∞</span>
                    <button id="rollOffsetPlus001Btn">+0.01</button>
                    <button id="rollOffsetPlus01Btn">+0.1</button>
                </div>
            </fieldset>
            <button id="resetEncodersBtn" style="margin-top:10px; background-color:#f7b731; width: 100%;">Resetuj Enkodery</button>
            <button id="emergencyStopBtn">STOP AWARYJNY</button>
            <button class="accordion-header" onclick="toggleAccordion(this)" style="margin-top: 15px;">Strojenie Joysticka</button>
            <div class="accordion-content">
                <div class="setting-container"><label for="joystickSensitivityInput">Czulosc Globalna (%)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="joystickSensitivityInput" min="10" max="100" step="5" value="100"><button>+</button></div><div class="help-text">Globalny mno≈ºnik dla wszystkich warto≈õci z joysticka. Ustawienie 100% oznacza pe≈ÇnƒÖ czu≈Ço≈õƒá - robot reaguje maksymalnie na ruchy joysticka. Zmniejsz do 50-70%, je≈õli robot jest zbyt nerwowy lub reaguje zbyt gwa≈Çtownie. Przydatne podczas nauki sterowania lub w ciasnych przestrzeniach. Typowy zakres: 60-100%.</div></div>
                <div class="setting-container"><label for="expoJoystickInput">Expo Joysticka (%)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="expoJoystickInput" min="0" max="90" step="1" value="0"><button>+</button></div><div class="help-text">Krzywa wyk≈Çadnicza (expo) zmienia charakterystykƒô odpowiedzi joysticka. Przy 0% odpowied≈∫ jest liniowa. Zwiƒôkszenie warto≈õci sprawia, ≈ºe przy ma≈Çych wychyleniach robot reaguje ≈Çagodniej (wiƒôksza precyzja), a przy du≈ºych wychyleniach normalnie. Warto≈õƒá 30-50% zapewnia dobrƒÖ r√≥wnowagƒô miƒôdzy precyzjƒÖ a responsywno≈õciƒÖ. Typowy zakres: 0-50%.</div></div>
                <div class="setting-container"><label for="maxSpeedJoystickInput">Max. predkosc (imp/s)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="maxSpeedJoystickInput" min="200" max="4000" step="100" value="800"><button>+</button></div><div class="help-text">Maksymalna prƒôdko≈õƒá zadana w trybie prƒôdko≈õci przy pe≈Çnym wychyleniu joysticka do przodu/ty≈Çu. Wy≈ºsza warto≈õƒá = szybszy robot. Dla bezpiecznej nauki zacznij od 500-800 imp/s. Dla sportowej jazdy mo≈ºesz zwiƒôkszyƒá do 1500-2500 imp/s. Uwaga: zbyt wysoka warto≈õƒá mo≈ºe powodowaƒá utratƒô balansu! Typowy zakres: 500-1500 imp/s.</div></div>
                <div class="setting-container"><label for="maxAccelJoystickInput">Max. przyspieszenie (imp/s^2)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="maxAccelJoystickInput" min="0" max="2000" step="10" value="200"><button>+</button></div><div class="help-text">Maksymalna zmiana zadanej prƒôdko≈õci na sekundƒô (imp/s^2). Ogranicza przyspieszenie przy sterowaniu joystickiem, co poprawia stabilno≈õƒá. Warto≈õƒá poczƒÖtkowa: 200 imp/s^2. Dostosuj w zale≈ºno≈õci od reakcji robota.</div></div>
                <div class="setting-container"><label for="joystickAngleSensitivityInput">Czulosc Kata (st.)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="joystickAngleSensitivityInput" min="1" max="30" step="0.5" value="10"><button>+</button></div><div class="help-text">Maksymalny kƒÖt pochylenia zadany w trybie kƒÖta przy pe≈Çnym wychyleniu joysticka. Mniejsza warto≈õƒá (5-8¬∞) = ≈Çagodniejsze przyspieszenie, bardziej przewidywalne zachowanie. Wiƒôksza warto≈õƒá (12-20¬∞) = agresywniejsze przyspieszenie, szybsza reakcja. Rozpocznij od 8-10¬∞ i dostosuj do swoich preferencji. Typowy zakres: 6-15¬∞.</div></div>
                <div class="setting-container"><label for="turnFactorInput">Czulosc Skretu (%)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="turnFactorInput" min="0" max="100" step="5" value="25"><button>+</button></div><div class="help-text">Kontroluje, jak szybko robot obraca siƒô w miejscu przy wychyleniu joysticka w poziomie. Mniejsza warto≈õƒá (15-25%) = powolne, p≈Çynne skrƒôty. Wiƒôksza warto≈õƒá (40-60%) = szybkie, ostre skrƒôty. Za wysoka warto≈õƒá mo≈ºe powodowaƒá utratƒô balansu podczas obrotu. Typowy zakres: 20-40%.</div></div>
                <div class="setting-container"><label for="joystickDeadzoneInput">Strefa Martwa (%)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="joystickDeadzoneInput" min="0" max="50" step="1" value="0"><button>+</button></div><div class="help-text">Obszar wok√≥≈Ç ≈õrodka joysticka, w kt√≥rym ruch jest ignorowany. Przydatne, je≈õli joystick "dryfuje" sam z siebie lub chcesz uniknƒÖƒá przypadkowych mikroruch√≥w. Warto≈õƒá 5-10% usuwa drobne dr≈ºenia bez utraty czu≈Ço≈õci. Typowy zakres: 0-15%.</div></div>
            </div>
        </div>
        <div class="card">
            <h2>Dashboard</h2>
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button id="connectBleBtn" style="flex: 1;">POLACZ Z ROBOTEM</button>
                <button id="showQrBtn" style="width: 50px; background: #555; opacity: 0.5;" disabled title="Po≈ÇƒÖcz siƒô z robotem, aby wygenerowaƒá kod QR">üì±</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: start; margin-bottom: 15px;">
                <div class="status-grid">
                    <strong>Polaczenie:</strong> <div><span id="connectionStatus" class="status-indicator status-disconnected"></span> <span id="connectionText">Rozlaczony</span></div>
                    <strong>Gamepad:</strong> <span id="gamepadStatus" style="font-weight:bold; color: #f7b731;">Brak</span>
                    <strong>Tryb Pracy:</strong> <span id="robotStateVal" style="font-weight:bold; color: #61dafb;">IDLE</span>
                    <span id="signSummary" style="margin-left:8px; font-size:0.9em; color:#a2f279;">B:+ S:+ P:+</span>
                </div>
                <div class="compass-container">
                    <div class="compass-needle" id="compassNeedle"></div>
                    <span class="compass-cardinal n">N</span>
                    <span class="compass-cardinal e">E</span>
                    <span class="compass-cardinal s">S</span>
                    <span class="compass-cardinal w">W</span>
                </div>
            </div>
             <div class="dashboard-grid">
                <div class="dashboard-item">
                    <span class="label">Czas Petli</span>
                    <span class="value" id="loopTimeVal">0 &micro;s</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Czas Petli (≈õrednio)</span>
                    <span class="value" id="loopLoadVal">-- %</span>
                </div>
                <div class="dashboard-item" id="systemHealthItem">
                    <span class="label">System Health</span>
                    <span class="value" id="systemHealthVal">OK</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Kalibracja IMU</span>
                    <span class="value">Sys: <span id="calibSysVal">-</span></span>
                    <div class="historical-metric">Acc: <span id="calibAccelVal">-</span> Gyro: <span id="calibGyroVal">-</span> Mag: <span id="calibMagVal">-</span></div>
                </div>
                    <div class="dashboard-item" id="imuRateItem">
                        <span class="label">IMU rate</span>
                        <span class="value"><span id="imuRateValue">--</span> Hz</span>
                        <div style="font-size:0.8em;color:#cfd8dc;margin-top:6px;">Pokazuje rzeczywistƒÖ prƒôdko≈õƒá od≈õwie≈ºania danych IMU (≈õrednia z ostatniej sekundy).</div>
                    </div>
                <div class="dashboard-item">
                    <span class="label">Korekta monta≈ºu (Pitch)</span>
                    <span class="value" id="angleOffsetVal">0.0 ¬∞</span>
                    <div class="historical-metric">Delta vs initial: <span id="offsetDeltaVal">0.0 ¬∞</span></div>
                </div>
                <div class="dashboard-item">
                    <span class="label">Korekta monta≈ºu (Roll)</span>
                    <span class="value" id="rollMountOffsetVal">0.0 ¬∞</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Offset pionu (Pitch)</span>
                    <span class="value" id="pitchUIOffsetVal" style="color: #a2f279;">0.0 ¬∞</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Offset pionu (Roll)</span>
                    <span class="value" id="rollUIOffsetVal" style="color: #a2f279;">0.0 ¬∞</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Kat (Pitch)</span>
                    <span class="value" id="angleVal">0.0 &deg;</span>
                    <div class="historical-metric">(min: <span id="pitchMin">---</span>, max: <span id="pitchMax">---</span>, avg: <span id="pitchAvg">---</span>)</div>
                </div>
                <div class="dashboard-item">
                    <span class="label">Predkosc</span>
                    <span class="value" id="speedVal">0 imp/s</span>
                    <div class="historical-metric">(min: <span id="speedMin">---</span>, max: <span id="speedMax">---</span>, avg: <span id="speedAvg">---</span>)</div>
                </div>
                <div class="dashboard-item">
                    <span class="label">Kat (Roll)</span>
                    <span class="value" id="rollVal">0.0 &deg;</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Enkoder L</span>
                    <span class="value" id="encoderLeftVal">0</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Enkoder P</span>
                    <span class="value" id="encoderRightVal">0</span>
                </div>
                <div class="dashboard-item">
                    <span class="label">Kurs (Yaw)</span>
                    <span class="value" id="yawVal">0.0 ¬∞</span>
                </div>
            </div>
             <fieldset style="margin-top: 15px;">
                <legend>Diagnostyka</legend>
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <button id="calibrateMpuBtn" style="width:100%; background-color:#f7b731;">Asystent Kalibracji IMU</button>
                    <button id="calibrateZeroPointBtn" style="width:100%; background-color:#f7b731;">Znajdz Pion Automatycznie</button>
                    <button id="sensorMappingBtn" style="width:100%; background-color:#f7b731;">Mapowanie czujnika</button>
                    <button id="modelMappingBtn" style="width:100%; background-color:#f7b731;">Mapowanie modelu 3D</button>
                </div>
            </fieldset>
        </div>
        <div class="card">
            <h2>Wizualizacja 3D Robota</h2>
            <div id="robot3d-container"></div>
            <div class="robot3d-controls">
                <button id="reset3dViewBtn">Resetuj Widok</button>
                <button id="toggle3dAnimationBtn">Wl./Wyl. Animacje</button>
                <button id="toggle3dMovementBtn">Start/Stop Ruchu</button>
            </div>
            <div class="robot3d-info">
                <div class="robot3d-metrics">
                    <strong>Przechyl (Pitch):</strong> <span id="robot3d-pitch">0.0¬∞</span>
                    <strong>Przechyl (Roll):</strong> <span id="robot3d-roll">0.0¬∞</span>
                    <strong>Obrot kol:</strong> <span id="robot3d-wheel-speed">0 obr/min</span>
                    <strong>Pozycja X:</strong> <span id="robot3d-position-x">0.0 cm</span>
                    <strong>Pozycja Z:</strong> <span id="robot3d-position-z">0.0 cm</span>
                </div>
            </div>
            <fieldset style="margin-top: 15px;">
                <div class="control-row" style="margin-bottom: 15px;">
                    <span class="control-label">Perspektywa Robota</span>
                    <label class="switch"><input type="checkbox" id="robotPerspectiveCheckbox"><span class="slider round"></span></label>
                </div>
            </fieldset>
        </div>
        <div class="card">
            <h2>Analizator Sygnalow</h2>
            <div class="chart-hints">
                <strong>üí° Wskaz√≥wki:</strong> 
                Ctrl+Scroll dla zoom | Ctrl+PrzeciƒÖgnij dla przewijania | Shift+PrzeciƒÖgnij dla zaznaczenia zakresu
            </div>
            <div id="chart-wrapper">
                <canvas id="signalAnalyzerChart"></canvas>
            </div>
            <div class="chart-toolbar">
                <button id="pauseChartBtn">‚è∏Ô∏è Pauza</button>
                <button id="resumeChartBtn" style="display:none;">‚ñ∂Ô∏è Wznow</button>
                <button id="cursorABBtn">üìè Kursory A/B</button>
                <button id="exportCsvBtn">üìÑ Eksport CSV</button>
                <button id="exportRangeCsvBtn" title="Zaznacz zakres trzymajƒÖc Shift i przeciƒÖgajƒÖc myszkƒÖ">üìä Eksport CSV (Zakres)</button>
                <button id="resetZoomBtn">üîç Reset Widoku</button>
                <button id="exportPngBtn">üñºÔ∏è Eksport PNG</button>
            </div>
            <div class="chart-cursor-info" id="cursorInfo" style="display:none;">
                <div><strong>Kursor A:</strong> X: <span id="cursorAX">---</span>, Y: <span id="cursorAY">---</span></div>
                <div><strong>Kursor B:</strong> X: <span id="cursorBX">---</span>, Y: <span id="cursorBY">---</span></div>
                <div><strong>Œît:</strong> <span id="cursorDeltaT">---</span></div>
                <div><strong>Œîy (Pitch):</strong> <span id="cursorDeltaYPitch">---</span></div>
                <div><strong>Œîy (Speed):</strong> <span id="cursorDeltaYSpeed">---</span></div>
            </div>
            <div class="chart-controls" id="signalChartControls"></div>
        </div>
        
        <!-- NOWA KARTA: Nauka PID - Wizualizacja edukacyjna -->
        <div class="card" id="pid-education-card">
            <h2>üìö Nauka PID <span class="help-icon" id="pidEducationHelp">?</span></h2>
            <div id="pidEducationHelpText" class="help-text" style="margin-bottom: 12px;">
                <strong>Cel:</strong> Wizualizacja dzia≈Çania regulatora PID w czasie rzeczywistym.<br>
                <strong>Sk≈Çadowa P (Proporcjonalna):</strong> Reaguje na aktualny b≈ÇƒÖd - im wiƒôksze odchylenie, tym silniejsza reakcja.<br>
                <strong>Sk≈Çadowa I (Ca≈ÇkujƒÖca):</strong> Sumuje b≈Çƒôdy w czasie - eliminuje sta≈Çe odchylenie od celu.<br>
                <strong>Sk≈Çadowa D (R√≥≈ºniczkujƒÖca):</strong> Reaguje na szybko≈õƒá zmian - dzia≈Ça jak hamulec, t≈Çumi oscylacje.<br>
                <strong>Tryb krokowy:</strong> Pozwala analizowaƒá pojedyncze iteracje PID krok po kroku.
            </div>
            
            <!-- Tryb pracy -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button id="pidEduLiveBtn" class="active" style="flex: 1; min-width: 120px;">üì° Na ≈ºywo</button>
                <button id="pidEduStepBtn" style="flex: 1; min-width: 120px;">‚èØÔ∏è Tryb krokowy</button>
                <button id="pidEduResetBtn" style="flex: 1; min-width: 100px; background: #f7b731;">üîÑ Reset</button>
            </div>
            
            <!-- Panel trybu krokowego (domy≈õlnie ukryty) -->
            <div id="pidStepModePanel" style="display: none; background: #1a1d24; border: 1px solid #61dafb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 12px 0; color: #61dafb;">‚èØÔ∏è Analiza krok po kroku</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                    <div class="step-info-box">
                        <div class="step-label">Warto≈õƒá zadana (Setpoint)</div>
                        <div class="step-value" id="stepSetpoint">0.00¬∞</div>
                    </div>
                    <div class="step-info-box">
                        <div class="step-label">Warto≈õƒá aktualna (Input)</div>
                        <div class="step-value" id="stepInput">0.00¬∞</div>
                    </div>
                    <div class="step-info-box">
                        <div class="step-label">B≈ÇƒÖd (Error)</div>
                        <div class="step-value" id="stepError" style="color: #ff6b6b;">0.00¬∞</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                    <div class="step-component-box" style="border-color: #e74c3c;">
                        <div class="component-header" style="background: #e74c3c;">P (Proporcjonalna)</div>
                        <div class="component-formula">Kp √ó Error</div>
                        <div class="component-calc"><span id="stepKp">0.00</span> √ó <span id="stepErrorP">0.00</span></div>
                        <div class="component-result" id="stepPOut">= 0.00</div>
                    </div>
                    <div class="step-component-box" style="border-color: #27ae60;">
                        <div class="component-header" style="background: #27ae60;">I (Ca≈ÇkujƒÖca)</div>
                        <div class="component-formula">Ki √ó ‚à´Error dt</div>
                        <div class="component-calc"><span id="stepKi">0.00</span> √ó <span id="stepIntegral">0.00</span></div>
                        <div class="component-result" id="stepIOut">= 0.00</div>
                    </div>
                    <div class="step-component-box" style="border-color: #3498db;">
                        <div class="component-header" style="background: #3498db;">D (R√≥≈ºniczkujƒÖca)</div>
                        <div class="component-formula">Kd √ó dError/dt</div>
                        <div class="component-calc"><span id="stepKd">0.00</span> √ó <span id="stepDerivative">0.00</span></div>
                        <div class="component-result" id="stepDOut">= 0.00</div>
                    </div>
                </div>
                
                <div class="step-sum-box">
                    <span>Suma: P + I + D = </span>
                    <span id="stepPVal" style="color: #e74c3c;">0.00</span> + 
                    <span id="stepIVal" style="color: #27ae60;">0.00</span> + 
                    <span id="stepDVal" style="color: #3498db;">0.00</span> = 
                    <strong id="stepOutput" style="color: #f1c40f; font-size: 1.2em;">0.00</strong>
                    <span style="color: #888;"> ‚Üí PWM</span>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="stepPrevBtn" style="flex: 1;">‚èÆÔ∏è Poprzedni</button>
                    <button id="stepCaptureBtn" style="flex: 2; background: #61dafb;">üì∏ Zapisz krok</button>
                    <button id="stepNextBtn" style="flex: 1;">Nastƒôpny ‚è≠Ô∏è</button>
                </div>
                <div style="margin-top: 10px; font-size: 0.85em; color: #888;">
                    Krok: <span id="stepCounter">0</span> / <span id="stepTotal">0</span>
                </div>
            </div>
            
            <!-- Wykres sk≈Çadowych PID -->
            <div style="margin-bottom: 10px;">
                <strong>Wykres sk≈Çadowych PID:</strong>
                <div style="display: flex; gap: 15px; margin-top: 8px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showPComponent" checked>
                        <span style="color: #e74c3c;">‚ñ†</span> P (Proporcjonalna)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showIComponent" checked>
                        <span style="color: #27ae60;">‚ñ†</span> I (Ca≈ÇkujƒÖca)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showDComponent" checked>
                        <span style="color: #3498db;">‚ñ†</span> D (R√≥≈ºniczkujƒÖca)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showPIDSum" checked>
                        <span style="color: #f1c40f;">‚ñ†</span> Suma (Output)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="showPIDError">
                        <span style="color: #9b59b6;">‚ñ†</span> B≈ÇƒÖd
                    </label>
                </div>
            </div>
            <div style="position: relative; height: 250px; background: #101014; border: 1px solid #2a2a35; border-radius: 6px;">
                <canvas id="pidComponentsChart"></canvas>
            </div>
            
            <!-- Aktualne warto≈õci -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                <div class="pid-live-box" style="border-left: 3px solid #e74c3c;">
                    <div class="pid-live-label">P (Kp √ó e)</div>
                    <div class="pid-live-value" id="liveP">0.00</div>
                </div>
                <div class="pid-live-box" style="border-left: 3px solid #27ae60;">
                    <div class="pid-live-label">I (Ki √ó ‚à´e)</div>
                    <div class="pid-live-value" id="liveI">0.00</div>
                </div>
                <div class="pid-live-box" style="border-left: 3px solid #3498db;">
                    <div class="pid-live-label">D (Kd √ó de/dt)</div>
                    <div class="pid-live-value" id="liveD">0.00</div>
                </div>
                <div class="pid-live-box" style="border-left: 3px solid #f1c40f;">
                    <div class="pid-live-label">Output (PWM)</div>
                    <div class="pid-live-value" id="liveOutput">0.00</div>
                </div>
            </div>
            
            <!-- Wskaz√≥wki edukacyjne -->
            <div id="pidEducationTips" style="margin-top: 15px; padding: 12px; background: #20232a; border-radius: 6px; font-size: 0.9em;">
                <strong style="color: #61dafb;">üí° Wskaz√≥wka:</strong>
                <span id="pidTipText">Obserwuj, jak zmienia siƒô ka≈ºda sk≈Çadowa podczas ruchu robota. Sk≈Çadowa P reaguje natychmiast na odchylenie, I ro≈õnie powoli przy sta≈Çym b≈Çƒôdzie, a D hamuje szybkie zmiany.</span>
            </div>
        </div>
        
        <div class="card">
             <button class="accordion-header" onclick="toggleAccordion(this)">Sterowanie Autonomiczne</button>
            <div class="accordion-content">
               <fieldset>
                   <legend>Sterowanie Precyzyjne (D-Pad)</legend>
                   <div class="dpad-input-group"><label for="dpadDistInput">Dystans (cm):</label><input type="number" id="dpadDistInput" value="20"></div>
                   <div class="dpad-input-group"><label for="dpadAngleInput">Kat (st.):</label><input type="number" id="dpadAngleInput" value="90"></div>
                   <div class="dpad-container">
                       <button id="dpad-up" class="dpad-btn" data-dpad="up">&#8593;</button><button id="dpad-left" class="dpad-btn" data-dpad="left">&#8592;</button><button id="dpad-stop" class="dpad-btn" data-dpad="stop">&#215;</button><button id="dpad-right" class="dpad-btn" data-dpad="right">&#8594;</button><button id="dpad-down" class="dpad-btn" data-dpad="down">&#8595;</button>
                   </div>
               </fieldset>
               <fieldset style="margin-top: 15px;">
                   <legend>Kreator Sekwencji Ruchow</legend>
                   <div id="sequence-list"></div>
                   <button id="add-sequence-step-btn" style="width:100%; margin: 10px 0;">Dodaj Krok</button>
                   <div style="display:flex; gap:10px; justify-content:center;">
                       <button id="run-sequence-btn" style="background-color: #a2f279;">Uruchom</button><button id="stop-sequence-btn" style="background-color: #ff6347;" disabled>Zatrzymaj</button><button id="clear-sequence-btn" style="background-color: #f7b731;">Wyczysc</button>
                   </div>
                   <h4 style="color: #61dafb; margin-top: 20px; margin-bottom: 10px;">Wizualizacja Sciezki (2D)</h4>
                   <div id="path-visualization-container">
                       <canvas id="pathCanvas"></canvas>
                       <div class="path-legend">
                           <div><span class="color-box planned"></span> Planowana</div>
                           <div><span class="color-box actual"></span> Rzeczywista</div>
                       </div>
                   </div>
                   <div id="sequence-report-panel" class="sequence-report-panel">
                       <h4>Raport Sekwencji</h4>
                       <div class="sequence-report-metrics" id="sequenceReportMetrics">
                           <div><strong>Sredni Blad Kursu:</strong> <span id="avgHeadingError">---</span></div>
                           <div><strong>Max Blad Kursu:</strong> <span id="maxHeadingError">---</span></div>
                           <div><strong>Pokonany Dystans:</strong> <span id="totalDistanceCovered">---</span></div>
                       </div>
                       <button id="resetSequenceReportBtn" style="width: 100%; margin-top: 15px;">Wyczysc Raport</button>
                   </div>
               </fieldset>
           </div>
        </div>
        <div class="card">
            <h2>Konfiguracja</h2>
            <fieldset>
                <legend>Profile Ustawien (Snapshots)</legend>
                <div class="profile-controls"> <select id="pidPresetSelect" style="width: 100%; padding: 5px;"></select> </div>
                <div class="preset-actions">
                    <button id="applySelectedPresetBtn">Zastosuj</button>
                    <button id="saveCurrentAsPresetBtn">Zapisz jako Nowy</button>
                </div>
                <button id="deleteSelectedPresetBtn" style="width:100%; margin-top: 10px; background-color: #ff6347;">Usun Wybrany</button>
                <!-- Przyciski przeniesione na d√≥≈Ç, pod wszystkimi akordeonami -->
            </fieldset>
            <div id="allSettings">
                <button class="accordion-header" onclick="toggleAccordion(this)">1. Filtr Mahony i Predykcja <span id="fusionModeIndicator" class="fusion-indicator fusion-mahony">‚ö° Mahony (~500Hz)</span></button>
                <div class="accordion-content">
                    <!-- ===== SEKCJA EDUKACYJNA: Tryby fuzji IMU ===== -->
                    <div class="fusion-info-box" style="background: linear-gradient(135deg, #1a2a3a 0%, #1a1d24 100%); border: 1px solid #4fc3f7; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <h5 style="color: #4fc3f7; margin: 0 0 8px 0; font-size: 0.95em;">üìö Wyb√≥r trybu fuzji IMU (WA≈ªNE!)</h5>
                        <p style="color: #aaa; font-size: 0.85em; margin: 0 0 8px 0;">
                            <strong>Mahony (~500Hz):</strong> W≈Çasna fuzja - szybsza reakcja, mniejsze op√≥≈∫nienie.<br>
                            <strong>NDOF (~100Hz):</strong> Wbudowana w BNO055 - stabilniejsza, automatyczna kalibracja.
                        </p>
                        <p style="color: #f7b731; font-size: 0.85em; margin: 0;">
                            ‚ö†Ô∏è <strong>Ka≈ºdy tryb wymaga INNYCH warto≈õci PID!</strong> System automatycznie prze≈ÇƒÖcza profile.
                        </p>
                    </div>
                    
                    <div class="setting-container"> <label for="mahonyKpInput">Kp (Proporcjonalny)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="mahonyKpInput" min="0" max="10" step="0.1" value="1.0"><button>+</button></div> <div class="help-text">Proporcjonalne wzmocnienie filtru Mahony - szybko≈õƒá korekty orientacji z akcelerometru. Wy≈ºsza warto≈õƒá = szybsza konwergencja do prawid≈Çowej orientacji, ale wiƒôksza wra≈ºliwo≈õƒá na przyspieszenia. Typowy zakres: 0.5-2.0.</div> </div>
                    <div class="setting-container"> <label for="mahonyKiInput">Ki (Ca≈ÇkujƒÖcy)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="mahonyKiInput" min="0" max="1" step="0.01" value="0.05"><button>+</button></div> <div class="help-text">Ca≈ÇkujƒÖce wzmocnienie - kompensuje dryf ≈ºyroskopu. Wy≈ºsza warto≈õƒá = lepsza korekta dryfu, ale wolniejsza odpowied≈∫. Kluczowy parametr dla stabilno≈õci d≈Çugoterminowej robota balansujƒÖcego. Typowy zakres: 0.01-0.1.</div> </div>
                    <div class="setting-container"> <label for="useMahonyFilterInput">U≈ºyj w≈Çasnej fuzji IMU<span class="help-icon">?</span></label> <input type="checkbox" class="config-value" id="useMahonyFilterInput" checked> <div class="help-text">W≈ÇƒÖcz w≈ÇasnƒÖ fuzjƒô danych IMU z filtrem Mahony zamiast wbudowanej w BNO055. Filtr Mahony jest optymalny dla robot√≥w balansujƒÖcych dziƒôki wbudowanej kompensacji dryfu ≈ºyroskopu i ni≈ºszemu op√≥≈∫nieniu.</div> </div>
                    
                    <!-- ===== AUTOMATYCZNE PRZE≈ÅƒÑCZANIE PROFILI PID ===== -->
                    <hr style="border-color: #4a4f58; margin: 15px 0;">
                    <div class="fusion-profiles-section" style="background: #20232a; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <h5 style="color: #61dafb; margin: 0 0 10px 0; font-size: 0.9em;">üîÑ Profile PID dla tryb√≥w fuzji</h5>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="checkbox" id="fusionAutoSwitchToggle" checked style="width: 18px; height: 18px;">
                            <label for="fusionAutoSwitchToggle" style="color: #aaa; font-size: 0.85em;">Automatycznie prze≈ÇƒÖczaj PID przy zmianie fuzji</label>
                        </div>
                        <p style="color: #666; font-size: 0.8em; margin: 8px 0 0 0;">
                            ÔøΩ Po zmianie trybu fuzji, warto≈õci PID dla wszystkich pƒôtli zostanƒÖ automatycznie wczytane z zapisanego profilu.
                            Profile zapisujƒÖ siƒô razem z przyciskiem "Zapisz na Robocie".
                        </p>
                    </div>
                    
                    <hr style="border-color: #4a4f58; margin: 15px 0;">
                    <h4 style="color: #4fc3f7; margin-bottom: 10px;">Predykcja kƒÖta (Stabilno≈õƒá)</h4>
                    <div class="setting-container"> <label for="predictionModeInput">Tryb predykcji<span class="help-icon">?</span></label> <select class="config-value" id="predictionModeInput"><option value="0">Wy≈ÇƒÖczony (aktualny kƒÖt)</option><option value="1" selected>Prosta (Œ∏ + œâ¬∑Œît)</option><option value="2">Kwadratowa (Œ∏ + œâ¬∑Œît + ¬ΩŒ±¬∑Œît¬≤)</option></select> <div class="help-text">Predykcja kompensuje op√≥≈∫nienia systemowe poprzez przewidywanie przysz≈Çego kƒÖta. <strong>Wy≈ÇƒÖczony:</strong> reakcja na aktualny kƒÖt - standardowe zachowanie. <strong>Prosta:</strong> uwzglƒôdnia prƒôdko≈õƒá kƒÖtowƒÖ - zalecany tryb. <strong>Kwadratowa:</strong> uwzglƒôdnia te≈º przyspieszenie kƒÖtowe - mo≈ºe byƒá niestabilna.</div> </div>
                    <div class="setting-container"> <label for="predictionTimeMsInput">Horyzont predykcji (ms)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="predictionTimeMsInput" min="0" max="50" step="1" value="20"><button>+</button></div> <div class="help-text">Jak daleko w przysz≈Ço≈õƒá przewidywaƒá kƒÖt (w milisekundach). Wy≈ºsza warto≈õƒá = wiƒôksza kompensacja op√≥≈∫nie≈Ñ, ale ryzyko przeregulowania. Typowy zakres: 10-30 ms. 0 = wy≈ÇƒÖczone.</div> </div>
                </div>
                <button class="accordion-header" onclick="toggleAccordion(this)">2. Parametry Sprzetowe i Mechaniczne</button>
                <div class="accordion-content">
                    <!-- Usuniƒôto legacy mapowanie osi IMU ‚Äì zastƒÖpione nowym kreatorem 'Mapowanie czujnika' w Dashboard -->
                    <div class="setting-container"> <label for="wheelDiameterInput">Srednica kola (cm)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="wheelDiameterInput" min="1" max="30" step="0.1" value="8.2"><button>+</button></div> <div class="help-text">≈örednica ko≈Ça robota w centymetrach. Parametr kluczowy dla obliczania prƒôdko≈õci i pokonanego dystansu. Zmierz dok≈Çadnie ≈õrednicƒô od krawƒôdzi do krawƒôdzi przez ≈õrodek ko≈Ça. Wiƒôksze ko≈Ça = wiƒôksza prƒôdko≈õƒá przy tych samych obrotach silnika. Typowy zakres: 6-12 cm.</div> </div>
                    <div class="setting-container"> <label for="trackWidthInput">Rozstaw kol (cm)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="trackWidthInput" min="5" max="50" step="0.1" value="12.5"><button>+</button></div> <div class="help-text">Odleg≈Ço≈õƒá miƒôdzy ≈õrodkami obu k√≥≈Ç (szeroko≈õƒá toru). Wp≈Çywa na obliczenia obrotu - szerszy rozstaw wymaga wiƒôkszej r√≥≈ºnicy prƒôdko≈õci k√≥≈Ç do wykonania tego samego skrƒôtu. Zmierz odleg≈Ço≈õƒá miƒôdzy ≈õrodkami osi k√≥≈Ç. Typowy zakres: 10-20 cm.</div> </div>
                    <div class="setting-container"> <label for="encoderPprInput">Impulsy na obrot (PPR)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="encoderPprInput" min="100" max="5000" step="10" value="820"><button>+</button></div> <div class="help-text">Liczba impuls√≥w enkodera na jeden pe≈Çny obr√≥t ko≈Ça. Zale≈ºy od rozdzielczo≈õci enkodera i przek≈Çadni (je≈õli jest). Warto≈õƒá ta wp≈Çywa na dok≈Çadno≈õƒá pomiaru prƒôdko≈õci i pozycji. Wy≈ºsza warto≈õƒá = wiƒôksza precyzja. Sprawd≈∫ specyfikacjƒô swojego enkodera i przek≈Çadni. Typowy zakres: 300-2000 PPR.</div> </div>
                </div>
                <button class="accordion-header" onclick="toggleAccordion(this)">3. Kalibracja PWM Silnikow</button>
                <div class="accordion-content">
                    <div class="pwm-info"> <strong>Info:</strong> Uzyj przycisku <strong>"Auto"</strong>, aby automatycznie znalezc prog startowy silnika, lub <strong>"Testuj"</strong>, aby sprawdzic recznie wpisana wartosc. <strong>Wazne:</strong> Przed testem podnies robota, aby kola mogly sie swobodnie krecic! </div>
                    <div class="setting-container"> <label for="pwmTuneStartInput">Rozpocznij auto-szukanie od PWM</label> <div class="numeric-input-wrapper"> <button id="pwmTuneStartMinus">-</button> <input type="number" id="pwmTuneStartInput" min="1" max="2047" step="1" value="1200"> <button id="pwmTuneStartPlus">+</button> </div> </div> <hr style="border-color: #4a4f58; margin: 15px 0;">
                    <div class="manual-tune-row" data-motor="left" data-direction="fwd"> <div class="pwm-input-row"> <label>Lewy (Przod)</label> <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmLeftFwdInput" min="0" max="2047" step="1" value="1200"><button>+</button></div> </div> <div class="pwm-button-row"> <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button></div> </div>
                    <div class="manual-tune-row" data-motor="left" data-direction="bwd"> <div class="pwm-input-row"> <label>Lewy (Tyl)</label> <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmLeftBwdInput" min="0" max="2047" step="1" value="1200"><button>+</button></div> </div> <div class="pwm-button-row"> <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button></div> </div>
                    <div class="manual-tune-row" data-motor="right" data-direction="fwd"> <div class="pwm-input-row"> <label>Prawy (Przod)</label> <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmRightFwdInput" min="0" max="2047" step="1" value="1200"><button>+</button></div> </div> <div class="pwm-button-row"> <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button></div> </div>
                    <div class="manual-tune-row" data-motor="right" data-direction="bwd"> <div class="pwm-input-row"> <label>Prawy (Tyl)</label> <div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmRightBwdInput" min="0" max="2047" step="1" value="1200"><button>+</button></div> </div> <div class="pwm-button-row"> <button class="test-btn">Testuj</button><button class="stop-btn">Stop</button><button class="auto-btn">Auto</button></div> </div>
                    <button id="manualTuneStopAll" style="width:100%; margin-top:15px; background-color:#ff6347;">ZATRZYMAJ WSZYSTKIE SILNIKI</button>
                </div>
                <button class="accordion-header" onclick="toggleAccordion(this)">4. PID Balansu (Podstawowy) <span class="sign-badge" id="balanceSignBadge">B:+</span></button>
                <div class="accordion-content">
                    <div class="setting-container"> <label for="balanceKpInput">Kp - Sila<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="balanceKpInput" min="0" max="500" step="0.1" value="95"><button>+</button></div> <div class="help-text"><strong>Proporcjonalny (Kp):</strong> Okre≈õla, jak mocno robot reaguje na odchylenie od pionu. Wy≈ºsza warto≈õƒá = sztywniejsze utrzymanie r√≥wnowagi, szybsza reakcja na zak≈Ç√≥cenia. Zbyt wysoka warto≈õƒá powoduje szybkie oscylacje (robot "dr≈ºy"). Zbyt niska = robot reaguje za wolno i mo≈ºe upa≈õƒá. Zacznij od 80-120 i dostosuj stopniowo. Typowy zakres: 60-150.</div> </div>
                    <div class="setting-container"> <label for="balanceKiInput">Ki - Korekta<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="balanceKiInput" min="0" max="10" step="0.01" value="0.0"><button>+</button></div> <div class="help-text"><strong>Ca≈ÇkujƒÖcy (Ki):</strong> Eliminuje d≈Çugotrwa≈Çy, sta≈Çy b≈ÇƒÖd (np. gdy robot powoli dryfuje w jednym kierunku mimo pionowego stania). Czƒôsto nie jest potrzebny dla balansu - zacznij od 0. Je≈õli robot ma tendencjƒô do dryfowania, zwiƒôkszaj bardzo ostro≈ºnie (np. 0.05-0.2). Zbyt wysoka warto≈õƒá powoduje niestabilno≈õƒá i oscylacje. Typowy zakres: 0-0.5.</div> </div>
                    <div class="setting-container"> <label for="balanceKdInput">Kd - Tlumienie<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="balanceKdInput" min="0" max="50" step="0.01" value="3.23"><button>+</button></div> <div class="help-text"><strong>R√≥≈ºniczkujƒÖcy (Kd):</strong> Dzia≈Ça jak amortyzator - przeciwdzia≈Ça szybkim zmianom kƒÖta, hamuje oscylacje i wyg≈Çadza ruch. Wy≈ºsza warto≈õƒá = bardziej uspokojony, stabilny robot, ale wolniejsza reakcja. Zbyt wysoka warto≈õƒá powoduje "leniwy" ruch i s≈ÇabƒÖ reakcjƒô na zak≈Ç√≥cenia. Zbyt niska = robot jest nerwowy i dr≈ºy. Typowy zakres: 2-8.</div> </div>
                    <div class="setting-container"> <label for="balanceFilterAlphaInput">Filtr Pochodnej (%)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="balanceFilterAlphaInput" min="1" max="100" step="1" value="100"><button>+</button></div> <div class="help-text">Wyg≈Çadza sygna≈Ç r√≥≈ºniczkujƒÖcy (Kd), redukujƒÖc wp≈Çyw szum√≥w z czujnika. 100% = brak filtrowania (pe≈Çna responsywno≈õƒá, ale mo≈ºe byƒá szum). Zmniejsz do 50-80%, je≈õli robot jest nerwowy lub "dr≈ºy" mimo niskiego Kd. Ni≈ºsza warto≈õƒá = p≈Çynniejszy ruch, ale wolniejsza reakcja. Typowy zakres: 70-100%.</div> </div>
                    <div class="setting-container"> <label for="balanceIntegralLimitInput">Limit Integratora<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="balanceIntegralLimitInput" min="0" max="200" step="1" value="50"><button>+</button></div> <div class="help-text">Maksymalna warto≈õƒá, jakƒÖ mo≈ºe osiƒÖgnƒÖƒá suma ca≈ÇkujƒÖca (Ki). Zapobiega "rozregulowaniu" integratora przy du≈ºych, d≈Çugotrwa≈Çych b≈Çƒôdach. Je≈õli u≈ºywasz Ki, ustaw limit na 30-100. Je≈õli Ki=0, ten parametr nie ma wp≈Çywu. Typowy zakres: 30-100.</div> </div>
                    <div class="model-mapping-row" style="margin-top:6px;"><label>Znak sprzƒô≈ºenia (Balans)</label><div id="balanceSign" class="sign-toggle"><button data-sign="-1">-</button><button data-sign="1">+</button></div><div class="help-text" style="margin-top:8px;">Odwr√≥ƒá znak sprzƒô≈ºenia pƒôtli balansu (zmiana mo≈ºliwa tylko w trybie IDLE)</div></div>
                </div>
                <button class="accordion-header" onclick="toggleAccordion(this)">5. PID Kaskadowy (Predkosc/Pozycja)</button>
                <div class="accordion-content">
                    <div class="parameter-group"><h5>PID Predkosci <span class="sign-badge" id="speedSignBadge">S:+</span></h5>
                        <div class="setting-container"> <label for="speedKpInput">Kp - Reakcja<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="speedKpInput" min="0" max="10" step="0.01" value="0.0"><button>+</button></div> <div class="help-text">Kontroluje, jak mocno robot pochyla siƒô, aby osiƒÖgnƒÖƒá zadanƒÖ prƒôdko≈õƒá. Wy≈ºsza warto≈õƒá = szybsze przyspieszanie/zwalnianie, ale mo≈ºe powodowaƒá oscylacje prƒôdko≈õci. Zacznij od ma≈Çych warto≈õci (0.1-0.5) i zwiƒôkszaj stopniowo. Typowy zakres: 0.1-2.0.</div> </div>
                        <div class="setting-container"> <label for="speedKiInput">Ki - Eliminacja bledu<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="speedKiInput" min="0" max="1" step="0.001" value="0.0"><button>+</button></div> <div class="help-text">Eliminuje sta≈Çy b≈ÇƒÖd prƒôdko≈õci (gdy robot jedzie ciƒÖgle trochƒô wolniej/szybciej ni≈º powinien). Czƒôsto wystarczy 0, ale je≈õli prƒôdko≈õƒá nie osiƒÖga docelowej warto≈õci, dodaj ma≈ÇƒÖ warto≈õƒá Ki (0.01-0.1). Zbyt wysoka warto≈õƒá powoduje oscylacje. Typowy zakres: 0-0.2.</div> </div>
                        <div class="setting-container"> <label for="speedKdInput">Kd - Tlumienie<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="speedKdInput" min="0" max="5" step="0.001" value="0.0"><button>+</button></div> <div class="help-text">Wyg≈Çadza zmiany prƒôdko≈õci, przeciwdzia≈Ça oscylacjom. Pomaga, gdy robot "skacze" miƒôdzy r√≥≈ºnymi prƒôdko≈õciami. Zacznij od 0, dodaj (0.01-0.1) je≈õli prƒôdko≈õƒá oscyluje. Zbyt wysoka warto≈õƒá spowalnia reakcjƒô na zmiany. Typowy zakres: 0-0.5.</div> </div>
                        <div class="setting-container"> <label for="maxTargetAngleInput">Max. kat z PID Predk. (st.)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="maxTargetAngleInput" min="1" max="45" step="0.5" value="15.0"><button>+</button></div> <div class="help-text">Maksymalny kƒÖt, jaki PID prƒôdko≈õci mo≈ºe zadaƒá robotowi, aby osiƒÖgnƒÖƒá docelowƒÖ prƒôdko≈õƒá. Limit bezpiecze≈Ñstwa - zapobiega zbyt du≈ºemu pochyleniu. Wiƒôksza warto≈õƒá = szybsze przyspieszanie, ale wiƒôksze ryzyko upadku. Typowy zakres: 10-20¬∞.</div> </div>
                        <div class="setting-container"> <label for="speedDeadbandInput">Strefa martwa (imp/s)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="speedDeadbandInput" min="0" max="50" step="1" value="5"><button>+</button></div> <div class="help-text">Je≈õli rzeczywista prƒôdko≈õƒá r√≥≈ºni siƒô od zadanej o mniej ni≈º ta warto≈õƒá, PID nie reaguje. Zapobiega ciƒÖg≈Çym mikro-korektom przy ma≈Çych b≈Çƒôdach, oszczƒôdza energiƒô i zmniejsza drgania. Typowy zakres: 3-15 imp/s.</div> </div>
                        <div class="setting-container"> <label for="speedIntegralLimitInput">Limit Integratora<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="speedIntegralLimitInput" min="0" max="100" step="1" value="20"><button>+</button></div> <div class="help-text">Maksymalna warto≈õƒá sumy ca≈ÇkujƒÖcej (Ki). Zapobiega "wind-up" (rozregulowaniu) integratora. Istotne tylko gdy u≈ºywasz Ki > 0. Typowy zakres: 10-50.</div> </div>
                        <div class="model-mapping-row" style="margin-top:6px;"><label>Znak sprzƒô≈ºenia (Prƒôdko≈õƒá)</label><div id="speedSign" class="sign-toggle"><button data-sign="-1">-</button><button data-sign="1">+</button></div><div class="help-text" style="margin-top:8px;">Odwr√≥ƒá znak sprzƒô≈ºenia pƒôtli prƒôdko≈õci (zmiana mo≈ºliwa tylko w trybie IDLE)</div></div>
                        <div class="setting-container"> <label for="speedFilterAlphaInput">Filtr Pochodnej (%)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="speedFilterAlphaInput" min="1" max="100" step="1" value="80"><button>+</button></div> <div class="help-text">Wyg≈Çadza sygna≈Ç r√≥≈ºniczkujƒÖcy (Kd). 100% = brak filtrowania. Zmniejsz, je≈õli Kd wprowadza nerwowo≈õƒá. Typowy zakres: 60-90%.</div> </div>
                    </div>
                    <div class="parameter-group"><h5>PID Pozycji <span class="sign-badge" id="positionSignBadge">P:+</span></h5>
                        <div class="setting-container"> <label for="positionKpInput">Kp - Sila powrotu<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="positionKpInput" min="0" max="20" step="0.1" value="0.0"><button>+</button></div> <div class="help-text">Kontroluje, jak mocno robot dƒÖ≈ºy do powrotu do zadanej pozycji (funkcja "trzymaj pozycjƒô"). Wy≈ºsza warto≈õƒá = silniejsza korekta, szybszy powr√≥t. Zbyt wysoka powoduje oscylacje wok√≥≈Ç pozycji docelowej. Zacznij od 0.5-2.0. Typowy zakres: 0.5-5.0.</div> </div>
                        <div class="setting-container"> <label for="positionKiInput">Ki - Korekta<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="positionKiInput" min="0" max="1" step="0.001" value="0.0"><button>+</button></div> <div class="help-text">Usuwa sta≈Çe odchylenie od pozycji (gdy robot powoli "dryfuje" mimo w≈ÇƒÖczonej funkcji trzymania pozycji). Czƒôsto nie jest potrzebny. Dodaj ma≈ÇƒÖ warto≈õƒá (0.001-0.01) tylko je≈õli robot systematycznie odje≈ºd≈ºa od pozycji. Typowy zakres: 0-0.05.</div> </div>
                        <div class="setting-container"> <label for="positionKdInput">Kd - Hamowanie<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="positionKdInput" min="0" max="10" step="0.05" value="0.0"><button>+</button></div> <div class="help-text">Hamuje ruch, gdy robot zbli≈ºa siƒô do pozycji docelowej - zapobiega "przestrzeleniu". Wy≈ºsza warto≈õƒá = p≈Çynniejsze, bardziej kontrolowane zatrzymanie, ale wolniejszy powr√≥t. Zacznij od 0.1-0.5. Typowy zakres: 0.1-2.0.</div> </div>
                        <div class="setting-container"> <label for="maxTargetSpeedInput">Max. predkosc z PID Poz. (imp/s)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="maxTargetSpeedInput" min="100" max="4000" step="50" value="1000"><button>+</button></div> <div class="help-text">Maksymalna prƒôdko≈õƒá, jakƒÖ PID pozycji mo≈ºe zadaƒá podczas powrotu do punktu. Limit bezpiecze≈Ñstwa - zapobiega zbyt szybkiemu ruchowi przy du≈ºych odchyleniach. Wy≈ºsza warto≈õƒá = szybszy powr√≥t, ale wiƒôksze ryzyko przesterowania. Typowy zakres: 500-1500 imp/s.</div> </div>
                        <div class="setting-container"> <label for="positionDeadbandInput">Margines bledu (imp.)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="positionDeadbandInput" min="0" max="100" step="1" value="15"><button>+</button></div> <div class="help-text">Je≈õli odchylenie od pozycji jest mniejsze ni≈º ta warto≈õƒá (w impulsach enkodera), PID pozycji nie reaguje. Robot "akceptuje" to ma≈Çe odchylenie i nie pr√≥buje go korygowaƒá. Zapobiega ciƒÖg≈Çym mikro-ruchom. Typowy zakres: 10-30 imp.</div> </div>
                        <div class="setting-container"> <label for="positionIntegralLimitInput">Limit Integratora<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="positionIntegralLimitInput" min="0" max="500" step="10" value="100"><button>+</button></div> <div class="help-text">Maksymalna warto≈õƒá sumy ca≈ÇkujƒÖcej (Ki). Zapobiega "wind-up" integratora. Istotne tylko gdy Ki > 0. Typowy zakres: 50-200.</div> </div>
                        <div class="model-mapping-row" style="margin-top:6px;"><label>Znak sprzƒô≈ºenia (Pozycja)</label><div id="positionSign" class="sign-toggle"><button data-sign="-1">-</button><button data-sign="1">+</button></div><div class="help-text" style="margin-top:8px;">Odwr√≥ƒá znak sprzƒô≈ºenia pƒôtli pozycji (zmiana mo≈ºliwa tylko w trybie IDLE)</div></div>
                        <div class="setting-container"> <label for="positionFilterAlphaInput">Filtr Pochodnej (%)<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="positionFilterAlphaInput" min="1" max="100" step="1" value="90"><button>+</button></div> <div class="help-text">Wyg≈Çadza sygna≈Ç r√≥≈ºniczkujƒÖcy (Kd). 100% = brak filtrowania. Zmniejsz do 70-90%, je≈õli hamowanie jest "szarpane". Typowy zakres: 70-95%.</div> </div>
                    </div>
                </div>
                <button class="accordion-header" onclick="toggleAccordion(this)">6. PID Obrotu i Kursu</button>
                <div class="accordion-content">
                    <div class="parameter-group"><h5>PID Obrotu (Autonomiczny)</h5>
                        <div class="setting-container"> <label for="rotationKpInput">Kp - Sila obrotu<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="rotationKpInput" min="0" max="50" step="0.1" value="0.0"><button>+</button></div> <div class="help-text">Kontroluje moc obrotu podczas automatycznego skrƒôtu o zadany kƒÖt. Wy≈ºsza warto≈õƒá = szybszy obr√≥t, ale ryzyko przesterowania (robot obraca siƒô za daleko). Zacznij od ma≈Çych warto≈õci (1-5) i zwiƒôkszaj stopniowo. Typowy zakres: 2-10.</div> </div>
                        <div class="setting-container"> <label for="rotationKdInput">Kd - Tlumienie<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="rotationKdInput" min="0" max="20" step="0.1" value="0.0"><button>+</button></div> <div class="help-text">Hamuje obr√≥t, gdy robot zbli≈ºa siƒô do docelowego kƒÖta. Zapobiega oscylacjom wok√≥≈Ç pozycji docelowej. Wy≈ºsza warto≈õƒá = p≈Çynniejsze, bardziej kontrolowane zatrzymanie. Zacznij od 0.5-2.0. Typowy zakres: 0.5-5.0.</div> </div>
                    </div>
                    <div class="parameter-group"><h5>PID Utrzymania Kursu (podczas jazdy prosto)</h5>
                        <div class="setting-container"> <label for="headingKpInput">Kp - Sila korekty<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="headingKpInput" min="0" max="10" step="0.05" value="0.0"><button>+</button></div> <div class="help-text">Kontroluje, jak mocno robot koryguje odchylenie od zadanego kursu podczas jazdy prosto. Wy≈ºsza warto≈õƒá = mocniejsza korekta, robot jedzie bardziej "po linii". Zbyt wysoka mo≈ºe powodowaƒá "zygzakowanie". Zacznij od 0.5-2.0. Typowy zakres: 0.5-5.0.</div> </div>
                        <div class="setting-container"> <label for="headingKiInput">Ki - Precyzja<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="headingKiInput" min="0" max="1" step="0.005" value="0.0"><button>+</button></div> <div class="help-text">Usuwa systematyczne odchylenie kursu (gdy robot powoli "skrƒôca" w jednƒÖ stronƒô mimo jazdy prosto). Dodaj ma≈ÇƒÖ warto≈õƒá (0.01-0.1) je≈õli robot ma tendencjƒô do odbijania w bok. Typowy zakres: 0-0.2.</div> </div>
                        <div class="setting-container"> <label for="headingKdInput">Kd - Tlumienie<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="headingKdInput" min="0" max="5" step="0.01" value="0.0"><button>+</button></div> <div class="help-text">Wyg≈Çadza korekty kursu, zapobiega "szarpaniu" przy zmianach kierunku. Przydatne je≈õli robot nerwowo koryguje kurs. Zacznij od 0.05-0.2. Typowy zakres: 0.05-0.5.</div> </div>
                        <div class="setting-container"> <label for="rotationToPwmScaleInput">Skala wyj≈õcia PID -> PWM<span class="help-icon">?</span></label> <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="rotationToPwmScaleInput" min="0" max="1" step="0.001" value="0.01"><button>+</button></div> <div class="help-text">Konwertuje wyj≈õcie PID obrotu/kursu na komponent skrƒôtu (PWM). Zwiƒôksz je≈õli korekty kierunku sƒÖ za s≈Çabe, zmniejsz je≈õli robot "przeostrza" lub oscyluje. Typowy zakres: 0.005 - 0.05.</div> </div>
                    </div>
                </div>
                
                <button class="accordion-header" onclick="toggleAccordion(this)">7. Zaawansowana Optymalizacja PID</button>
                <div class="accordion-content autotune-pane" id="autotuning-card-content">
                <div id="autotuning-config-panel">
                    <!-- G≈Ç√≥wne zak≈Çadki panelu -->
                    <div class="autotune-main-tabs">
                        <button class="autotune-main-tab active" data-tab="config">Konfiguracja Testu</button>
                        <button class="autotune-main-tab" data-tab="methods">Metody Optymalizacji</button>
                    </div>

                    <!-- Zak≈Çadka 1: Konfiguracja -->
                    <div class="autotune-main-content active" data-tab="config">
                        <div class="config-section">
                            <label for="tuning-loop-selector">üéØ Pƒôtla PID do strojenia:</label>
                            <select id="tuning-loop-selector" style="padding: 8px; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 4px;">
                                <option value="balance">Pƒôtla Balansu</option>
                                <option value="speed">Pƒôtla Prƒôdko≈õci</option>
                                <option value="position">Pƒôtla Pozycji</option>
                            </select>
                            <button id="open-fitness-modal-btn" style="margin-left: 8px; background:#61dafb; padding:6px 10px; border-radius:6px;">Konfiguruj Wagi</button>
                        </div>
                        <div class="config-section">
                            <h4>üîç Przestrze≈Ñ Przeszukiwania</h4>
                            <div class="search-space-grid">
                                <div class="search-space-param"><label for="search-kp-min">Kp Min:</label><input type="number" id="search-kp-min" value="40" step="0.1"></div>
                                <div class="search-space-param"><label for="search-kp-max">Kp Max:</label><input type="number" id="search-kp-max" value="50" step="0.1"></div>
                                <div class="search-space-param"><label for="search-ki-min">Ki Min:</label><input type="number" id="search-ki-min" value="0" step="0.01"></div>
                                <div class="search-space-param"><label for="search-ki-max">Ki Max:</label><input type="number" id="search-ki-max" value="0" step="0.01"></div>
                                <div class="search-space-param"><label for="search-kd-min">Kd Min:</label><input type="number" id="search-kd-min" value="0" step="0.01"></div>
                                <div class="search-space-param"><label for="search-kd-max">Kd Max:</label><input type="number" id="search-kd-max" value="5" step="0.01"></div>
                            </div>
                        </div>
                        <div class="config-section">
                            <h4>üß™ Parametry Testu</h4>
                            <div style="text-align: left; margin-bottom: 10px;"><label><input type="checkbox" id="test-with-impulse" checked> Test z impulsem (skok odpowiedzi)</label></div>
                            <div style="text-align: left;"><label><input type="checkbox" id="include-ki-checkbox"> Uwzglƒôdnij strojenie Ki</label></div>
                        </div>
                    </div>

                    <!-- Zak≈Çadka 2: Metody -->
                    <div class="autotune-main-content" data-tab="methods">
                        <div class="method-tabs">
                            <button class="method-tab active" data-method="ga">üß¨ Algorytm Genetyczny</button>
                            <button class="method-tab" data-method="pso">üåÄ PSO</button>
                            <button class="method-tab" data-method="bayesian">üß† Optymalizacja Bayesowska</button>
                        </div>
                        <div class="method-content active" data-method="ga">
                            <div class="method-config">
                                <div><label for="ga-population">Rozmiar populacji:</label><input type="number" id="ga-population" value="10" min="5" max="100"></div>
                                <div><label for="ga-generations">Liczba pokole≈Ñ:</label><input type="number" id="ga-generations" value="10" min="5" max="100"></div>
                                <div><label for="ga-mutation">Wska≈∫nik mutacji (%):</label><input type="number" id="ga-mutation" value="10" min="0" max="100" step="1"></div>
                                <div><label for="ga-crossover">Wska≈∫nik krzy≈ºowania (%):</label><input type="number" id="ga-crossover" value="70" min="0" max="100" step="1"></div>
                                <div style="justify-content: center;"><label><input type="checkbox" id="ga-elitism" checked> Elitaryzm</label></div>
                            </div>
                        </div>
                        <div class="method-content" data-method="pso">
                            <div class="method-config">
                                <div><label for="pso-particles">Liczba czƒÖstek:</label><input type="number" id="pso-particles" value="10" min="10" max="100"></div>
                                <div><label for="pso-iterations">Liczba iteracji:</label><input type="number" id="pso-iterations" value="10" min="10" max="100"></div>
                                <div><label for="pso-inertia">Waga bezw≈Çadno≈õci:</label><input type="number" id="pso-inertia" value="0.7" min="0" max="1" step="0.01"></div>
                                <div><label for="pso-cognitive">Waga poznawcza:</label><input type="number" id="pso-cognitive" value="1.5" min="0" max="3" step="0.1"></div>
                                <div><label for="pso-social">Waga spo≈Çeczna:</label><input type="number" id="pso-social" value="1.5" min="0" max="3" step="0.1"></div>
                            </div>
                        </div>
                        <div class="method-content" data-method="bayesian">
                            <div class="method-config">
                                <div><label for="bayesian-iterations">Liczba iteracji:</label><input type="number" id="bayesian-iterations" value="25" min="10" max="50"></div>
                                <div><label for="bayesian-initial">PoczƒÖtkowe pr√≥bki losowe:</label><input type="number" id="bayesian-initial" value="5" min="3" max="10"></div>
                                <div><label for="bayesian-acquisition">Funkcja akwizycji:</label>
                                    <select id="bayesian-acquisition" style="padding: 8px; background: #20232a; border: 1px solid #61dafb; border-radius: 4px; color: #ffffff;">
                                        <option value="ei">Expected Improvement (EI)</option>
                                        <option value="ucb">Upper Confidence Bound (UCB)</option>
                                        <option value="pi">Probability of Improvement (PI)</option>
                                    </select>
                                </div>
                                <div><label for="bayesian-xi">Parametr eksploracji (Œæ):</label><input type="number" id="bayesian-xi" value="0.01" min="0" max="1" step="0.01"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zak≈Çadka 3: Zbi√≥r Danych -->
                    
                </div>

                <!-- Panel Postƒôpu Strojenia (domy≈õlnie ukryty) -->
                <div id="tuning-progress-panel">
                    <h4>üìä Postƒôp Optymalizacji</h4>
                    <div class="progress-info">
                            <p>Status: <span id="tuning-status-text">Oczekuje</span></p>
                            <p>Iteracja: <span id="current-iteration">0</span> / <span id="total-iterations">0</span></p>
                            <p>Pokolenie: <span id="current-generation">0</span> / <span id="ga-gen-total">0</span></p>
                            <p>Osobnik: <span id="current-individual">0</span> / <span id="population-size">0</span></p>
                            <p>Parametry: Kp: <span id="current-kp">---</span> Ki: <span id="current-ki">---</span> Kd: <span id="current-kd">---</span></p>
                            <p>Fitness: <span id="current-fitness">---</span></p>
                        </div>
                            <div style="margin-top:8px;">
                                <canvas id="current-telemetry-chart" height="80" style="width:100%; background:#101014; border:1px solid #2a2a35; border-radius:6px;"></canvas>
                            </div>
                    <div id="fitness-chart-container"><canvas id="fitness-chart"></canvas></div>
                    <div class="current-best">
                        <h4>üèÜ Najlepsze Znalezione Parametry</h4>
                        <div class="current-best-grid">
                            <div><strong>Kp:</strong> <span id="best-kp">---</span></div>
                            <div><strong>Ki:</strong> <span id="best-ki">---</span></div>
                            <div><strong>Kd:</strong> <span id="best-kd">---</span></div>
                            <div style="grid-column: 1 / -1;"><strong>Fitness:</strong> <span id="best-fitness">---</span></div>
                        </div>
                        <button id="apply-best-btn" style="width:100%; margin-top:10px; background-color: #a2f279;" disabled>‚úÖ Zastosuj Najlepsze</button>
                    </div>
                    <div class="recent-results" style="margin-top: 15px; text-align: left;">
                        <h4>üïí Ostatnie 5 pr√≥b</h4>
                        <div id="recent-results-list" style="background:#20232a; border:1px solid #4a4f58; border-radius:6px; padding:8px; font-family: monospace; white-space: pre-wrap; min-height: 40px;">
                            Brak danych.
                        </div>
                        <button id="open-tuning-history-btn" class="btn-small" style="margin-top:10px;">üìú Historia i Eksport</button>
                    </div>
                </div>

                <!-- G≈Ç√≥wne Przyciski SterujƒÖce -->
                <div class="tuning-controls" id="tuning-controls-bar">
                    <button id="start-tuning-btn">üöÄ Rozpocznij Strojenie</button>
                    <button id="pause-tuning-btn" disabled>‚è∏Ô∏è Pauza</button>
                    <button id="resume-tuning-btn" style="display:none;" disabled>‚ñ∂Ô∏è Wzn√≥w</button>
                    <button id="stop-tuning-btn" disabled>‚èπÔ∏è Zatrzymaj</button>
                </div>
            </div>
        </div>
        
                <button class="accordion-header" onclick="toggleAccordion(this)">8. Identyfikacja Obiektu (System ID) <span id="sysidFusionIndicator" class="fusion-indicator fusion-mahony" style="font-size: 0.65em;">‚ö° Mahony</span></button>
                <div class="accordion-content" id="sysid-content">
                    <!-- Edukacyjne wprowadzenie do System ID -->
                    <div style="background: linear-gradient(135deg, #1a2a3a 0%, #1a1d24 100%); border: 1px solid #9b59b6; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <h5 style="color: #9b59b6; margin: 0 0 8px 0; font-size: 0.95em;">üìö Czym jest Identyfikacja Systemu?</h5>
                        <p style="color: #aaa; font-size: 0.85em; margin: 0 0 8px 0;">
                            System ID to technika in≈ºynieryjna polegajƒÖca na <strong>pomiarze rzeczywistej odpowiedzi systemu</strong> 
                            na znane pobudzenie (impuls, skok). Na podstawie przebiegu odpowiedzi mo≈ºna wyznaczyƒá 
                            optymalne parametry PID metodami matematycznymi.
                        </p>
                        <p style="color: #f7b731; font-size: 0.85em; margin: 0;">
                            ‚ö†Ô∏è <strong>Wa≈ºne:</strong> Wyniki sƒÖ specyficzne dla aktualnego trybu fuzji IMU! 
                            Zmiana Mahony‚ÜîNDOF wymaga nowej identyfikacji.
                        </p>
                    </div>
                    
                    <p style="color: #aaa; font-size: 0.9em; margin-bottom: 15px;">
                        üìä Nagraj odpowied≈∫ skokowƒÖ dla wybranej pƒôtli. 
                        Kliknij <strong style="color: #9b59b6;">üî¨ Analizuj</strong> aby obliczyƒá optymalne PID bezpo≈õrednio w przeglƒÖdarce,
                        lub eksportuj dane do Python/MATLAB.
                    </p>
                    
                    <div class="setting-container">
                        <label for="sysid-test-type">Typ testu<span class="help-icon">?</span></label>
                        <select id="sysid-test-type" class="config-value" style="width: 100%; padding: 8px; background: #20232a; border: 1px solid #61dafb; border-radius: 4px; color: #fff;">
                            <option value="balance" selected>üîÑ Pƒôtla balansu (kƒÖt)</option>
                            <option value="speed">‚ö° Pƒôtla prƒôdko≈õci</option>
                            <option value="position">üìç Pƒôtla pozycji</option>
                        </select>
                        <div class="help-text">
                            <b>Balans:</b> Impuls joysticka, mierzy odpowied≈∫ kƒÖta (500Hz).<br>
                            <b>Prƒôdko≈õƒá:</b> Skok setpointu prƒôdko≈õci, mierzy odpowied≈∫ speed (250Hz).<br>
                            <b>Pozycja:</b> Skok setpointu pozycji, mierzy odpowied≈∫ pozycji (125Hz).
                        </div>
                    </div>
                    
                    <div class="setting-container" id="sysid-kp-container">
                        <label for="sysid-kp">Kp (tylko proporcjonalny)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="sysid-kp" min="1" max="200" step="1" value="50"><button>+</button></div>
                        <div class="help-text">Warto≈õƒá wzmocnienia proporcjonalnego u≈ºywana podczas testu balansu. Ki i Kd bƒôdƒÖ ustawione na 0.</div>
                    </div>
                    <div class="setting-container">
                        <label for="sysid-duration">Czas nagrywania (s)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="sysid-duration" min="2" max="30" step="1" value="5"><button>+</button></div>
                        <div class="help-text">Ca≈Çkowity czas nagrywania odpowiedzi skokowej. Skok/impuls zostanie zastosowany 1s po starcie.</div>
                    </div>
                    <div class="setting-container" id="sysid-impulse-container">
                        <label for="sysid-impulse">Impuls joysticka (%)<span class="help-icon">?</span></label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="numeric-input-wrapper" style="flex: 1;"><button>-</button><input type="number" class="config-value" id="sysid-impulse" min="5" max="100" step="5" value="25"><button>+</button></div>
                            <button id="sysid-test-impulse-btn" style="padding: 8px 12px; background: #f7b731; color: #000; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; white-space: nowrap;" title="Jednorazowy test impulsu (podw√≥jny prz√≥d‚Üíty≈Ç)">üîß Testuj</button>
                        </div>
                        <div class="help-text">Si≈Ça impulsu jako % joysticka. Podw√≥jny impuls: 100ms prz√≥d + 100ms ty≈Ç. Typowy zakres: 15-40%.</div>
                    </div>
                    <div class="setting-container" id="sysid-step-container" style="display: none;">
                        <label for="sysid-step-value">Warto≈õƒá skoku<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper"><button>-</button><input type="number" class="config-value" id="sysid-step-value" min="5" max="500" step="5" value="50"><button>+</button></div>
                        <div class="help-text">
                            Dla pƒôtli prƒôdko≈õci: setpoint prƒôdko≈õci [imp/s lub cm/s].<br>
                            Dla pƒôtli pozycji: setpoint pozycji [cm].
                        </div>
                    </div>
                    <div class="setting-container">
                        <label for="sysid-sample-rate">Pr√≥bkowanie (Hz)<span class="help-icon">?</span></label>
                        <select id="sysid-sample-rate" class="config-value" style="width: 100%; padding: 8px; background: #20232a; border: 1px solid #61dafb; border-radius: 4px; color: #fff;">
                            <option value="100">100 Hz</option>
                            <option value="200" selected>200 Hz</option>
                            <option value="500">500 Hz (pe≈Çna telemetria)</option>
                        </select>
                        <div class="help-text">Czƒôstotliwo≈õƒá pr√≥bkowania danych. Wy≈ºsza warto≈õƒá = wiƒôcej danych, lepsza rozdzielczo≈õƒá czasowa, ale wiƒôkszy plik.</div>
                    </div>
                    
                    <div style="background: #20232a; border: 1px solid #4a4f58; border-radius: 6px; padding: 12px; margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Status: <strong id="sysid-status-text" style="color: #aaa;">Gotowy</strong></span>
                            <span>Pr√≥bki: <strong id="sysid-sample-count">0</strong></span>
                        </div>
                        <div style="margin-top: 8px;">
                            <progress id="sysid-progress" value="0" max="100" style="width: 100%; height: 20px;"></progress>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0;">
                        <button id="sysid-start-btn" style="flex: 1; min-width: 120px; padding: 12px; background: #61dafb; color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                            ‚ñ∂Ô∏è Rozpocznij Nagrywanie
                        </button>
                        <button id="sysid-stop-btn" style="flex: 1; min-width: 120px; padding: 12px; background: #ff6347; color: #fff; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;" disabled>
                            ‚èπÔ∏è Zatrzymaj
                        </button>
                    </div>
                    
                    <p style="color: #888; font-size: 0.85em; margin-bottom: 10px;">
                        üíæ Dane zawierajƒÖ: czas, kƒÖt rzeczywisty, impuls PWM, prƒôdko≈õƒá k√≥≈Ç, gyro
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button id="sysid-export-csv-btn" style="flex: 1; min-width: 100px; padding: 10px; background: #a2f279; color: #000; border: none; border-radius: 6px; cursor: pointer;" disabled>
                            üìä Eksport CSV
                        </button>
                        <button id="sysid-export-mat-btn" style="flex: 1; min-width: 100px; padding: 10px; background: #f7b731; color: #000; border: none; border-radius: 6px; cursor: pointer;" disabled>
                            üìê Eksport MAT
                        </button>
                        <button id="sysid-analyze-btn" style="flex: 1; min-width: 100px; padding: 10px; background: #9b59b6; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;" disabled>
                            üî¨ Analizuj
                        </button>
                        <button id="sysid-clear-btn" style="flex: 1; min-width: 100px; padding: 10px; background: #4a4f58; color: #fff; border: none; border-radius: 6px; cursor: pointer;" disabled>
                            üóëÔ∏è Wyczy≈õƒá Dane
                        </button>
                    </div>
                    
                    <canvas id="sysid-preview-chart" height="150" style="width: 100%; background: #101014; border: 1px solid #2a2a35; border-radius: 6px;"></canvas>
                    
                    <!-- Panel wynik√≥w analizy -->
                    <div id="sysid-analysis-results" style="display: none; margin-top: 15px; background: #1a1d24; border: 1px solid #9b59b6; border-radius: 8px; padding: 15px;">
                        <h4 style="margin: 0 0 12px 0; color: #9b59b6; font-size: 1em;">üî¨ Wyniki Analizy</h4>
                        
                        <!-- Informacja o trybie fuzji -->
                        <div id="sysid-fusion-warning" style="display: none;"></div>
                        
                        <!-- Ostrze≈ºenia -->
                        <div id="sysid-warnings" style="display: none; margin-bottom: 12px; padding: 10px; background: #332200; border: 1px solid #f7b731; border-radius: 6px; font-size: 0.9em;">
                        </div>
                        
                        <!-- Parametry modelu -->
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; color: #61dafb; margin-bottom: 8px;">üìä Parametry Modelu</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 0.9em;">
                                <div style="background: #20232a; padding: 8px; border-radius: 4px;">
                                    <div style="color: #888;">Wzmocnienie (K)</div>
                                    <div id="sysid-result-k" style="font-weight: bold; color: #fff;">-</div>
                                </div>
                                <div style="background: #20232a; padding: 8px; border-radius: 4px;">
                                    <div style="color: #888;">T≈Çumienie (Œ∂)</div>
                                    <div id="sysid-result-zeta" style="font-weight: bold; color: #fff;">-</div>
                                </div>
                                <div style="background: #20232a; padding: 8px; border-radius: 4px;">
                                    <div style="color: #888;">Czƒôst. w≈Çasna (œân)</div>
                                    <div id="sysid-result-wn" style="font-weight: bold; color: #fff;">-</div>
                                </div>
                                <div style="background: #20232a; padding: 8px; border-radius: 4px;">
                                    <div style="color: #888;">Przeregulowanie</div>
                                    <div id="sysid-result-overshoot" style="font-weight: bold; color: #fff;">-</div>
                                </div>
                                <div style="background: #20232a; padding: 8px; border-radius: 4px;">
                                    <div style="color: #888;">Czas ustalania</div>
                                    <div id="sysid-result-settling" style="font-weight: bold; color: #fff;">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sugestie PID -->
                        <div>
                            <div style="font-weight: bold; color: #a2f279; margin-bottom: 8px;">üéØ Sugerowane PID</div>
                            <div id="sysid-pid-suggestions" style="display: grid; gap: 10px;">
                                <!-- Wype≈Çniane dynamicznie -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <div class="button-group" style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button id="loadBtn">Wczytaj z Robota</button>
                <button id="saveBtn">Zapisz na Robocie</button>
            </div>
        </div>
    <div class="card" id="log-card" style="position: fixed; left: 0; right: 0; bottom: 0; z-index: 3000; margin: 0; border-radius: 0; padding-bottom: 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.35);">
            <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" id="log-toggle-bar" title="Rozwi≈Ñ/Zwi≈Ñ logi">
                <h2 style="margin: 0;">Logi</h2>
                <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
                    <label style="font-size:0.9em; color:#ccc; display:flex; align-items:center; gap:6px;">Autoscroll <input type="checkbox" id="logsAutoscroll" checked></label>
                    <button id="clearLogsBtn" class="btn-small" style="background:#f7b731;">Wyczy≈õƒá</button>
                </div>
            </div>
            <div id="log-history" style="max-height: 40vh; overflow-y: auto; display: none;"></div>
        </div>
    </div>
    <!-- Nowy modal: Mapowanie czujnika ‚Äì sekwencyjny kreator z auto-wykryciem obrotu > 90¬∞ -->
    
    <!-- Modal: Historia pr√≥b strojenia -->
    <div id="tuning-history-modal" class="modal-backdrop" style="display:none;">
        <div class="modal-content" style="max-width:1000px;">
            <h2>Historia wszystkich pr√≥b</h2>
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                <button id="closeHistoryBtn" style="background:#ff6347;">Zamknij</button>
                <button id="exportHistoryCsvBtn" style="background:#61dafb;">Eksport CSV</button>
                <span id="historyCount" style="margin-left:auto; color:#aaa;"></span>
            </div>
            <div class="autotune-results-container">
                <table class="autotune-results-table" style="display:table;">
                    <thead>
                        <tr><th>#</th><th>Kp</th><th>Ki</th><th>Kd</th><th>Fitness</th><th>ITAE</th><th>Przeregul.</th><th>Akcja</th></tr>
                    </thead>
                    <tbody id="results-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="sensor-mapping-modal" class="modal-backdrop" style="display:none;">
        <div class="modal-content">
            <h2>Mapowanie Czujnika (Orientacja) <span class="help-icon" id="sensorMappingHelp" title="Poka≈º/ukryj szczeg√≥≈ÇowƒÖ pomoc">?</span></h2>
            <div id="sensorMappingHelpText" class="help-text" style="margin-bottom:10px;" aria-hidden="true">
                <strong>Cel:</strong> Dopasowanie fizycznego monta≈ºu IMU do oczekiwanych osi sterowania robota.<br>
                <strong>Kroki:</strong> (1) Pozycja pionowa referencyjna. (2) Obr√≥t poziomy ‚â• 90¬∞. (3) Zapis korekcji.<br>
                <strong>Wp≈Çyw:</strong> Dzia≈Ça na wewnƒôtrzne wektory (akcelerometr/≈ºyroskop) u≈ºywane przez PID. Nie zmienia wizualizacji 3D (oddzielne mapowanie modelu).<br>
                <strong>Wymagane:</strong> Kalibracja IMU (System=3) dla najlepszej dok≈Çadno≈õci.<br>
                <em>Po zapisie sterowanie bƒôdzie korzystaƒá z poprawionych osi automatycznie.</em>
            </div>
            <div id="sensorWizardStepInfo" style="margin:6px 0; font-size:12px; color:#aaa;">Krok <span id="sensorWizardStepNo">1</span>/3</div>
            <div id="sensorWizardText" style="text-align:left; font-size:0.95em; line-height:1.5; background:#101014; border:1px solid #2a2a35; padding:12px; border-radius:8px;">
                <!-- dynamiczna instrukcja -->
            </div>
            <div id="sensorWizardHint" style="margin-top:8px; font-size:0.85em; color:#bbb;">
                <!-- dynamiczne podpowiedzi -->
            </div>
            <div id="sensorWizardProgress" style="margin-top:12px; font-family:monospace; background:#111; border:1px solid #333; border-radius:6px; padding:8px; text-align:left;">
                [ ] Pion | [ ] Rotacja ‚â• 90¬∞ | [ ] Zapis
            </div>
            <div class="sensor-mapping-wrapper" style="display:flex; gap:10px; margin-top:12px; align-items:flex-start;">
                <div id="sensor-mapping-preview" class="sensor-mapping-preview" style="flex:1; min-width:250px; height:200px; background:#000; border-radius:6px; overflow:hidden;"></div>
                    <div class="sensor-mapping-controls" style="width:320px; display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; justify-content:space-between; gap:6px;">
                        <div>
                            <div>Pitch (Cube): <span id="modal-pitch-display">0.0¬∞</span></div>
                            <div style="font-size:0.8em; color:#9fa;">Telemetry: <span id="modal-pitch-telemetry">0.0¬∞</span></div>
                        </div>
                        <div>
                            <div>Roll (Cube): <span id="modal-roll-display">0.0¬∞</span></div>
                            <div style="font-size:0.8em; color:#9fa;">Telemetry: <span id="modal-roll-telemetry">0.0¬∞</span></div>
                        </div>
                        <div>
                            <div>Yaw (Cube): <span id="modal-yaw-display">0.0¬∞</span></div>
                            <div style="font-size:0.8em; color:#9fa;">Telemetry: <span id="modal-yaw-telemetry">0.0¬∞</span></div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <div style="flex:1;"><div style="font-size:0.9em; margin-bottom:4px;">Pitch</div><button id="pitchMinus90Btn">-90¬∞</button><button id="pitchPlus90Btn">+90¬∞</button></div>
                        <div style="flex:1;"><div style="font-size:0.9em; margin-bottom:4px;">Roll</div><button id="rollMinus90Btn">-90¬∞</button><button id="rollPlus90Btn">+90¬∞</button></div>
                        <div style="flex:1;"><div style="font-size:0.9em; margin-bottom:4px;">Yaw</div><button id="yawMinus90Btn">-90¬∞</button><button id="yawPlus90Btn">+90¬∞</button></div>
                    </div>
                    <div class="mount-rotate-90" style="display:flex; gap:8px; margin-top:6px;">
                        <div style="flex:1;"><div style="font-size:0.9em; margin-bottom:4px;">Monta≈º X</div><button id="mountXMinus90Btn">-90¬∞</button><button id="mountXPlus90Btn">+90¬∞</button></div>
                        <div style="flex:1;"><div style="font-size:0.9em; margin-bottom:4px;">Monta≈º Y</div><button id="mountYMinus90Btn">-90¬∞</button><button id="mountYPlus90Btn">+90¬∞</button></div>
                        <div style="flex:1;"><div style="font-size:0.9em; margin-bottom:4px;">Monta≈º Z</div><button id="mountZMinus90Btn">-90¬∞</button><button id="mountZPlus90Btn">+90¬∞</button></div>
                    </div>
                    <!-- DODANE: Kontrolki remapu IMU (wp≈ÇywajƒÖ na wewnƒôtrzne wektory - PID) -->
                    <hr style="border-color:#2a2a35;">
                    <div style="margin-top:6px;">
                        <strong>Mapowanie osi IMU (wp≈Çyw na PID)</strong>
                        <div style="display:flex; gap:6px; margin-top:6px;">
                            <div style="flex:1;">
                                <div>Pitch (≈πr√≥d≈Ço)</div>
                                <select id="imuPitchSource"><option value="0">Pitch</option><option value="1">Yaw</option><option value="2">Roll</option></select>
                                <div class="sign-toggle" id="imuPitchSign" style="margin-top:6px;"><button data-sign="1" class="active" title="Dodatni">+1</button><button data-sign="-1" title="Ujemny">-1</button></div>
                            </div>
                            <div style="flex:1;">
                                <div>Yaw (≈πr√≥d≈Ço)</div>
                                <select id="imuYawSource"><option value="0">Pitch</option><option value="1">Yaw</option><option value="2">Roll</option></select>
                                <div class="sign-toggle" id="imuYawSign" style="margin-top:6px;"><button data-sign="1" class="active">+1</button><button data-sign="-1">-1</button></div>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px; margin-top:6px; align-items:center;">
                            <div style="flex:1;">
                                <div>Roll (≈πr√≥d≈Ço)</div>
                                <select id="imuRollSource"><option value="0">Pitch</option><option value="1">Yaw</option><option value="2">Roll</option></select>
                                <div class="sign-toggle" id="imuRollSign" style="margin-top:6px;"><button data-sign="1" class="active">+1</button><button data-sign="-1">-1</button></div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px; min-width:120px;">
                                <button id="imuMappingLoadBtn" style="background:#61dafb;">Wczytaj</button>
                                <button id="imuMappingSaveBtn" style="background:#a2f279;">Zapisz</button>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:6px; margin-top:8px;"><input id="markFrontFaceChk" type="checkbox"><label for="markFrontFaceChk">Oznacz front (g√≥ra/d√≥≈Ç) w podglƒÖdzie</label></div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button id="setModalPitchZeroBtn" style="flex:1; background:#61dafb;">Ustaw punkt 0 (Pitch)</button>
                        <button id="setModalRollZeroBtn" style="flex:1; background:#61dafb;">Ustaw punkt 0 (Roll)</button>
                    </div>
                    <!-- Ma≈Çe korekty trim√≥w -->
                    <hr style="border-color:#2a2a35;">
                    <div style="margin-top:6px;">
                        <strong>Ma≈Çe korekty trim√≥w</strong>
                        <div style="display:flex; gap:6px; margin-top:6px;">
                            <div style="flex:1;">
                                <div>Pitch</div>
                                <div style="display:flex; gap:2px; margin-top:4px;">
                                    <button id="pitchTrimPlus01Btn" style="flex:1; font-size:0.8em;">+0.1¬∞</button>
                                    <button id="pitchTrimMinus01Btn" style="flex:1; font-size:0.8em;">-0.1¬∞</button>
                                    <button id="pitchTrimPlus001Btn" style="flex:1; font-size:0.8em;">+0.01¬∞</button>
                                    <button id="pitchTrimMinus001Btn" style="flex:1; font-size:0.8em;">-0.01¬∞</button>
                                </div>
                            </div>
                            <div style="flex:1;">
                                <div>Roll</div>
                                <div style="display:flex; gap:2px; margin-top:4px;">
                                    <button id="rollTrimPlus01Btn" style="flex:1; font-size:0.8em;">+0.1¬∞</button>
                                    <button id="rollTrimMinus01Btn" style="flex:1; font-size:0.8em;">-0.1¬∞</button>
                                    <button id="rollTrimPlus001Btn" style="flex:1; font-size:0.8em;">+0.01¬∞</button>
                                    <button id="rollTrimMinus001Btn" style="flex:1; font-size:0.8em;">-0.01¬∞</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                    <!-- Modal: Konfiguracja Fitness -->
                    <div id="fitness-modal" class="modal-backdrop" style="display:none;">
                        <div class="modal-content" style="max-width:480px;">
                            <h2>Konfiguracja Fitness (Rozdziel 100 punkt√≥w)</h2>
                            <div style="display:flex; gap:10px; flex-direction:column;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <label for="weight-itae">ITAE</label>
                                    <input type="number" id="weight-itae" min="0" max="100" value="50" style="width:110px;">
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <label for="weight-overshoot">Przeregulowanie</label>
                                    <input type="number" id="weight-overshoot" min="0" max="100" value="30" style="width:110px;">
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <label for="weight-sse">SSE / Kontrola</label>
                                    <input type="number" id="weight-sse" min="0" max="100" value="20" style="width:110px;">
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; color:#61dafb;">
                                    <div>Pozosta≈Ço:</div>
                                    <div id="weight-remaining">0</div>
                                </div>
                                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:8px;">
                                    <button id="close-fitness-modal" style="background:#ff6347;">Zamknij</button>
                                    <button id="apply-fitness-btn" style="background:#a2f279;" disabled>Zastosuj Wagi</button>
                                </div>
                            </div>
                        </div>
                    </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
                <button id="sensorWizardCancelBtn" style="background:#ff6347;">Anuluj</button>
                <button id="sensorWizardBackBtn" disabled>Wstecz</button>
                <button id="sensorWizardNextBtn" style="background:#61dafb;">Dalej</button>
            </div>
        </div>
    </div>
    <!-- Modal mapowania modelu 3D -->
    <div id="model-mapping-modal" class="modal-backdrop" style="display:none;">
        <div class="modal-content">
            <h2>Mapowanie Modelu 3D (Wizualizacja) <span class="help-icon" id="modelMappingHelp" title="Poka≈º/ukryj szczeg√≥≈ÇowƒÖ pomoc">?</span></h2>
            <div id="modelMappingHelpText" class="help-text" style="margin-bottom:10px;" aria-hidden="true">
                <strong>Co to robi?</strong> Przekszta≈Çca kƒÖty Euler'a (pochodne z kwaternionu) na osie sceny 3D.<br>
                <strong>Kiedy u≈ºyƒá?</strong> Je≈õli model 3D reaguje w niew≈Ça≈õciwych osiach albo odwrotnie ni≈º oczekujesz.<br>
                <strong>≈πr√≥d≈Ça:</strong> Pitch/Yaw/Roll liczone z kwaternionu (standard ZYX).<br>
                <strong>Znak:</strong> U≈ºyj -1 aby odwr√≥ciƒá kierunek osi bez zmiany logiki sterowania.<br>
                <em>Zmiany nie wp≈ÇywajƒÖ na kontrolƒô robota ‚Äì tylko na wizualizacjƒô.</em>
            </div>
            <p style="text-align:left; font-size:0.85em; line-height:1.4;" title="Tylko wizualizacja, nie sterowanie">Okre≈õl, kt√≥re sk≈Çadowe kƒÖt√≥w Euler'a majƒÖ zasilaƒá osie modelu 3D oraz ich znak.</p>
            <div class="model-mapping-row" title="≈πr√≥d≈Ço oraz znak dla osi Pitch modelu">
                <strong>Pitch:</strong>
                <select id="modelPitchSource" title="Wybierz z kt√≥rej osi Euler bƒôdzie pochodziƒá Pitch modelu">
                    <option value="0">Pitch</option>
                    <option value="1">Yaw</option>
                    <option value="2">Roll</option>
                </select>
                <div class="sign-toggle" id="modelPitchSign" title="Znak osi Pitch">
                    <button data-sign="1" class="active" title="Dodatni kierunek">+1</button>
                    <button data-sign="-1" title="Odwr√≥ƒá kierunek">-1</button>
                </div>
            </div>
            <div class="model-mapping-row" title="≈πr√≥d≈Ço oraz znak dla osi Yaw modelu">
                <strong>Yaw:</strong>
                <select id="modelYawSource" title="Wybierz z kt√≥rej osi Euler bƒôdzie pochodziƒá Yaw modelu">
                    <option value="0">Pitch</option>
                    <option value="1">Yaw</option>
                    <option value="2">Roll</option>
                </select>
                <div class="sign-toggle" id="modelYawSign" title="Znak osi Yaw">
                    <button data-sign="1" class="active" title="Dodatni kierunek">+1</button>
                    <button data-sign="-1" title="Odwr√≥ƒá kierunek">-1</button>
                </div>
            </div>
            <div class="model-mapping-row" title="≈πr√≥d≈Ço oraz znak dla osi Roll modelu">
                <strong>Roll:</strong>
                <select id="modelRollSource" title="Wybierz z kt√≥rej osi Euler bƒôdzie pochodziƒá Roll modelu">
                    <option value="0">Pitch</option>
                    <option value="1">Yaw</option>
                    <option value="2">Roll</option>
                </select>
                <div class="sign-toggle" id="modelRollSign" title="Znak osi Roll">
                    <button data-sign="1" class="active" title="Dodatni kierunek">+1</button>
                    <button data-sign="-1" title="Odwr√≥ƒá kierunek">-1</button>
                </div>
            </div>
            <div id="model-mapping-current" title="Aktualna konfiguracja mapowania">Brak danych mapowania.</div>
            <div style="display:flex; gap:10px; margin-top:12px;">
                <button id="modelMappingLoadBtn" style="flex:1; background:#61dafb;" title="Pobierz aktualne warto≈õci z EEPROM">Wczytaj</button>
                <button id="modelMappingSaveBtn" style="flex:1; background:#a2f279;" title="Zapisz bie≈ºƒÖce ustawienia do EEPROM">Zapisz</button>
                <button id="modelMappingResetBtn" style="flex:1; background:#f7b731;" title="Przywr√≥ƒá warto≈õci domy≈õlne (identity)">Domy≈õlne</button>
            </div>
            <button id="modelMappingCloseBtn" style="width:100%; margin-top:14px; background:#ff6347;" title="Zamknij okno">Zamknij</button>
        </div>
    </div>

    <!-- WARNING: Do NOT include both the production bundle and modular JS files in the same page.
        For development, use 'index-dev.html' which loads the modular scripts in dependency order.
        The bundler is available as a single file 'js/main.js' for production. -->
    <!-- Production mode: u≈ºywamy wy≈ÇƒÖcznie zbudowanego pakietu 'main.js'.
        NIE ≈Çadujemy jednocze≈õnie modularnych plik√≥w aby uniknƒÖƒá
        redeklaracji zmiennych (patrz komentarz w main.js). -->
    <script src="js/main.js"></script>

</body>
</html>
