<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RoboBala PID - Panel Sterowania v1.1 (Dual-Core)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 15px; background-color: #282c34; color: #fff; font-size: 14px; }
        h1 { color: #61dafb; font-size: 1.8em; }
        h2 { color: #61dafb; font-size: 1.4em; margin-top: 0; margin-bottom: 15px; }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; align-items: start; max-width: 1920px; margin: auto; }
        .card { background-color: #3a3f47; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .info-grid, .status-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px; text-align: left; font-size: 1em; margin-top: 10px; align-items: center;}
        .info-grid strong, .status-grid strong { color: #a2f279; }
        button { background-color: #61dafb; color: #282c34; border: none; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, opacity 0.3s, box-shadow 0.2s; font-size: 0.9em; }
        button:hover { background-color: #a2f279; }
        button:disabled { background-color: #4a4f58; color: #888; cursor: not-allowed; opacity: 0.6; }
        #emergencyStopBtn { background-color: #ff6347; color: white; width: 100%; margin-top: 15px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 10px; }
        .control-label { font-size: 1.1em; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider.round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ff6347; transition: .4s; border-radius: 28px; }
        .slider.round:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #a2f279; }
        input:checked + .slider:before { transform: translateX(22px); }
        input:disabled + .slider { background-color: #4a4f58; cursor: not-allowed; }
        fieldset { border: 1px solid #4a4f58; border-radius: 8px; margin-top: 15px; padding: 10px 15px; }
        legend { color: #61dafb; font-weight: bold; padding: 0 10px; font-size: 1.1em; }
        #joystickWrapper { position: relative; width: 180px; height: 180px; border-radius: 50%; background-color: #4a4f58; border: 3px solid #61dafb; margin: 15px auto; touch-action: none; }
        #joystickCanvas { width: 100%; height: 100%; display: block; }
        #chart-wrapper { position: relative; height: 320px; border-radius: 8px; overflow: hidden; background-color: #20232a; }
        #log-history { text-align: left; height: 350px; overflow-y: auto; background-color: #20232a; padding: 10px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; }
        .status-indicator { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
        .status-ok { background-color: #a2f279; }
        .status-error { background-color: #ff6347; }
        .status-disconnected { background-color: #888; }
        #emergency-banner { display: none; background-color: #ff6347; color: white; padding: 10px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        .angle-display { display: flex; align-items: center; justify-content: space-between; }
        .angle-indicator-wrapper { position: relative; width: 34px; height: 34px; background-color: #20232a; border-radius: 50%; border: 1px solid #61dafb; }
        .angle-indicator-needle { position: absolute; bottom: 50%; left: calc(50% - 1px); width: 2px; height: 50%; background-color: #ff6347; transform-origin: bottom center; transition: transform 0.1s linear; }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; font-size: 0.9em; }
        .setting-container { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 8px 0; }
        .setting-container label { font-size: 1em; font-weight: bold; color: #a2f279; text-align: left; }
        .numeric-input-wrapper { display: flex; align-items: center; flex-shrink: 0; }
        .numeric-input-wrapper button { background-color: #4a4f58; color: #61dafb; padding: 4px 8px; font-size: 1em; line-height: 1; min-width: 30px; }
        .numeric-input-wrapper input[type=number] { width: 90px; text-align: center; font-size: 1em; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 5px; margin: 0 4px; padding: 4px; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .manual-tune-row { background-color: #2a2f35; padding: 10px; border-radius: 6px; margin-bottom: 12px; }
        .pwm-input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pwm-input-row label { font-weight: bold; color: #a2f279; }
        .pwm-button-row { display: flex; justify-content: flex-end; gap: 10px; }
        .test-btn { background-color: #a2f279; }
        .stop-btn { background-color: #ff6347; }
        .auto-btn { background-color: #f7b731; }
        .trim-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .trim-controls span { font-weight: bold; }
        .trim-controls button { min-width: 40px; font-size: 1.2em; }
        .dpad-container { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 5px; max-width: 150px; margin: 15px auto; }
        .dpad-btn { background-color: #61dafb; color: #282c34; border-radius: 5px; font-size: 2em; line-height: 1; padding: 5px; cursor: pointer; border: none; }
        #dpad-stop { grid-column: 2; grid-row: 2; background-color: #ff6347; color: white; }
        .dpad-input-group { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 10px 0; }
        .dpad-input-group label { text-align: right; font-weight: bold; color: #a2f279; }
        .accordion-header { background-color: #4a4f58; color: #61dafb; cursor: pointer; padding: 12px 15px; border: none; text-align: left; outline: none; font-size: 1.1em; font-weight: bold; width: 100%; border-radius: 8px; margin-top: 5px; transition: background-color 0.3s; position: relative; }
        .accordion-header.active { background-color: #61dafb; color: #282c34; border-bottom-left-radius: 0; border-bottom-right-radius: 0;}
        .accordion-header::after { content: '+'; position: absolute; right: 15px; font-size: 1.4em; }
        .accordion-header.active::after { content: '-'; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background-color: #3a3f47; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}
        .accordion-content.active { padding: 15px; }
        .help-icon { display: inline-block; width: 16px; height: 16px; border-radius: 50%; background-color: #61dafb; color: #282c34; font-size: 12px; font-weight: bold; text-align: center; line-height: 16px; margin-left: 8px; cursor: pointer; user-select: none; }
        .help-text { background-color: #20232a; color: #fff; border-radius: 6px; padding: 10px; border: 1px solid #61dafb; margin-top: 8px; text-align: left; font-size: 0.9em; line-height: 1.4; width: 100%; box-sizing: border-box; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding-top: 0; padding-bottom: 0; grid-column: 1 / -1; }
        .help-text.visible { max-height: 200px; padding-top: 10px; padding-bottom: 10px; }
        .sequence-step { display: grid; grid-template-columns: 1fr 100px auto; gap: 10px; align-items: center; background-color: #2a2f35; padding: 8px; border-radius: 6px; margin-bottom: 8px; transition: background-color: 0.3s; }
        .sequence-step.executing { background-color: #a2f279; color: #282c34; }
        .sequence-step select, .sequence-step input { width: 100%; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 4px; padding: 5px; }
        .sequence-step .remove-step-btn { background-color: #ff6347; padding: 5px 10px; }
        .preset-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        #tuning-progress-bar-container { width: 100%; background-color: #20232a; border-radius: 5px; overflow: hidden; margin: 10px 0; border: 1px solid #61dafb;}
        #tuning-progress-bar { width: 0%; height: 20px; background-color: #a2f279; transition: width 0.5s ease; }
        #tuning-last-result-display, #tuning-next-params-display, #tuning-best-params-display { background-color: #20232a; border-radius: 5px; padding: 10px; font-family: monospace; text-align: left; white-space: pre-wrap; font-size: 0.9em; line-height: 1.5; }
        .tuning-mode-selector { display: grid; grid-template-columns: 1fr; gap: 5px; }
        .tuning-mode-btn { background-color: #4a4f58; }
        .tuning-mode-btn.active { background-color: #a2f279; color: #282c34; }
        .tuning-actions, .tuning-loop-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
    </style>
</head>
<body>
    <div id="emergency-banner">ZATRZYMANIE AWARYJNE</div>
    <h1>RoboBala PID - Panel Sterowania</h1>
    <div class="main-grid">
        <!-- SEKCJA STEROWANIA I STATUSU -->
        <div class="card" id="controls-card">
            <h2>Sterowanie</h2>
            <div id="joystickWrapper"><canvas id="joystickCanvas"></canvas></div>
            <div class="control-row"><span class="control-label">Balansowanie</span><label class="switch"><input type="checkbox" id="balanceSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">Trzymaj Pozycje</span><label class="switch"><input type="checkbox" id="holdPositionSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">Tryb Predkosci</span><label class="switch"><input type="checkbox" id="speedModeSwitch"><span class="slider round"></span></label></div>
            <fieldset style="margin-top:20px;"><legend>Strojenie Joysticka</legend>
                <div class="setting-container"><label for="joystickSensitivityInput">Czulosc Ogolna (%)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="joystickSensitivityInput" min="10" max="100" step="5" value="100"><button>+</button></div></div>
                <div class="setting-container"><label for="expoJoystickInput">Expo Joysticka (%)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="expoJoystickInput" min="0" max="90" step="1" value="0"><button>+</button></div></div>
                <div class="setting-container"><label for="maxSpeedJoystickInput">Max. predkosc (imp/s)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="maxSpeedJoystickInput" min="200" max="4000" step="100" value="800"><button>+</button></div></div>
                <div class="setting-container"><label for="turnFactorInput">Czulosc Skretu (%)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="turnFactorInput" min="0" max="100" step="5" value="25"><button>+</button></div></div>
                <div class="setting-container"><label for="joystickDeadzoneInput">Strefa Martwa (%)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="joystickDeadzoneInput" min="0" max="50" step="1" value="0"><button>+</button></div></div>
            </fieldset>
            <button id="resetZeroBtn" style="margin-top:10px; width:100%;">Resetuj Osie</button>
            <div class="trim-controls"> <button id="trimMinusBtn">-</button> <span>Korekta Pionu (Pitch)</span> <button id="trimPlusBtn">+</button> </div>
            <div class="trim-controls"> <button id="trimRollMinusBtn">-</button> <span>Korekta Przechylu (Roll)</span> <button id="trimRollPlusBtn">+</button> </div>
            <button id="resetEncodersBtn" style="margin-top:10px; background-color:#f7b731; width: 100%;">Resetuj Enkodery</button>
            <button id="emergencyStopBtn">STOP AWARYJNY</button>
        </div>
        <div class="card">
            <h2>Status Robota</h2>
            <button id="connectBleBtn" style="width: 100%; margin-bottom: 15px;">POLACZ Z ROBOTEM</button>
            <div class="status-grid">
                <strong>Polaczenie:</strong> <div><span id="connectionStatus" class="status-indicator status-disconnected"></span> <span id="connectionText">Rozlaczony</span></div>
                <strong>Tryb Pracy:</strong> <span id="robotStateVal" style="font-weight:bold; color: #61dafb;">IDLE</span>
            </div>
            <div class="info-grid">
                <strong>Kat (Pitch):</strong> <div class="angle-display"><span id="angleVal">0.0 &deg;</span><div class="angle-indicator-wrapper"><div id="angleIndicator" class="angle-indicator-needle"></div></div></div>
                <strong>Predkosc (imp/s):</strong> <span id="speedVal">0</span>
                <strong>Zadany Kat:</strong> <span id="targetAngleVal">0.0 &deg;</span>
                <strong>Wyjscie PID Balansu:</strong> <span id="balanceOutputVal">0</span>
                <strong>Enkoder L:</strong> <span id="encoderLeftVal">0</span>
                <strong>Enkoder P:</strong> <span id="encoderRightVal">0</span>
            </div>
            <button class="accordion-header" onclick="toggleAccordion(this)" style="margin-top:15px">Sterowanie Autonomiczne</button>
             <div class="accordion-content">
                <fieldset> <legend>Sterowanie Precyzyjne (D-Pad)</legend> <div class="dpad-input-group"><label for="dpadDistInput">Dystans (cm):</label><input type="number" id="dpadDistInput" value="20"></div> <div class="dpad-input-group"><label for="dpadAngleInput">Kat (st.):</label><input type="number" id="dpadAngleInput" value="90"></div> <div class="dpad-container"> <button class="dpad-btn" data-dpad="up">&#8593;</button> <button class="dpad-btn" data-dpad="left">&#8592;</button> <button id="dpad-stop" class="dpad-btn" data-dpad="stop">&#215;</button> <button class="dpad-btn" data-dpad="right">&#8594;</button> <button class="dpad-btn" data-dpad="down">&#8595;</button> </div></fieldset>
                <fieldset style="margin-top: 15px;"> <legend>Kreator Sekwencji Ruchow</legend> <div id="sequence-list"></div> <button id="add-sequence-step-btn" style="width:100%; margin: 10px 0;">Dodaj Krok</button> <div style="display:flex; gap:10px; justify-content:center;"> <button id="run-sequence-btn" style="background-color: #a2f279;">Uruchom</button> <button id="stop-sequence-btn" style="background-color: #ff6347;" disabled>Zatrzymaj</button> <button id="clear-sequence-btn" style="background-color: #f7b731;">Wyczysc</button> </div> </fieldset>
                <fieldset style="margin-top: 15px;"> <legend>Diagnostyka</legend> <button id="calibrateMpuBtn" style="width:100%; background-color:#f7b731;">Kalibruj MPU (DMP)</button> </fieldset>
            </div>
        </div>
        <!-- SEKCJA KONFIGURACJI -->
        <div class="card">
            <h2>Konfiguracja</h2>
            <fieldset> <legend>Profile Ustawien</legend>
                <div class="profile-controls"> <select id="pidPresetSelect" style="width: 100%; padding: 5px;"></select> </div>
                <div class="preset-actions"> <button id="applySelectedPresetBtn">Zastosuj</button> <button id="saveCurrentAsPresetBtn">Zapisz jako Nowy</button> </div>
                <button id="deleteSelectedPresetBtn" style="width:100%; margin-top: 10px; background-color: #ff6347;">Usun Wybrany Preset</button>
            </fieldset>
            
            <div id="allSettings">
                <button class="accordion-header active" onclick="toggleAccordion(this)">1. Regulator Balansu (Pitch)</button>
                <div class="accordion-content active">
                    <div class="setting-container"><label>Kp (Sila)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="balanceKpInput" step="1" value="95"><button>+</button></div><div class="help-text">Głowna sila utrzymujaca robota w pionie.</div></div>
                    <div class="setting-container"><label>Ki (Precyzja)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="balanceKiInput" step="0.1" value="0"><button>+</button></div><div class="help-text">Koryguje dlugotrwaly blad.</div></div>
                    <div class="setting-container"><label>Kd (Tlumienie)<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="balanceKdInput" step="0.01" value="3.23"><button>+</button></div><div class="help-text">Hamuje szybkie zmiany kata, tlumi oscylacje.</div></div>
                    <hr style="border-color: #4a4f58; margin: 10px 0;">
                    <div class="setting-container"><label>Filtr Pochodnej (Alpha)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="balancePidDerivativeFilterAlphaInput" min="0.01" max="1.0" step="0.01" value="1.0"><button>+</button></div></div>
                    <div class="setting-container"><label>Czulosc Kata Joysticka (st.)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="joystickAngleSensitivityInput" min="1" max="30" step="0.5" value="10"><button>+</button></div></div>
                    <div class="setting-container"><label>Strefa Martwa Balansu (st.)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="calib-input" id="balanceDeadbandAngleInput" min="0" max="5" step="0.1" value="0.5"><button>+</button></div></div>
                </div>

                <button class="accordion-header" onclick="toggleAccordion(this)">2. Regulatory Kaskadowe (Ruch)</button>
                <div class="accordion-content">
                    <fieldset><legend>PID Predkosci</legend>
                        <div class="setting-container"><label>Kp<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="speedKpInput" step="0.01" value="0.05"><button>+</button></div><div class="help-text">Jak mocno robot ma sie pochylac, aby skorygowac blad predkosci.</div></div>
                        <div class="setting-container"><label>Ki</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="speedKiInput" step="0.001" value="0.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Kd</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="speedKdInput" step="0.001" value="0.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Max Kat z PID (st.)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="maxTargetAngleFromSpeedPIDInput" min="1" max="25" step="0.5" value="15"><button>+</button></div></div>
                        <div class="setting-container"><label>Strefa Martwa (imp/s)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="speedPidDeadbandInput" min="0" max="50" step="1" value="5"><button>+</button></div></div>
                    </fieldset>
                    <fieldset style="margin-top:15px;"><legend>PID Pozycji</legend>
                        <div class="setting-container"><label>Kp<span class="help-icon">?</span></label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="positionKpInput" step="0.1" value="2.5"><button>+</button></div><div class="help-text">Sila, z jaka robot wraca do celu.</div></div>
                        <div class="setting-container"><label>Ki</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="positionKiInput" step="0.001" value="0.006"><button>+</button></div></div>
                        <div class="setting-container"><label>Kd</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="positionKdInput" step="0.1" value="1.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Max Predkosc z PID (imp/s)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="maxTargetSpeedFromPosPIDInput" min="100" max="4000" step="50" value="1000"><button>+</button></div></div>
                        <div class="setting-container"><label>Strefa Martwa (impulsy)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="positionPidDeadbandInput" min="0" max="100" step="1" value="15"><button>+</button></div></div>
                    </fieldset>
                </div>

                <button class="accordion-header" onclick="toggleAccordion(this)">3. Regulatory Obrotu (Yaw & Roll)</button>
                <div class="accordion-content">
                     <fieldset><legend>PID Obrotu (do celu)</legend>
                        <div class="setting-container"><label>Kp</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="rotationKpInput" step="0.1" value="1.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Kd</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="rotationKdInput" step="0.1" value="1.0"><button>+</button></div></div>
                    </fieldset>
                     <fieldset style="margin-top:15px;"><legend>PID Utrzymania Kierunku</legend>
                        <div class="setting-container"><label>Kp</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="headingKpInput" step="0.1" value="0.8"><button>+</button></div></div>
                        <div class="setting-container"><label>Ki</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="headingKiInput" step="0.01" value="0.02"><button>+</button></div></div>
                        <div class="setting-container"><label>Kd</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="headingKdInput" step="0.01" value="0.1"><button>+</button></div></div>
                    </fieldset>
                     <fieldset style="margin-top:15px;"><legend>PID Przechylu (Roll)</legend>
                        <div class="setting-container"><label>Kp</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="rollKpInput" step="0.5" value="15.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Ki</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="rollKiInput" step="0.01" value="0.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Kd</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="pid-input" id="rollKdInput" step="0.1" value="0.5"><button>+</button></div></div>
                        <div class="setting-container"><label>Kat Przechylu za Skret (st.)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="calib-input" id="turnToRollTargetInput" min="0" max="15" step="0.5" value="5"><button>+</button></div></div>
                    </fieldset>
                </div>
                
                <button class="accordion-header" onclick="toggleAccordion(this)">4. Parametry Sprzetowe i PWM</button>
                <div class="accordion-content">
                    <fieldset><legend>Kalibracja Mechaniczna</legend>
                        <div class="setting-container"><label>Srednica kola (cm)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="calib-input" id="wheelDiameterCmInput" min="3" max="30" step="0.1" value="8.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Rozstaw kol (cm)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="calib-input" id="trackWidthCmInput" min="5" max="50" step="0.1" value="13.0"><button>+</button></div></div>
                        <div class="setting-container"><label>Impulsy na obrot (PPR)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="calib-input" id="encoderPprInput" min="100" max="5000" step="10" value="820"><button>+</button></div></div>
                        <div class="setting-container"><label>Luz silnika (impulsy)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" class="calib-input" id="motorBacklashImpulsesInput" min="0" max="50" step="1" value="0"><button>+</button></div></div>
                    </fieldset>
                    <fieldset style="margin-top:15px;"><legend>Minimalne PWM</legend>
                        <div class="setting-container"><label>Rozpocznij auto-szukanie od PWM</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="pwmTuneStartInput" min="1" max="800" step="10" value="400"><button>+</button></div></div>
                        <div class="manual-tune-row" data-motor="left" data-direction="fwd"><div class="pwm-input-row"><label>Lewy (Przod)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="pwm-input tune-input" id="minPwmLeftFwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div></div><div class="pwm-button-row"><button class="auto-btn">Auto</button></div></div>
                        <div class="manual-tune-row" data-motor="left" data-direction="bwd"><div class="pwm-input-row"><label>Lewy (Tyl)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="pwm-input tune-input" id="minPwmLeftBwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div></div><div class="pwm-button-row"><button class="auto-btn">Auto</button></div></div>
                        <div class="manual-tune-row" data-motor="right" data-direction="fwd"><div class="pwm-input-row"><label>Prawy (Przod)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="pwm-input tune-input" id="minPwmRightFwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div></div><div class="pwm-button-row"><button class="auto-btn">Auto</button></div></div>
                        <div class="manual-tune-row" data-motor="right" data-direction="bwd"><div class="pwm-input-row"><label>Prawy (Tyl)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="pwm-input tune-input" id="minPwmRightBwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div></div><div class="pwm-button-row"><button class="auto-btn">Auto</button></div></div>
                    </fieldset>
                </div>
            </div>
            <div class="button-group" style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button id="loadBtn">Wczytaj z Robota</button>
                <button id="saveBtn">Zapisz na Robocie</button>
            </div>
        </div>
        <!-- ASYSTENT STROJENIA I LOGI -->
        <div class="card">
             <button class="accordion-header" onclick="toggleAccordion(this)">Inteligentny Asystent Strojenia</button>
             <div class="accordion-content">
                <fieldset> <legend>1. Wybor Trybu Strojenia</legend> <div class="tuning-mode-selector"> <button id="tuningModeBalance" class="tuning-mode-btn active" data-mode="balance">Strojenie Balansu Statycznego</button> <button id="tuningModeImpulse" class="tuning-mode-btn" data-mode="impulse">Strojenie Reakcji na Zaklocenia</button> <button id="tuningModeDrive" class="tuning-mode-btn" data-mode="drive">Strojenie Jazdy Autonomicznej</button> </div> </fieldset>
                <fieldset> <legend>2. Ustawienia Testu</legend>
                    <div class="setting-container"> <label for="tuningIterationsInput">Liczba Iteracji</label> <div class="numeric-input-wrapper"><button>-</button><input type="number" id="tuningIterationsInput" value="20" min="5" max="100"><button>+</button></div> </div>
                    <div class="setting-container"> <label for="tuningTestDurationInput">Czas Trwania Testu (s)</label> <div class="numeric-input-wrapper"><button>-</button><input type="number" id="tuningTestDurationInput" value="3" min="1" max="10"><button>+</button></div> </div>
                    <div class="setting-container"> <label for="tuningStepMultiplierInput">Agresywnosc Strojenia</label> <div class="numeric-input-wrapper"><button>-</button><input type="number" id="tuningStepMultiplierInput" min="0.05" max="2.0" step="0.05" value="1.0"><button>+</button></div> </div>
                    <div id="tuningImpulseSettings" style="display:none;"> <div class="setting-container"><label for="tuningImpulsePowerInput">Sila Impulsu</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="tuningImpulsePowerInput" min="50" max="250" step="10" value="120"><button>+</button></div></div> </div>
                    <div id="tuningDriveSettings" style="display:none;"> <div class="setting-container"><label for="tuningDriveDistanceInput">Dystans testowy (cm)</label><div class="numeric-input-wrapper"><button>-</button><input type="number" id="tuningDriveDistanceInput" value="10" min="10" max="100"><button>+</button></div></div> </div>
                    <hr style="border-color: #4a4f58; margin: 15px 0;">
                    <div style="background-color: #2a2f35; padding: 10px; border-radius: 6px;"> <label>Zarzadzanie bezpieczna baza</label> <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;"> <button id="tuningSaveSafeBaseBtn" style="background-color: #61dafb; color: #282c34;">Zapisz Aktualne jako Baza</button> <button id="tuningRestoreSafeBaseBtn" style="background-color: #f7b731;">Przywroc Baze</button> </div> </div>
                </fieldset>
                <fieldset> <legend>3. Sterowanie i Postep</legend>
                    <p id="tuning-status-text" style="font-style: italic; color: #f7b731; margin-top: 10px;">Czekam na rozpoczecie...</p>
                    <div class="tuning-actions"> <button id="startTuningBtn" style="background-color: #a2f279;">Uruchom Test</button> <button id="stopTuningBtn" style="background-color: #ff6347;" disabled>Zatrzymaj</button> </div>
                    <div class="tuning-loop-actions"> <button id="run5TestsBtn" style="background-color: #f7b731;">Uruchom 5 Prob</button> <button id="applyBestBtn" style="background-color: #61dafb;" disabled>Zastosuj Znalezione</button> </div>
                    <div id="tuning-progress-bar-container"><div id="tuning-progress-bar"></div></div>
                    <h5 style="color:#61dafb; margin: 10px 0 5px 0;">Najlepsze Znalezione Parametry:</h5> <div id="tuning-best-params-display">Najlepsze parametry pojawia sie tutaj...</div>
                </fieldset>
            </div>
        </div>
        <div class="card" id="log-card">
            <button class="accordion-header" onclick="toggleAccordion(this)">Logi Systemowe</button>
            <div class="accordion-content">
                <div id="log-history"></div>
                <button onclick="clearLogs()" style="margin-top: 10px; background-color: #f7b731;">Wyczysc Logi</button>
            </div>
        </div>
        <div class="card">
            <button class="accordion-header" onclick="toggleAccordion(this)">Wykres Telemetryczny</button>
            <div class="accordion-content">
                <div id="chart-wrapper"><canvas id="telemetryChart"></canvas></div>
                <div class="chart-controls" id="chartControls"></div>
            </div>
        </div>
    </div>

<script>
    // =======================================================================================
    // WERSJA PID-DUAL-CORE v1.1 DEFINITYWNA (UI)
    // =======================================================================================

    // --- ZMIENNE GLOBALNE I MAPOWANIE ---
    const debouncedSenders = {};
    const parameterMapping = {
        'balanceKpInput': 'kp_b', 'balanceKiInput': 'ki_b', 'balanceKdInput': 'kd_b', 'joystickAngleSensitivityInput': 'angle_sensitivity', 'balancePidDerivativeFilterAlphaInput': 'filter_alpha',
        'speedKpInput': 'kp_s', 'speedKiInput': 'ki_s', 'speedKdInput': 'kd_s', 'maxTargetAngleFromSpeedPIDInput': 'max_target_angle', 'speedPidDeadbandInput': 'deadband_s',
        'positionKpInput': 'kp_p', 'positionKiInput': 'ki_p', 'positionKdInput': 'kd_p', 'maxTargetSpeedFromPosPIDInput': 'max_target_speed', 'positionPidDeadbandInput': 'deadband_p',
        'rotationKpInput': 'kp_r', 'rotationKdInput': 'kd_r', 'headingKpInput': 'kp_h', 'headingKiInput': 'ki_h', 'headingKdInput': 'kd_h', 'rollKpInput': 'kp_roll', 'rollKiInput': 'ki_roll', 'rollKdInput': 'kd_roll',
        'wheelDiameterCmInput': 'wheel_diameter', 'trackWidthCmInput': 'track_width', 'encoderPprInput': 'ppr', 'motorBacklashImpulsesInput': 'backlash', 'turnToRollTargetInput': 'turn_to_roll_target', 'balanceDeadbandAngleInput': 'balance_deadband_angle',
        'minPwmLeftFwdInput': 'min_pwm_left_fwd', 'minPwmLeftBwdInput': 'min_pwm_left_bwd', 'minPwmRightFwdInput': 'min_pwm_right_fwd', 'minPwmRightBwdInput': 'min_pwm_right_bwd',
        'joystickSensitivityInput': 'sensitivity', 'expoJoystickInput': 'expo', 'maxSpeedJoystickInput': 'maxSpeed', 'turnFactorInput': 'turnFactor', 'joystickDeadzoneInput': 'deadzone'
    };
    let lastKnownRobotState = 'IDLE';

    // --- KONFIGURACJA POCZATKOWA ---
    document.addEventListener('DOMContentLoaded', () => {
        initJoystick();
        setupChartControls();
        populatePresetSelect();
        setupNumericInputs();
        setupEventListeners();
        setupSequenceControls();
        setupManualTuneButtons();
        TuningAssistant.init();
        window.addEventListener('resize', initJoystick);
        document.querySelectorAll('.accordion-header.active').forEach(header => {
            const content = header.nextElementSibling;
            if (content) { content.style.maxHeight = content.scrollHeight + "px"; }
        });
    });

    // --- PRESETY PID ---
    const CUSTOM_PRESET_PREFIX = 'pid_custom_preset_v1_';
    const builtInPresetsData = {
      '1': { name: "1. Zbalansowany (Startowy)", params: { balanceKpInput: 95, balanceKiInput: 0, balanceKdInput: 3.23, speedKpInput: 0.05, positionKpInput: 2.5, rollKpInput: 15.0, rollKdInput: 0.5 } },
      '2': { name: "2. Agresywny / Sztywny", params: { balanceKpInput: 120, balanceKiInput: 0, balanceKdInput: 4.0, speedKpInput: 0.08, positionKpInput: 3.5, rollKpInput: 20.0, rollKdInput: 0.8 } },
      '3': { name: "3. Plynny / Miekki", params: { balanceKpInput: 70, balanceKiInput: 0, balanceKdInput: 2.8, speedKpInput: 0.03, positionKpInput: 1.8, rollKpInput: 10.0, rollKdInput: 0.3 } },
    };

    // --- ZMIENNE BLE ---
    let bleDevice, rxCharacteristic, txCharacteristic;
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const RX_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a9";
    const TX_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    let bleBuffer = '';

    // --- JOYSTICK ---
    const joystickCanvas = document.getElementById('joystickCanvas');
    const joystickCtx = joystickCanvas.getContext('2d');
    let joystickCenter, joystickRadius, knobRadius, isDragging = false;
    let lastJoystickSendTime = 0;
    const JOYSTICK_SEND_INTERVAL = 30;

    // --- TELEMETRIA I WYKRES ---
    const availableTelemetry = {
      'pitch': { label: 'Pitch (Kat)', color: '#61dafb' },
      'target_angle': { label: 'Zadany Kat', color: '#a2f279' },
      'speed': { label: 'Predkosc', color: '#f7b731' },
      'balance_output': { label: 'Wyjscie PID Balansu', color: '#ff9ff3' },
    };
    const telemetryChart = new Chart(document.getElementById('telemetryChart'), { type: 'line', data: { labels: Array(100).fill(''), datasets: [] }, options: { animation: false, responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { ticks: { color: '#61dafb' } } }, plugins: { legend: { labels: { color: '#fff' } } } } });

    // --- Funkcje UI, BLE, Joystick, Presety (bez zmian) ---
    function initJoystick() { const wrapper = document.getElementById('joystickWrapper'); const size = wrapper.clientWidth; joystickCanvas.width = size; joystickCanvas.height = size; joystickCenter = { x: size / 2, y: size / 2 }; joystickRadius = size / 2 * 0.75; knobRadius = size / 2 * 0.25; drawJoystick(joystickCenter.x, joystickCenter.y); }
    function drawJoystick(x, y) { joystickCtx.clearRect(0, 0, joystickCanvas.width, joystickCanvas.height); joystickCtx.beginPath(); joystickCtx.arc(joystickCenter.x, joystickCenter.y, joystickRadius, 0, 2 * Math.PI); joystickCtx.fillStyle = 'rgba(255, 255, 255, 0.1)'; joystickCtx.fill(); joystickCtx.beginPath(); joystickCtx.arc(x, y, knobRadius, 0, 2 * Math.PI); joystickCtx.fillStyle = '#61dafb'; joystickCtx.fill(); }
    function getJoystickPosition(event) { const rect = joystickCanvas.getBoundingClientRect(); const touch = event.touches ? event.touches[0] : event; return { x: touch.clientX - rect.left, y: touch.clientY - rect.top }; }
    function handleJoystickStart(event) { event.preventDefault(); isDragging = true; }
    function handleJoystickMove(event) { if (!isDragging) return; event.preventDefault(); let { x, y } = getJoystickPosition(event); const dx = x - joystickCenter.x; const dy = y - joystickCenter.y; const distance = Math.sqrt(dx * dx + dy * dy); if (distance > joystickRadius) { x = joystickCenter.x + (dx / distance) * joystickRadius; y = joystickCenter.y + (dy / distance) * joystickRadius; } drawJoystick(x, y); const now = Date.now(); if (now - lastJoystickSendTime > JOYSTICK_SEND_INTERVAL) { const joyX = (x - joystickCenter.x) / joystickRadius; const joyY = -(y - joystickCenter.y) / joystickRadius; sendBleMessage({ type: 'joystick', x: joyX, y: joyY }); lastJoystickSendTime = now; } }
    function handleJoystickEnd(event) { if (!isDragging) return; event.preventDefault(); isDragging = false; drawJoystick(joystickCenter.x, joystickCenter.y); sendBleMessage({ type: 'joystick', x: 0, y: 0 }); }
    const debounce = (func, delay) => { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; };
    function addLogMessage(message, level = 'info') { const logHistory = document.getElementById('log-history'); if (!logHistory) return; const timestamp = new Date().toLocaleTimeString(); let color = '#fff'; if (level === 'error') color = '#ff6347'; else if (level === 'warn') color = '#f7b731'; else if (level === 'success') color = '#a2f279'; const logEntry = document.createElement('div'); logEntry.style.color = color; logEntry.textContent = `[${timestamp}] ${message}`; logHistory.prepend(logEntry); }
    function clearLogs() { document.getElementById('log-history').innerHTML = ''; }
    function toggleAccordion(header) { const content = header.nextElementSibling; header.classList.toggle('active'); if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = '0px'; } else { content.style.maxHeight = content.scrollHeight + "px"; } }
    function updateAccordionHeight(content) { if (content && content.style.maxHeight !== '0px') { content.style.maxHeight = content.scrollHeight + 'px'; } }
    async function connectBLE() { addLogMessage('[UI] Prosze o wybranie urzadzenia Bluetooth...', 'info'); try { bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] }); addLogMessage(`[UI] Laczenie z ${bleDevice.name}...`, 'info'); document.getElementById('connectBleBtn').disabled = true; document.getElementById('connectionText').textContent = 'Laczenie...'; bleDevice.addEventListener('gattserverdisconnected', onDisconnected); const server = await bleDevice.gatt.connect(); const service = await server.getPrimaryService(SERVICE_UUID); rxCharacteristic = await service.getCharacteristic(RX_UUID); txCharacteristic = await service.getCharacteristic(TX_UUID); await txCharacteristic.startNotifications(); txCharacteristic.addEventListener('characteristicvaluechanged', handleBleNotification); document.getElementById('connectionStatus').className = 'status-indicator status-ok'; document.getElementById('connectionText').textContent = 'Polaczony'; addLogMessage('[UI] Polaczono! Pobieram konfiguracje...', 'success'); } catch (error) { addLogMessage(`[UI] Blad polaczenia BLE: ${error}`, 'error'); onDisconnected(); } }
    function onDisconnected() { addLogMessage('[UI] Rozlaczono z robotem.', 'warn'); document.getElementById('connectionStatus').className = 'status-indicator status-disconnected'; document.getElementById('connectionText').textContent = 'Rozlaczony'; ['balanceSwitch', 'holdPositionSwitch', 'speedModeSwitch'].forEach(id => document.getElementById(id).checked = false); document.getElementById('connectBleBtn').disabled = false; rxCharacteristic = null; txCharacteristic = null; }
    function handleBleNotification(event) { const value = new TextDecoder().decode(event.target.value); bleBuffer += value; let newlineIndex; while ((newlineIndex = bleBuffer.indexOf('\n')) !== -1) { const line = bleBuffer.substring(0, newlineIndex).trim(); bleBuffer = bleBuffer.substring(newlineIndex + 1); if (line) { try { const data = JSON.parse(line); processCompleteMessage(data); } catch (e) { addLogMessage(`[UI] Blad parsowania JSON: ${line}`, 'error'); } } } }
    async function sendBleMessage(message) { if (!rxCharacteristic) return; try { await rxCharacteristic.writeValueWithoutResponse(new TextEncoder().encode(JSON.stringify(message) + '\n')); } catch (error) { addLogMessage(`[UI] Blad wysylania danych BLE: ${error}`, 'error'); } }
    function populatePresetSelect() { const select = document.getElementById('pidPresetSelect'); select.innerHTML = ''; for (const [index, preset] of Object.entries(builtInPresetsData)) { const option = document.createElement('option'); option.value = index; option.textContent = preset.name; select.appendChild(option); } for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith(CUSTOM_PRESET_PREFIX)) { const presetName = key.substring(CUSTOM_PRESET_PREFIX.length); const option = document.createElement('option'); option.value = key; option.textContent = `Wlasny: ${presetName}`; select.appendChild(option); } } }
    function applySelectedPreset() { const select = document.getElementById('pidPresetSelect'); const selectedValue = select.value; let presetData; if (selectedValue.startsWith(CUSTOM_PRESET_PREFIX)) { presetData = JSON.parse(localStorage.getItem(selectedValue)); } else { presetData = builtInPresetsData[selectedValue]?.params; } if (presetData) { for (const [inputId, value] of Object.entries(presetData)) { const input = document.getElementById(inputId); if (input) { input.value = value; input.dispatchEvent(new Event('change', { bubbles: true })); } } addLogMessage('[UI] Zastosowano wartosci presetu.', 'info'); } }
    function saveCurrentAsPreset() { const presetName = prompt("Podaj nazwe dla nowego presetu:", ""); if (presetName && presetName.trim() !== "") { const presetData = {}; document.querySelectorAll('#allSettings input[type=number]').forEach(input => { presetData[input.id] = parseFloat(input.value); }); localStorage.setItem(CUSTOM_PRESET_PREFIX + presetName.trim(), JSON.stringify(presetData)); addLogMessage(`[UI] Zapisano wlasny preset '${presetName.trim()}'.`, 'success'); populatePresetSelect(); } }
    function deleteSelectedPreset() { const select = document.getElementById('pidPresetSelect'); const selectedValue = select.value; if (!selectedValue.startsWith(CUSTOM_PRESET_PREFIX)) { addLogMessage('[UI] Nie mozna usunac wbudowanego presetu.', 'warn'); return; } if (confirm(`Czy na pewno chcesz usunac preset?`)) { localStorage.removeItem(selectedValue); addLogMessage(`[UI] Usunieto preset.`, 'info'); populatePresetSelect(); } }
    function setupNumericInputs() { document.querySelectorAll('.numeric-input-wrapper').forEach(wrapper => { const input = wrapper.querySelector('input[type=number]'); const minusBtn = wrapper.querySelector('button:first-child'); const plusBtn = wrapper.querySelector('button:last-child'); if (!input || !minusBtn || !plusBtn) return; const step = parseFloat(input.step) || 1; const updateValue = (amount) => { let current = parseFloat(input.value) || 0; let newValue = current + amount; const min = parseFloat(input.min); const max = parseFloat(input.max); if (!isNaN(min)) newValue = Math.max(min, newValue); if (!isNaN(max)) newValue = Math.min(max, newValue); input.value = newValue.toFixed(input.step.includes('.') ? (input.step.split('.')[1] || '').length : 0); input.dispatchEvent(new Event('change', { bubbles: true })); }; minusBtn.addEventListener('click', () => updateValue(-step)); plusBtn.addEventListener('click', () => updateValue(step)); }); }
    
    // --- Przetwarzanie wiadomosci i aktualizacja UI ---
    let tunerAckTimeout = null;
    function processCompleteMessage(data) {
        let previousRobotState = lastKnownRobotState;
        if (data.type === 'telemetry' && data.robot_state) {
            lastKnownRobotState = data.robot_state;
        }

        switch (data.type) {
            case 'telemetry': updateTelemetryUI(data); updateChart(data); checkAndExecuteNextSequenceStep(previousRobotState); break;
            case 'full_config': applyFullConfig(data.params); addLogMessage("[UI] Konfiguracja zsynchronizowana z robotem.", "info"); break;
            case 'log': addLogMessage(`[ROBOT] ${data.message}`, data.level); break;
            case 'single_pwm_result': handleSinglePwmResult(data.params); break;
            case 'tuner_result': if (TuningAssistant.resolveTestPromise) { TuningAssistant.resolveTestPromise(data); } break;
            case 'tuner_ack': if (data.status === 'ready_for_trigger') { clearTimeout(tunerAckTimeout); TuningAssistant.onReadyForTest(); } break;
        }
    }

    function applyFullConfig(params) { if (!params) return; for (const [inputId, jsonKey] of Object.entries(parameterMapping)) { const input = document.getElementById(inputId); if (input && params[jsonKey] !== undefined) { let value = params[jsonKey]; if (['turnFactor', 'expo', 'sensitivity', 'deadzone'].includes(jsonKey)) { value *= 100; } input.value = value; } } }
    function updateTelemetryUI(data) { if (data.robot_state !== undefined) document.getElementById('robotStateVal').textContent = data.robot_state; if (data.pitch !== undefined) { document.getElementById('angleVal').textContent = data.pitch.toFixed(1) + ' \u00B0'; document.getElementById('angleIndicator').style.transform = `rotate(${data.pitch}deg)`; } if (data.speed !== undefined) document.getElementById('speedVal').textContent = parseFloat(data.speed).toFixed(0); if (data.target_angle !== undefined) document.getElementById('targetAngleVal').textContent = parseFloat(data.target_angle).toFixed(1) + ' \u00B0'; if (data.balance_output !== undefined) document.getElementById('balanceOutputVal').textContent = parseFloat(data.balance_output).toFixed(2); if (data.encoder_left !== undefined) document.getElementById('encoderLeftVal').textContent = data.encoder_left; if (data.encoder_right !== undefined) document.getElementById('encoderRightVal').textContent = data.encoder_right; document.getElementById('emergency-banner').style.display = data.emergency_stop ? 'block' : 'none'; }
    function updateChart(data) { const chartData = telemetryChart.data; if (chartData.labels.length >= 100) chartData.labels.shift(); chartData.labels.push(''); for (const [key, value] of Object.entries(data)) { if (availableTelemetry[key] && value !== undefined) { let dataset = chartData.datasets.find(ds => ds.label === availableTelemetry[key].label); if (!dataset) continue; if (dataset.data.length >= 100) dataset.data.shift(); dataset.data.push(value); } } chartData.datasets.forEach(ds => { if (ds.data.length < chartData.labels.length) { if (ds.data.length >= 100) ds.data.shift(); ds.data.push(null); } }); telemetryChart.update('none'); }
    function setupChartControls() { const container = document.getElementById('chartControls'); container.innerHTML = ''; Object.keys(availableTelemetry).forEach((key) => { const label = document.createElement('label'), checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = key; checkbox.checked = (key === 'pitch' || key === 'target_angle'); checkbox.addEventListener('change', (e) => { const varName = e.target.value; if (e.target.checked) { const chartData = telemetryChart.data; if (!chartData.datasets.find(ds => ds.label === availableTelemetry[varName].label)) { const axisId = (varName.includes('output') || varName.includes('out')) ? 'y1' : 'y'; chartData.datasets.push({ label: availableTelemetry[varName].label, data: Array(chartData.labels.length).fill(null), borderColor: availableTelemetry[varName].color, fill: false, tension: 0.1, pointRadius: 0, yAxisID: axisId }); } } else { const chartData = telemetryChart.data; const datasetIndex = chartData.datasets.findIndex(ds => ds.label === availableTelemetry[varName].label); if (datasetIndex > -1) { chartData.datasets.splice(datasetIndex, 1); } } telemetryChart.update(); }); label.appendChild(checkbox); label.append(` ${availableTelemetry[key].label}`); container.appendChild(label); if (checkbox.checked) { checkbox.dispatchEvent(new Event('change')); } }); }
    function handleSinglePwmResult(params) { const inputId = `minPwm${params.motor.charAt(0).toUpperCase() + params.motor.slice(1)}${params.direction.charAt(0).toUpperCase() + params.direction.slice(1)}Input`; const inputField = document.getElementById(inputId); if (inputField) { inputField.value = params.value; addLogMessage(`[UI] Auto-strojenie dla ${params.motor} ${params.direction} zakonczone. Wynik: ${params.value}`, 'success'); debouncedSenders['set_min_pwm'](); const autoBtn = inputField.closest('.manual-tune-row').querySelector('.auto-btn'); if(autoBtn) { autoBtn.disabled = false; autoBtn.textContent = 'Auto'; } } }

    // --- LOGIKA ASYSTENTA STROJENIA ---
    const TuningAssistant = {
        // ( Implementacja TuningAssistant - patrz nizej )
    };

    // --- Reszta funkcji... (Sekwencje, MinPWM, EventListeners) ---
    // ...
</script>

<script>
    // Wydzielony skrypt dla czytelnosci - ASYSTENT, SEKWENCJE i EVENT LISTENERS

    let isSequenceRunning = false;
    let currentSequenceStep = 0;
    const MAX_SEQUENCE_STEPS = 10;

    const TuningAssistant = {
        state: {}, activeMode: 'balance', isRunning: false, isLooping: false, resolveTestPromise: null, currentTestParams: null,
        tuningModes: { 
            'balance': { label: 'Strojenie Balansu Statycznego', params: { 'balanceKpInput': { step: 1 }, 'balanceKdInput': { step: 0.05 } } },
            'impulse': { label: 'Strojenie Reakcji na Zaklocenia', params: { 'balanceKpInput': { step: 1 }, 'balanceKdInput': { step: 0.05 }, 'rollKpInput': { step: 0.5 } } },
            'drive': { label: 'Strojenie Jazdy Autonomicznej', params: { 'speedKpInput': { step: 0.005 }, 'positionKpInput': { step: 0.1 }, 'positionKdInput': { step: 0.1 } } }
        },
        init() { for (const mode in this.tuningModes) { this.state[mode] = { sessionActive: false, bestParams: null, bestFitness: -Infinity, currentIteration: 0, totalIterations: 20 }; } this.setMode('balance'); },
        setMode(newMode) { if (this.isRunning) return; this.activeMode = newMode; document.querySelectorAll('.tuning-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === newMode)); document.getElementById('tuningImpulseSettings').style.display = (newMode === 'impulse') ? 'block' : 'none'; document.getElementById('tuningDriveSettings').style.display = (newMode === 'drive') ? 'block' : 'none'; this.updateUI(); },
        updateUI() { const s = this.state[this.activeMode]; s.totalIterations = parseInt(document.getElementById('tuningIterationsInput').value); document.getElementById('tuning-progress-bar').style.width = `${(s.currentIteration / s.totalIterations) * 100}%`; const bestParamsText = s.bestParams ? Object.entries(s.bestParams).map(([k, v]) => `${k.replace('Input', '')}: ${v.toFixed(4)}`).join('\n') : "Najlepsze parametry pojawia sie tutaj..."; document.getElementById('tuning-best-params-display').textContent = bestParamsText; },
        async runSingleTest() { if (this.isRunning) return; this.isRunning = true; this.setUiLock(true); try { const s = this.state[this.activeMode]; if (!s.sessionActive) { await this.startNewSession(); } if (s.currentIteration >= s.totalIterations) { this.stop(); return; } this.currentTestParams = this.generateNextParams(); await this.applyParamsToRobot(this.currentTestParams); const result = await this.prepareAndRunTest(); this.processResult(result); } catch(error) { addLogMessage(`[UI] Blad podczas testu: ${error}`, 'error'); this.stop(true); } if (!this.isLooping) { this.stop(false); } },
        async runTestLoop(count) { if (this.isLooping || this.isRunning) { this.isLooping = false; return; } this.isLooping = true; this.setUiLock(true); for (let i = 0; i < count; i++) { if (!this.isLooping) break; document.getElementById('run5TestsBtn').textContent = `Stop (${count - i - 1})`; await this.runSingleTest(); } this.isLooping = false; this.stop(false); },
        stop(userInitiated) { this.isRunning = false; this.isLooping = false; document.getElementById('run5TestsBtn').textContent = 'Uruchom 5 Prob'; this.setUiLock(false); document.getElementById('tuning-status-text').textContent = userInitiated ? 'Zatrzymano.' : 'Zakonczono.'; },
        async startNewSession() { const s = this.state[this.activeMode]; const initialParams = {}; Object.keys(this.tuningModes[this.activeMode].params).forEach(id => initialParams[id] = parseFloat(document.getElementById(id).value)); s.bestParams = { ...initialParams }; s.currentIteration = 0; s.sessionActive = true; addLogMessage(`[UI] Rozpoczeto nowa sesje strojenia dla trybu "${this.tuningModes[this.activeMode].label}".`, 'success'); document.getElementById('tuning-status-text').textContent = 'Testuje parametry bazowe...'; const baseResult = await this.prepareAndRunTest(); s.bestFitness = baseResult.fitness; addLogMessage(`[UI] Zapisano bazowy fitness: ${s.bestFitness.toFixed(4)}`, 'success'); this.updateUI(); },
        generateNextParams() { const s = this.state[this.activeMode]; const paramDefs = this.tuningModes[this.activeMode].params; const paramKeys = Object.keys(paramDefs); const stepMultiplier = parseFloat(document.getElementById('tuningStepMultiplierInput').value); let nextParams = { ...s.bestParams }; const paramToChange = paramKeys[s.currentIteration % paramKeys.length]; const change = (Math.random() > 0.5 ? 1 : -1) * paramDefs[paramToChange].step * stepMultiplier; nextParams[paramToChange] += change; return nextParams; },
        async applyParamsToRobot(params) { const paramGroups = {}; for(const [inputId, value] of Object.entries(params)) { for(const [type, keys] of Object.entries(this.getDebouncerConfig())) { if(keys.includes(inputId)) { if(!paramGroups[type]) paramGroups[type] = {}; paramGroups[type][parameterMapping[inputId]] = value; break; } } } for(const [type, groupParams] of Object.entries(paramGroups)) { await sendBleMessage({ type: type, params: groupParams }); } await new Promise(r => setTimeout(r, 100)); }, // Opóźnienie na ACK
        async prepareAndRunTest() { await sendBleMessage({type: 'tuner_prepare'}); return new Promise(resolve => { this.resolveTestPromise = (result) => resolve(result); tunerAckTimeout = setTimeout(() => addLogMessage('[UI] Timeout oczekiwania na ACK!', 'error'), 3000); }); },
        onReadyForTest() { document.getElementById('tuning-status-text').textContent = `Robot gotowy. Uruchamiam test...`; this.triggerTest(); },
        async triggerTest() { await sendBleMessage({ type: 'balance_toggle', enabled: true }); await new Promise(r => setTimeout(r, 200)); if (this.activeMode === 'impulse') { await sendBleMessage({ type: 'tuner_set_impulse', power: parseFloat(document.getElementById('tuningImpulsePowerInput').value) }); } if (this.activeMode === 'drive') { await sendBleMessage({ type: 'tuner_set_drive', distance: parseFloat(document.getElementById('tuningDriveDistanceInput').value) }); } const testDuration = parseInt(document.getElementById('tuningTestDurationInput').value); await sendBleMessage({ type: 'tuner_run_test', mode: this.activeMode, duration_s: testDuration }); },
        processResult(result) { const s = this.state[this.activeMode]; addLogMessage(`[UI] Otrzymano wynik (fitness): ${result.fitness.toFixed(4)}`, 'info'); if (result.fitness > s.bestFitness) { addLogMessage(`[UI] Poprawa! Nowy najlepszy fitness: ${result.fitness.toFixed(4)}`, 'success'); s.bestFitness = result.fitness; s.bestParams = { ...this.currentTestParams }; } else { addLogMessage(`[UI] Brak poprawy. Odrzucam zmiany.`, 'warn'); } s.currentIteration++; this.updateUI(); },
        applyBestParams() { const s = this.state[this.activeMode]; if (!s.bestParams) return; this.applyParamsToRobot(s.bestParams); Object.entries(s.bestParams).forEach(([id, val]) => document.getElementById(id).value = val); addLogMessage(`[UI] Zastosowano najlepsze znalezione parametry.`, 'success'); },
        setUiLock(isLocked) { document.querySelectorAll('#startTuningBtn, #run5TestsBtn, #applyBestBtn, .tuning-mode-btn').forEach(el => el.disabled = isLocked); document.getElementById('stopTuningBtn').disabled = !isLocked; if (isLocked) document.getElementById('run5TestsBtn').textContent = 'Stop'; else document.getElementById('run5TestsBtn').textContent = 'Uruchom 5 Prob'; },
        getDebouncerConfig() { return { 'balance_pid_update': ['balanceKpInput', 'balanceKiInput', 'balanceKdInput', 'joystickAngleSensitivityInput', 'balancePidDerivativeFilterAlphaInput'], 'speed_pid_update': ['speedKpInput', 'speedKiInput', 'speedKdInput', 'maxTargetAngleFromSpeedPIDInput', 'speedPidDeadbandInput'], 'position_pid_update': ['positionKpInput', 'positionKiInput', 'positionKdInput', 'maxTargetSpeedFromPosPIDInput', 'positionPidDeadbandInput'], 'roll_pid_update': ['rollKpInput', 'rollKiInput', 'rollKdInput'] }; }
    };

    function setupManualTuneButtons() { document.querySelectorAll('.manual-tune-row').forEach(row => { const motor = row.dataset.motor; const direction = row.dataset.direction; const autoBtn = row.querySelector('.auto-btn'); autoBtn.addEventListener('click', (e) => { if (confirm("UWAGA! Upewnij sie, ze robot jest uniesiony. Kontynuowac?")) { const startValue = parseInt(document.getElementById('pwmTuneStartInput').value); sendBleMessage({ type: 'autotune_single_pwm', motor, direction, start_pwm: startValue }); e.target.disabled = true; e.target.textContent = 'Szukanie...'; addLogMessage(`[UI] Rozpoczynam auto-strojenie dla ${motor} ${direction}...`, 'info'); } }); }); }
    function setupSequenceControls() { document.getElementById('add-sequence-step-btn').addEventListener('click', addSequenceStep); document.getElementById('run-sequence-btn').addEventListener('click', runSequence); document.getElementById('stop-sequence-btn').addEventListener('click', stopSequenceExecution); document.getElementById('clear-sequence-btn').addEventListener('click', clearSequence); }
    function addSequenceStep() { const list = document.getElementById('sequence-list'); if (list.children.length >= MAX_SEQUENCE_STEPS) return; const stepDiv = document.createElement('div'); stepDiv.className = 'sequence-step'; stepDiv.innerHTML = ` <select class="sequence-type"> <option value="move_fwd">Przod (cm)</option><option value="move_bwd">Tyl (cm)</option> <option value="rotate_r">Obrot Prawo (st.)</option><option value="rotate_l">Obrot Lewo (st.)</option> </select> <input type="number" class="sequence-value" value="20"> <button class="remove-step-btn">&times;</button> `; list.appendChild(stepDiv); updateAccordionHeight(list.closest('.accordion-content')); stepDiv.querySelector('.remove-step-btn').addEventListener('click', () => { stepDiv.remove(); updateAccordionHeight(list.closest('.accordion-content')); }); }
    function runSequence() { if (isSequenceRunning) return; const steps = document.querySelectorAll('.sequence-step'); if (steps.length === 0) return; isSequenceRunning = true; currentSequenceStep = 0; updateSequenceUI(); addLogMessage(`[UI] Rozpoczeto sekwencje z ${steps.length} krokow.`, 'info'); executeNextSequenceStep(); }
    function stopSequenceExecution() { if (!isSequenceRunning) return; isSequenceRunning = false; sendBleMessage({ type: 'command_stop' }); updateSequenceUI(); addLogMessage('[UI] Sekwencja zatrzymana.', 'warn'); }
    function clearSequence() { if (isSequenceRunning) stopSequenceExecution(); const list = document.getElementById('sequence-list'); list.innerHTML = ''; updateAccordionHeight(list.closest('.accordion-content')); }
    function updateSequenceUI() { document.querySelectorAll('.sequence-step').forEach((step, index) => { step.classList.toggle('executing', isSequenceRunning && index === currentSequenceStep); }); document.getElementById('run-sequence-btn').disabled = isSequenceRunning; document.getElementById('add-sequence-step-btn').disabled = isSequenceRunning; document.getElementById('clear-sequence-btn').disabled = isSequenceRunning; document.getElementById('stop-sequence-btn').disabled = !isSequenceRunning; }
    function checkAndExecuteNextSequenceStep(previousState) { if (!isSequenceRunning) return; const isRobotIdle = lastKnownRobotState.includes('IDLE') || lastKnownRobotState.includes('HOLDING'); const wasRobotWorking = previousState.includes('MOVE') || previousState.includes('ROTATE'); if (isRobotIdle && wasRobotWorking) { addLogMessage(`[UI] Krok ${currentSequenceStep + 1} zakonczony.`, 'info'); currentSequenceStep++; executeNextSequenceStep(); } }
    function executeNextSequenceStep() { const steps = document.querySelectorAll('.sequence-step'); if (!isSequenceRunning || currentSequenceStep >= steps.length) { if (isSequenceRunning) { isSequenceRunning = false; addLogMessage('[UI] Sekwencja ukonczona.', 'success'); } updateSequenceUI(); return; } updateSequenceUI(); const stepNode = steps[currentSequenceStep]; const type = stepNode.querySelector('.sequence-type').value; const value = parseFloat(stepNode.querySelector('.sequence-value').value); let command = {}; switch (type) { case 'move_fwd': command = { type: 'execute_move', distance_cm: value }; break; case 'move_bwd': command = { type: 'execute_move', distance_cm: -value }; break; case 'rotate_r': command = { type: 'execute_rotate', angle_deg: value }; break; case 'rotate_l': command = { type: 'execute_rotate', angle_deg: -value }; break; } sendBleMessage(command); }
    
    function setupEventListeners() {
        joystickCanvas.addEventListener('mousedown', handleJoystickStart); document.addEventListener('mousemove', handleJoystickMove); document.addEventListener('mouseup', handleJoystickEnd);
        joystickCanvas.addEventListener('touchstart', handleJoystickStart, { passive: false }); document.addEventListener('touchmove', handleJoystickMove, { passive: false }); document.addEventListener('touchend', handleJoystickEnd);
        document.getElementById('connectBleBtn').addEventListener('click', connectBLE);
        ['balanceSwitch', 'holdPositionSwitch', 'speedModeSwitch'].forEach(id => { document.getElementById(id).addEventListener('change', (e) => { const typeMap = { 'balanceSwitch': 'balance_toggle', 'holdPositionSwitch': 'hold_position_toggle', 'speedModeSwitch': 'speed_mode_toggle' }; sendBleMessage({ type: typeMap[id], enabled: e.target.checked }); }); });
        document.getElementById('resetZeroBtn').addEventListener('click', () => sendBleMessage({ type: 'reset_zero' }));
        document.getElementById('trimPlusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_zero', value: 1 }));
        document.getElementById('trimMinusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_zero', value: -1 }));
        document.getElementById('trimRollPlusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_roll', value: 1 }));
        document.getElementById('trimRollMinusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_roll', value: -1 }));
        document.getElementById('emergencyStopBtn').addEventListener('click', () => sendBleMessage({ type: 'emergency_stop' }));
        document.getElementById('calibrateMpuBtn').addEventListener('click', () => sendBleMessage({ type: 'calibrate_mpu' }));
        document.getElementById('resetEncodersBtn').addEventListener('click', () => sendBleMessage({ type: 'reset_encoders' }));
        document.querySelectorAll('.dpad-btn').forEach(btn => { btn.addEventListener('click', (e) => { const action = e.currentTarget.dataset.dpad; if (action === 'up') sendBleMessage({ type: 'execute_move', distance_cm: parseFloat(document.getElementById('dpadDistInput').value) }); else if (action === 'down') sendBleMessage({ type: 'execute_move', distance_cm: -parseFloat(document.getElementById('dpadDistInput').value) }); else if (action === 'left') sendBleMessage({ type: 'execute_rotate', angle_deg: -parseFloat(document.getElementById('dpadAngleInput').value) }); else if (action === 'right') sendBleMessage({ type: 'execute_rotate', angle_deg: parseFloat(document.getElementById('dpadAngleInput').value) }); else if (action === 'stop') sendBleMessage({ type: 'command_stop' }); }); });
        document.getElementById('saveBtn').addEventListener('click', () => sendBleMessage({ type: 'save_tunings' }));
        document.getElementById('loadBtn').addEventListener('click', () => { if (confirm("Spowoduje to nadpisanie niezapisanych zmian. Kontynuowac?")) sendBleMessage({ type: 'load_from_eeprom' }); });
        document.getElementById('applySelectedPresetBtn').addEventListener('click', applySelectedPreset);
        document.getElementById('saveCurrentAsPresetBtn').addEventListener('click', saveCurrentAsPreset);
        document.getElementById('deleteSelectedPresetBtn').addEventListener('click', deleteSelectedPreset);
        const configGroups = { 'balance_pid_update': ['balanceKpInput', 'balanceKiInput', 'balanceKdInput', 'joystickAngleSensitivityInput', 'balancePidDerivativeFilterAlphaInput'], 'speed_pid_update': ['speedKpInput', 'speedKiInput', 'speedKdInput', 'maxTargetAngleFromSpeedPIDInput', 'speedPidDeadbandInput'], 'position_pid_update': ['positionKpInput', 'positionKiInput', 'positionKdInput', 'maxTargetSpeedFromPosPIDInput', 'positionPidDeadbandInput'], 'rotation_pid_update': ['rotationKpInput', 'rotationKdInput'], 'heading_pid_update': ['headingKpInput', 'headingKiInput', 'headingKdInput'], 'roll_pid_update': ['rollKpInput', 'rollKiInput', 'rollKdInput'], 'calibration_update': ['wheelDiameterCmInput', 'trackWidthCmInput', 'encoderPprInput', 'motorBacklashImpulsesInput', 'turnToRollTargetInput', 'balanceDeadbandAngleInput'], 'set_joystick_tuning': ['joystickSensitivityInput', 'expoJoystickInput', 'maxSpeedJoystickInput', 'turnFactorInput', 'joystickDeadzoneInput'], 'set_min_pwm': ['minPwmLeftFwdInput', 'minPwmLeftBwdInput', 'minPwmRightFwdInput', 'minPwmRightBwdInput'] };
        for (const [type, keys] of Object.entries(configGroups)) { debouncedSenders[type] = debounce(() => { const params = {}; keys.forEach(inputId => { const input = document.getElementById(inputId); if (input) { const jsonKey = parameterMapping[inputId]; let value = parseFloat(input.value); if (['turnFactor', 'expo', 'sensitivity', 'deadzone'].includes(jsonKey)) { value /= 100.0; } params[jsonKey] = value; } }); sendBleMessage({ type, params }); }, 350); keys.forEach(inputId => { const input = document.getElementById(inputId); if (input) input.addEventListener('change', debouncedSenders[type]); }); }
        document.querySelectorAll('.help-icon').forEach(icon => { icon.addEventListener('click', (e) => { e.stopPropagation(); const helpText = icon.closest('.setting-container').querySelector('.help-text'); if (helpText) { helpText.classList.toggle('visible'); updateAccordionHeight(helpText.closest('.accordion-content')); } }); });
        document.querySelectorAll('.tuning-mode-btn').forEach(btn => btn.addEventListener('click', () => TuningAssistant.setMode(btn.dataset.mode)));
        document.getElementById('startTuningBtn').addEventListener('click', () => TuningAssistant.runSingleTest());
        document.getElementById('run5TestsBtn').addEventListener('click', () => TuningAssistant.runTestLoop(5));
        document.getElementById('stopTuningBtn').addEventListener('click', () => TuningAssistant.stop(true));
        document.getElementById('applyBestBtn').addEventListener('click', () => TuningAssistant.applyBestParams());
        document.getElementById('tuningSaveSafeBaseBtn').addEventListener('click', () => { sendBleMessage({ type: 'tuner_save_safe_params' }); addLogMessage('[UI] Wyslano polecenie zapisu bezpiecznej bazy.', 'info'); });
        document.getElementById('tuningRestoreSafeBaseBtn').addEventListener('click', () => { if (confirm("Spowoduje to przywrocenie bezpiecznych parametrow. Kontynuowac?")) { sendBleMessage({ type: 'tuner_restore_safe_params' }); addLogMessage('[UI] Wyslano polecenie przywrocenia bazy.', 'info'); setTimeout(() => sendBleMessage({ type: 'load_from_eeprom' }), 500); } });
    }
</script>

</body>
</html>