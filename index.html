<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Robot LQR - Panel Sterowania v32.6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 15px; background-color: #282c34; color: #fff; font-size: 14px; }
        h1 { color: #61dafb; font-size: 1.8em; }
        h2 { color: #61dafb; font-size: 1.4em; margin-top: 0; margin-bottom: 15px; }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 15px; align-items: start; max-width: 1920px; margin: auto; }
        .card { background-color: #3a3f47; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .info-grid, .status-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px; text-align: left; font-size: 1em; margin-top: 10px; align-items: center;}
        .info-grid strong, .status-grid strong { color: #a2f279; }
        button { background-color: #61dafb; color: #282c34; border: none; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; font-size: 0.9em; }
        button:hover { background-color: #a2f279; }
        button:disabled { background-color: #4a4f58; color: #888; cursor: not-allowed; opacity: 0.6; }
        #emergencyStopBtn { background-color: #ff6347; color: white; width: 100%; margin-top: 15px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 10px; }
        .control-label { font-size: 1.1em; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider.round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ff6347; transition: .4s; border-radius: 28px; }
        .slider.round:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #a2f279; }
        input:checked + .slider:before { transform: translateX(22px); }
        input:disabled + .slider { background-color: #4a4f58; cursor: not-allowed; }
        fieldset { border: 1px solid #4a4f58; border-radius: 8px; margin-top: 15px; padding: 10px 15px; }
        legend { color: #61dafb; font-weight: bold; padding: 0 10px; font-size: 1.1em; }
        #joystickWrapper { position: relative; width: 180px; height: 180px; border-radius: 50%; background-color: #4a4f58; border: 3px solid #61dafb; margin: 15px auto; }
        #joystickCanvas { width: 100%; height: 100%; display: block; }
        #chart-wrapper { position: relative; height: 320px; border-radius: 8px; overflow: hidden; background-color: #20232a; }
        #log-history { text-align: left; height: 350px; overflow-y: auto; background-color: #20232a; padding: 10px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; }
        .status-indicator { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
        .status-ok { background-color: #a2f279; }
        .status-warn { background-color: #f7b731; }
        .status-error { background-color: #ff6347; }
        .status-disconnected { background-color: #888; }
        #emergency-banner { display: none; background-color: #ff6347; color: white; padding: 10px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; }
        .angle-display { display: flex; align-items: center; justify-content: space-between; }
        .angle-indicator-wrapper { position: relative; width: 34px; height: 34px; background-color: #20232a; border-radius: 50%; border: 1px solid #61dafb; }
        .angle-indicator-needle { position: absolute; bottom: 50%; left: calc(50% - 1px); width: 2px; height: 50%; background-color: #ff6347; transform-origin: bottom center; transition: transform 0.1s linear; }
        .profile-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .profile-controls > * { flex: 1 1 auto; }
        .chart-controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; font-size: 0.9em; }
        .chart-controls label { color: #fff; }
        .setting-container { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 8px 0; }
        .setting-container label { font-size: 1em; font-weight: bold; color: #a2f279; text-align: left; }
        .numeric-input-wrapper { display: flex; align-items: center; flex-shrink: 0; }
        .numeric-input-wrapper button { background-color: #4a4f58; color: #61dafb; padding: 4px 8px; font-size: 1em; line-height: 1; min-width: 30px; }
        .numeric-input-wrapper input[type=number] { width: 90px; text-align: center; font-size: 1em; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 5px; margin: 0 4px; padding: 4px; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .manual-tune-row { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; margin-bottom: 8px; }
        .manual-tune-row label { text-align: left; font-weight: bold; color: #a2f279; }
        .manual-tune-row .test-btn { background-color: #a2f279; }
        .manual-tune-row .stop-btn { background-color: #ff6347; }
        .manual-tune-readout { margin-top: 15px; font-size: 1.2em; font-weight: bold; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .trim-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .trim-controls span { font-weight: bold; }
        .trim-controls button { min-width: 40px; font-size: 1.2em; }
        .dpad-container { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; gap: 5px; max-width: 150px; margin: 15px auto; }
        .dpad-btn { background-color: #61dafb; color: #282c34; border-radius: 5px; font-size: 2em; line-height: 1; padding: 5px; cursor: pointer; border: none; }
        .dpad-btn:hover { background-color: #a2f279; }
        #dpad-up { grid-column: 2; grid-row: 1; }
        #dpad-left { grid-column: 1; grid-row: 2; }
        #dpad-right { grid-column: 3; grid-row: 2; }
        #dpad-down { grid-column: 2; grid-row: 3; }
        #dpad-stop { grid-column: 2; grid-row: 2; background-color: #ff6347; color: white; }
        .dpad-input-group { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin: 10px 0; }
        .dpad-input-group label { text-align: right; font-weight: bold; color: #a2f279; }
        .dpad-input-group input { width: 100%; box-sizing: border-box; }
        .accordion-header { background-color: #4a4f58; color: #61dafb; cursor: pointer; padding: 12px 15px; border: none; text-align: left; outline: none; font-size: 1.1em; font-weight: bold; width: 100%; border-radius: 8px; margin-top: 5px; transition: background-color 0.3s; position: relative; }
        .accordion-header:hover { background-color: #5a6068; }
        .accordion-header.active { background-color: #61dafb; color: #282c34; border-bottom-left-radius: 0; border-bottom-right-radius: 0;}
        .accordion-header::after { content: '+'; position: absolute; right: 15px; font-size: 1.4em; transition: transform 0.3s; }
        .accordion-header.active::after { content: '-'; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background-color: #3a3f47; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;}
        .accordion-content.active { padding: 15px; }
        .pwm-info { background-color: #20232a; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #61dafb; }
        .pwm-info strong { color: #a2f279; }
        .physics-section { background-color: #2a2f35; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #a2f279; }
        .physics-section h4 { color: #a2f279; margin-top: 0; margin-bottom: 10px; }
        .lqr-info { background-color: #2a2f35; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #f7b731; }
        .lqr-info strong { color: #f7b731; }
        .parameter-group { background-color: #20232a; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
        .parameter-group h5 { color: #61dafb; margin: 0 0 8px 0; font-size: 1.1em; }
        .help-icon { display: inline-block; width: 16px; height: 16px; border-radius: 50%; background-color: #61dafb; color: #282c34; font-size: 12px; font-weight: bold; text-align: center; line-height: 16px; margin-left: 8px; cursor: pointer; user-select: none; }
        .help-text { background-color: #20232a; color: #fff; border-radius: 6px; padding: 10px; border: 1px solid #61dafb; margin-top: 8px; text-align: left; font-size: 0.9em; line-height: 1.4; width: 100%; box-sizing: border-box; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding-top: 0; padding-bottom: 0; grid-column: 1 / -1; }
        .help-text.visible { max-height: 200px; padding-top: 10px; padding-bottom: 10px; }
        .sequence-step { display: grid; grid-template-columns: 1fr 100px auto; gap: 10px; align-items: center; background-color: #2a2f35; padding: 8px; border-radius: 6px; margin-bottom: 8px; transition: background-color 0.3s; }
        .sequence-step.executing { background-color: #a2f279; color: #282c34; }
        .sequence-step.executing select, .sequence-step.executing input { color: #282c34; border-color: #282c34; }
        .sequence-step select, .sequence-step input { width: 100%; background-color: #20232a; color: #fff; border: 1px solid #61dafb; border-radius: 4px; padding: 5px; }
        .sequence-step .remove-step-btn { background-color: #ff6347; padding: 5px 10px; }
    </style>
</head>
<body>
    <div id="emergency-banner">ZATRZYMANIE AWARYJNE</div>

    <h1>Robot LQR - Panel Sterowania</h1>
    <div class="main-grid">
        <div class="card" id="controls-card">
            <h2>Sterowanie</h2>
            <div id="joystickWrapper"><canvas id="joystickCanvas"></canvas></div>
            <div class="control-row"><span class="control-label">Balansowanie</span><label class="switch"><input type="checkbox" id="balanceSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">Trzymaj Pozycje</span><label class="switch"><input type="checkbox" id="holdPositionSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">Tryb Predkosci</span><label class="switch"><input type="checkbox" id="speedModeSwitch"><span class="slider round"></span></label></div>
            <div class="control-row"><span class="control-label">LQR Aktywny</span><label class="switch"><input type="checkbox" id="lqrEnabledSwitch" checked><span class="slider round"></span></label></div>
            
            <fieldset style="padding: 10px 10px 5px 10px;"><legend>Strojenie Glowne</legend>
                <div class="setting-container"><label for="joystickOutputScaleInput">Skala Wyjscia (%)</label><div class="numeric-input-wrapper"><button id="joystickOutputScaleMinus">-</button><input type="number" class="config-value" id="joystickOutputScaleInput" min="10" max="100" step="5" value="100"><button id="joystickOutputScalePlus">+</button></div></div>
                <div class="setting-container"><label for="expoJoystickInput">Expo Joysticka (%)</label><div class="numeric-input-wrapper"><button id="expoJoystickMinus">-</button><input type="number" class="config-value" id="expoJoystickInput" min="0" max="90" step="1" value="0"><button id="expoJoystickPlus">+</button></div></div>
                <div class="setting-container"><label for="maxSpeedJoystickInput">Max. predkosc (imp/s)</label><div class="numeric-input-wrapper"><button id="maxSpeedJoystickMinus">-</button><input type="number" class="config-value" id="maxSpeedJoystickInput" min="200" max="4000" step="100" value="800"><button id="maxSpeedJoystickPlus">+</button></div></div>
                <div class="setting-container"><label for="joystickAngleSensitivityInput">Czulosc Kata (st.)</label><div class="numeric-input-wrapper"><button id="joystickAngleSensitivityMinus">-</button><input type="number" class="config-value" id="joystickAngleSensitivityInput" min="1" max="30" step="0.5" value="10"><button id="joystickAngleSensitivityPlus">+</button></div></div>
                <div class="setting-container"><label for="turnFactorInput">Czulosc Skretu (%)</label><div class="numeric-input-wrapper"><button id="turnFactorMinus">-</button><input type="number" class="config-value" id="turnFactorInput" min="0" max="100" step="5" value="25"><button id="turnFactorPlus">+</button></div></div>
                
                <hr style="border-color: #4a4f58; margin: 10px 0;">
                <h5 style="color: #61dafb; margin: 0 0 8px 0; font-size: 1.1em; text-align: left;">Korekty Ruchu</h5>
                <div class="setting-container"><label for="headingCorrectionFactorInput">Sila Korekty Kursu</label><div class="numeric-input-wrapper"><button id="headingCorrectionFactorMinus">-</button><input type="number" class="config-value" id="headingCorrectionFactorInput" min="0" max="5" step="0.05" value="0.4"><button id="headingCorrectionFactorPlus">+</button></div></div>
                
                <div class="setting-container">
                    <label for="speedToAngleFactorInput">Wsp. Predkosci na Kat<span class="help-icon">?</span></label>
                    <div class="numeric-input-wrapper">
                        <button id="speedToAngleFactorMinus">-</button>
                        <input type="number" class="config-value" id="speedToAngleFactorInput" min="0.001" max="0.1" step="0.001" value="0.01">
                        <button id="speedToAngleFactorPlus">+</button>
                    </div>
                    <div class="help-text"><strong>Wplyw:</strong> Kluczowy parametr dla trybu predkosci. Okresla, jak bardzo robot ma sie pochylac, aby osiagnac zadana predkosc. Wieksza wartosc = wieksza agresywnosc i szybsze przyspieszanie.</div>
                </div>

            </fieldset>
            
            <hr style="border-color: #4a4f58; margin: 15px 0;">
            <button id="resetZeroBtn">Resetuj Osie</button>
            <div class="trim-controls">
                <button id="trimMinusBtn">-</button>
                <span>Korekta Pionu (Pitch)</span>
                <button id="trimPlusBtn">+</button>
            </div>
            <div class="trim-controls">
                <button id="trimRollMinusBtn">-</button>
                <span>Korekta Przechylu (Roll)</span>
                <button id="trimRollPlusBtn">+</button>
            </div>
            <button id="resetEncodersBtn" style="margin-top:10px; background-color:#f7b731;">Resetuj Enkodery</button>
            <button id="emergencyStopBtn">STOP AWARYJNY</button>
        </div>
        
        <div class="card">
            <h2>Status Robota</h2>
            <button id="connectBleBtn" style="width: 100%; margin-bottom: 15px;">POLACZ Z ROBOTEM</button>
            <div class="status-grid">
                <strong>Polaczenie:</strong> <div><span id="connectionStatus" class="status-indicator status-disconnected"></span> <span id="connectionText">Rozlaczony</span></div>
                <strong>Status Systemu:</strong> <div><span id="systemStatus" class="status-indicator status-disconnected"></span> <span id="systemText">Nieznany</span></div>
                <strong>Tryb Pracy:</strong> <span id="robotStateVal" style="font-weight:bold; color: #61dafb;">IDLE</span>
                <strong>Czas Petli:</strong> <span id="loopTimeVal">0 &micro;s</span>
                <hr style="grid-column: 1 / -1; border-color: #4a4f58; margin: 5px 0;">
                <strong>Wolna Sterta (RAM):</strong> <span id="freeHeapVal" style="font-weight:bold; color: #f7b731;">0 B</span>
                <strong>Stos Petli (min.):</strong> <span id="stackHwmVal" style="font-weight:bold; color: #f7b731;">0 B</span>
            </div>
            <div class="info-grid">
                <strong>Kat (Pitch):</strong> <div class="angle-display"><span id="angleVal">0.0 &deg;</span><div class="angle-indicator-wrapper"><div id="angleIndicator" class="angle-indicator-needle"></div></div></div>
                <strong>Predkosc (imp/s):</strong> <span id="speedVal">0</span>
                <strong>Zadany Kat:</strong> <span id="targetAngleVal">0.0 &deg;</span>
                <hr style="grid-column: 1 / -1; border-color: #4a4f58; margin: 5px 0;">
                <strong>LQR Wyjscie:</strong> <span id="lqrOutputVal">0</span>
                <strong>Lewy Silnik:</strong> <span id="leftMotorVal">0</span>
                <strong>Prawy Silnik:</strong> <span id="rightMotorVal">0</span>
                <hr style="grid-column: 1 / -1; border-color: #4a4f58; margin: 5px 0;">
                <strong>Enkoder L:</strong> <span id="encoderLeftVal">0</span>
                <strong>Enkoder P:</strong> <span id="encoderRightVal">0</span>
            </div>
        </div>
        
        <div class="card">
             <button class="accordion-header" onclick="toggleAccordion(this)">Sterowanie Autonomiczne</button>
             <div class="accordion-content">
                <fieldset>
                    <legend>Sterowanie Precyzyjne (D-Pad)</legend>
                    <div class="dpad-input-group"><label for="dpadDistInput">Dystans (cm):</label><input type="number" id="dpadDistInput" value="20"></div>
                    <div class="dpad-input-group"><label for="dpadAngleInput">Kat (st.):</label><input type="number" id="dpadAngleInput" value="90"></div>
                    <div class="dpad-container">
                        <button id="dpad-up" class="dpad-btn">&#8593;</button>
                        <button id="dpad-left" class="dpad-btn">&#8592;</button>
                        <button id="dpad-stop" class="dpad-btn">&#215;</button>
                        <button id="dpad-right" class="dpad-btn">&#8594;</button>
                        <button id="dpad-down" class="dpad-btn">&#8595;</button>
                    </div>
                </fieldset>
                <fieldset style="margin-top: 15px;">
                    <legend>Kreator Sekwencji Ruchow</legend>
                    <div id="sequence-list"></div>
                    <button id="add-sequence-step-btn" style="width:100%; margin: 10px 0;">Dodaj Krok</button>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button id="run-sequence-btn" style="background-color: #a2f279;">Uruchom</button>
                        <button id="stop-sequence-btn" style="background-color: #ff6347;" disabled>Zatrzymaj</button>
                        <button id="clear-sequence-btn" style="background-color: #f7b731;">Wyczysc</button>
                    </div>
                </fieldset>
                
                <fieldset style="margin-top: 15px;">
                    <legend>Strojenie Autonomii</legend>
                    <div class="setting-container">
                        <label for="positionPGainInput">Agresywnosc Ruchu (P-Gain)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper">
                            <button id="positionPGainMinus">-</button>
                            <input type="number" class="config-value" id="positionPGainInput" min="0.001" max="0.1" step="0.001" value="0.005">
                            <button id="positionPGainPlus">+</button>
                        </div>
                        <div class="help-text"><strong>Wplyw:</strong> Wzmacnia reakcje na blad pozycji. Wieksza wartosc = robot szybciej i bardziej agresywnie dojezdza do celu. Zbyt duza moze powodowac oscylacje.</div>
                    </div>
                    <div class="setting-container">
                        <label for="positionDGainInput">Hamowanie (D-Gain)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper">
                            <button id="positionDGainMinus">-</button>
                            <input type="number" class="config-value" id="positionDGainInput" min="0" max="0.5" step="0.001" value="0.01">
                            <button id="positionDGainPlus">+</button>
                        </div>
                        <div class="help-text"><strong>Wplyw:</strong> Aktywne hamowanie robota. Wieksza wartosc = robot mocniej hamuje zblizajac sie do celu, zapobiega 'przestrzeleniu' pozycji. Zbyt duza moze powodowac drgania.</div>
                    </div>
                    <div class="setting-container">
                        <label for="rotationPGainInput">Agresywnosc Obrotu (P-Gain)<span class="help-icon">?</span></label>
                        <div class="numeric-input-wrapper">
                            <button id="rotationPGainMinus">-</button>
                            <input type="number" class="config-value" id="rotationPGainInput" min="0.1" max="10" step="0.1" value="2.5">
                            <button id="rotationPGainPlus">+</button>
                        </div>
                        <div class="help-text"><strong>Wplyw:</strong> Sila, z jaka robot wykonuje obrot do celu. Wieksza wartosc = szybszy obrot. Zbyt duza spowoduje niestabilnosc i oscylacje.</div>
                    </div>
                </fieldset>

                <fieldset style="margin-top: 15px;">
                    <legend>Diagnostyka</legend>
                     <button id="calibrateMpuBtn" style="width:100%; background-color:#f7b731;">Kalibruj MPU (DMP)</button>
                </fieldset>
            </div>
        </div>
        
        <div class="card">
            <button class="accordion-header" onclick="toggleAccordion(this)">Wykres Telemetryczny</button>
            <div class="accordion-content">
                <div id="chart-wrapper"><canvas id="telemetryChart"></canvas></div>
                <div class="chart-controls" id="chartControls"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>Konfiguracja</h2>
            <fieldset>
                <legend>Profile Ustawien LQR</legend>
                <div class="profile-controls">
                    <select id="lqrPresetSelect" style="width: 100%; padding: 5px;"></select>
                </div>
                 <div class="profile-controls">
                    <button id="applyLqrPresetBtn" style="width: 100%;">Zastosuj i Wczytaj do Panelu</button>
                </div>
                <hr style="border-color: #4a4f58; margin: 15px 0;">
                <div class="profile-controls">
                    <input type="text" id="newPresetNameInput" placeholder="Nazwa nowego presetu..." style="width: 100%; padding: 5px;">
                </div>
                <div class="profile-controls">
                    <button id="savePresetBtn" style="background-color: #a2f279;">Zapisz jako Nowy</button>
                    <button id="deletePresetBtn" style="background-color: #ff6347;" disabled>Usuń Wybrany</button>
                </div>
            </fieldset>
            
            <div id="allSettings">
                <button class="accordion-header" onclick="toggleAccordion(this)">1. Wagi LQR (Macierz Q i R)</button>
                <div class="accordion-content">
                    <div class="parameter-group">
                        <h5>Wagi Stanow (Macierz Q)</h5>
                        <div class="setting-container">
                            <label for="q1AngleInput">Q1 - Kat (theta)<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="q1AngleMinus">-</button><input type="number" class="lqr-input config-value" id="q1AngleInput" min="0" max="1000" step="5" value="100"><button id="q1AnglePlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Kara za odchylenie od pionu. Wieksza wartosc = robot mocniej 'walczy' o utrzymanie pionu, jest sztywniejszy.</div>
                        </div>
                        <div class="setting-container">
                            <label for="q2AngularVelInput">Q2 - Predkosc katowa<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="q2AngularVelMinus">-</button><input type="number" class="lqr-input config-value" id="q2AngularVelInput" min="0" max="100" step="1" value="10"><button id="q2AngularVelPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Kara za szybkie zmiany kata (oscylacje). Wieksza wartosc = lepsze tlumienie drgan, bardziej plynna reakcja.</div>
                        </div>
                        <div class="setting-container">
                            <label for="q3PositionInput">Q3 - Pozycja (s)<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="q3PositionMinus">-</button><input type="number" class="lqr-input config-value" id="q3PositionInput" min="0" max="1000" step="10" value="1"><button id="q3PositionPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Kara za dryf pozycyjny. Wieksza wartosc = robot aktywniej wraca do pozycji wyjsciowej po zatrzymaniu.</div>
                        </div>
                        <div class="setting-container">
                            <label for="q4VelocityInput">Q4 - Predkosc (s_dot)<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="q4VelocityMinus">-</button><input type="number" class="lqr-input config-value" id="q4VelocityInput" min="0" max="100" step="1" value="5"><button id="q4VelocityPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Kara za szybkie ruchy liniowe. Wieksza wartosc = plynniejsze, mniej gwaltowne przyspieszanie i hamowanie.</div>
                        </div>
                    </div>
                    
                    <div class="parameter-group">
                        <h5>Waga Sterowania (Skalar R)</h5>
                        <div class="setting-container">
                            <label for="rControlInput">R - Waga sterowania<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="rControlMinus">-</button><input type="number" class="lqr-input config-value" id="rControlInput" min="0.001" max="10" step="0.01" value="0.1"><button id="rControlPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Kara za zuzycie energii (PWM silnikow). Wieksza wartosc = slabsze, bardziej oszczedne sterowanie. Mniejsza wartosc = mocniejsza reakcja.</div>
                        </div>
                    </div>

                    <div class="parameter-group">
                        <h5>Wzmocnienie Glowne</h5>
                        <div class="setting-container">
                            <label for="lqrOutputScalarInput">Skala Wyjscia LQR<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="lqrOutputScalarMinus">-</button><input type="number" class="config-value" id="lqrOutputScalarInput" min="0.1" max="50.0" step="0.1" value="20.0"><button id="lqrOutputScalarPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Glowny mnoznik dla calego sygnalu sterujacego. Zwiekszaj, jesli robot jest 'slaby', zmniejszaj, jesli jest zbyt agresywny lub wpada w oscylacje. To Twoje glowne pokretlo do strojenia!</div>
                        </div>
                    </div>
                    <div class="lqr-info">
                        <strong>Teoria LQR:</strong> Kontroler minimalizuje wskaznik jakosci J = integral(x'Qx + u'Ru)dt. Wieksze wagi Q = wieksza kara za odchylenia stanu, wieksze R = wieksza kara za sterowanie (energie).
                    </div>
                </div>
                
                <button class="accordion-header" onclick="toggleAccordion(this)">2. Parametry Sprzetowe</button>
                <div class="accordion-content">
                    <div class="physics-section">
                        <h4>Parametry Fizyczne Robota</h4>
                        <div class="setting-container">
                            <label for="mBodyInput">Masa korpusu (kg)<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="mBodyMinus">-</button><input type="number" class="config-value" id="mBodyInput" min="0.1" max="5.0" step="0.01" value="0.150"><button id="mBodyPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Laczna masa robota bez kol i silnikow. Wplywa na moment bezwladnosci. Zmien, jesli dodasz lub usuniesz komponenty.</div>
                        </div>
                        <div class="setting-container">
                            <label for="mWheelInput">Masa kola (kg)<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="mWheelMinus">-</button><input type="number" class="config-value" id="mWheelInput" min="0.01" max="1.0" step="0.005" value="0.055"><button id="mWheelPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Masa jednego kola razem z silnikiem. Wplywa na bezwladnosc calego ukladu.</div>
                        </div>
                        <div class="setting-container">
                            <label for="LInput">Wysokosc srodka masy (m)<span class="help-icon">?</span></label>
                            <div class="numeric-input-wrapper"><button id="LMinus">-</button><input type="number" class="config-value" id="LInput" min="0.01" max="0.5" step="0.001" value="0.087"><button id="LPlus">+</button></div>
                            <div class="help-text"><strong>Wplyw:</strong> Kluczowy parametr! Odleglosc od osi kol do srodka masy korpusu. Wieksze L = wieksza niestabilnosc, ale potencjalnie wolniejsza reakcja.</div>
                        </div>
                    </div>
                    <div class="parameter-group">
                        <h5>Kalibracja Mechaniczna</h5>
                        <div class="setting-container">
                            <label for="wheelDiameterCmInput">Srednica kola (cm)</label>
                            <div class="numeric-input-wrapper"><button id="wheelDiameterCmMinus">-</button><input type="number" class="config-value" id="wheelDiameterCmInput" min="3" max="30" step="0.1" value="8.2"><button id="wheelDiameterCmPlus">+</button></div>
                        </div>
                        <div class="setting-container">
                            <label for="trackWidthCmInput">Rozstaw kol (cm)</label>
                            <div class="numeric-input-wrapper"><button id="trackWidthCmMinus">-</button><input type="number" class="config-value" id="trackWidthCmInput" min="5" max="50" step="0.1" value="13.0"><button id="trackWidthCmPlus">+</button></div>
                        </div>
                        <div class="setting-container">
                            <label for="encoderPprInput">Impulsy na obrot (PPR)</label>
                            <div class="numeric-input-wrapper"><button id="encoderPprMinus">-</button><input type="number" class="config-value" id="encoderPprInput" min="100" max="5000" step="10" value="820"><button id="encoderPprPlus">+</button></div>
                        </div>
                    </div>
                </div>

                <button class="accordion-header" onclick="toggleAccordion(this)">3. Kalibracja PWM Silnikow</button>
                <div class="accordion-content">
                    <div class="pwm-info">
                        <strong>Info:</strong> Minimalne wartosci PWM to prog, ponizej ktorego silnik nie kreci sie. Ustal je testujac kazdy silnik osobno.
                    </div>
                    <div class="manual-tune-row" data-motor="left" data-direction="fwd"><label>Lewy (Przod)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmLeftFwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div><div><button class="test-btn">Testuj</button><button class="stop-btn">Stop</button></div></div>
                    <div class="manual-tune-row" data-motor="left" data-direction="bwd"><label>Lewy (Tyl)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmLeftBwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div><div><button class="test-btn">Testuj</button><button class="stop-btn">Stop</button></div></div>
                    <div class="manual-tune-row" data-motor="right" data-direction="fwd"><label>Prawy (Przod)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmRightFwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div><div><button class="test-btn">Testuj</button><button class="stop-btn">Stop</button></div></div>
                    <div class="manual-tune-row" data-motor="right" data-direction="bwd"><label>Prawy (Tyl)</label><div class="numeric-input-wrapper"><button class="tune-minus">-</button><input type="number" class="config-value tune-input" id="minPwmRightBwdInput" min="0" max="1023" step="1" value="640"><button class="tune-plus">+</button></div><div><button class="test-btn">Testuj</button><button class="stop-btn">Stop</button></div></div>
                    <hr style="border-color: #4a4f58; margin: 15px 0;">
                    <div class="manual-tune-readout"><div>Enkoder L: <span id="manualEncoderL">0</span></div><div>Enkoder P: <span id="manualEncoderR">0</span></div></div>
                    <button id="manualTuneStopAll" style="width:100%; margin-top:15px; background-color:#ff6347;">ZATRZYMAJ WSZYSTKO</button>
                </div>
            </div>
            
            <div class="button-group" style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button id="loadBtn">Wczytaj z EEPROM</button>
                <button id="saveBtn">Zapisz Ustawienia</button>
            </div>
        </div>
        <div class="card">
            <button class="accordion-header active" onclick="toggleAccordion(this)">Logi Systemowe</button>
            <div class="accordion-content active">
                <div id="log-history"></div>
                <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button onclick="clearLogs()" style="background-color: #f7b731;">Wyczysc Logi</button>
                    <label>
                        Poziom: 
                        <select id="logLevelFilter" onchange="filterLogs()">
                            <option value="all">Wszystkie</option>
                            <option value="error">Bledy</option>
                            <option value="warn">Ostrzezenia</option>
                            <option value="info">Info</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

<script>
    let isPresetSequenceRunning = false;
    let presetAckResolver = null;
    let presetAckTimeout = null;
    const PRESET_ACK_TIMEOUT_MS = 2000;
    const lqrBuiltInPresets = {
        'balanced': { name: '1. Zbalansowany (Startowy)', values: { q1: 150, q2: 15, q3: 10, q4: 20, r: 0.08 } },
        'stiff': { name: '2. Bardzo Sztywny (Precyzja)', values: { q1: 500, q2: 25, q3: 5, q4: 10, r: 0.1 } },
        'soft': { name: '3. Miekki (Tlumienie)', values: { q1: 80, q2: 40, q3: 1, q4: 25, r: 0.2 } },
        'fast_aggressive': { name: '4. Szybka Jazda (Agresywny)', values: { q1: 100, q2: 10, q3: 0.5, q4: 30, r: 0.05 } },
        'slow_smooth': { name: '5. Powolna Jazda (Plynnosc)', values: { q1: 120, q2: 20, q3: 2, q4: 5, r: 0.3 } },
        'strong_hold': { name: '6. Mocne Trzymanie Pozycji', values: { q1: 150, q2: 15, q3: 80, q4: 20, r: 0.1 } },
        'balance_only': { name: '7. Minimalistyczny (Tylko Balans)', values: { q1: 200, q2: 20, q3: 0, q4: 0, r: 0.1 } },
        'experimental_speed': { name: '8. Eksperymentalny (Wysokie Predkosci)', values: { q1: 70, q2: 5, q3: 0.1, q4: 50, r: 0.04 } },
        'precise_auto': { name: '9. Precyzyjny Ruch Autonomiczny', values: { q1: 150, q2: 20, q3: 400, q4: 40, r: 0.08 } }
    };
    const CUSTOM_PRESET_PREFIX = 'lqr_custom_preset_';
    const availableTelemetry = {
        'pitch': { label: 'Pitch (Kat)', color: '#61dafb' },
        'target_angle': { label: 'Zadany Kat', color: '#a2f279' },
        'speed': { label: 'Predkosc', color: '#f7b731' },
        'lqr_output': { label: 'LQR Wyjscie', color: '#ff9ff3' },
    };
    let lastUserInteraction = {};
    const INTERACTION_TIMEOUT = 500;
    let finalTargetAngleForDisplay = 0.0;
    let bleDevice, rxCharacteristic, txCharacteristic;
    let configSyncTimeout = null;
    let logBuffer = [];
    const MAX_LOG_LINES = 200;
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const RX_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a9";
    const TX_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const joystickCanvas = document.getElementById('joystickCanvas');
    const joystickCtx = joystickCanvas.getContext('2d');
    let joystickCenter, joystickRadius, knobRadius, isDragging = false;
    let lastJoystickSendTime = 0;
    const JOYSTICK_SEND_INTERVAL = 50;
    let chunkBuffers = {};
    let sequence = [];
    let isSequenceRunning = false;
    let currentSequenceStep = 0;
    const MAX_SEQUENCE_STEPS = 4;
    let lastKnownRobotState = 'IDLE';

    function updateAccordionHeight(contentElement) {
        if (contentElement.style.maxHeight && contentElement.style.maxHeight !== '0px') {
            contentElement.style.maxHeight = contentElement.scrollHeight + "px";
        }
    }

    async function connectBLE() {
        addLogMessage('[UI] Prosze o wybranie urzadzenia Bluetooth...', 'info');
        try {
            bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SERVICE_UUID] }],
                optionalServices: [SERVICE_UUID]
            });
            addLogMessage(`[UI] Laczenie z ${bleDevice.name}...`, 'info');
            document.getElementById('connectBleBtn').disabled = true;
            document.getElementById('connectionText').textContent = 'Laczenie...';
            bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
            const server = await bleDevice.gatt.connect();
            addLogMessage('[UI] Pobieranie serwisu...', 'info');
            const service = await server.getPrimaryService(SERVICE_UUID);
            addLogMessage('[UI] Pobieranie charakterystyk...', 'info');
            rxCharacteristic = await service.getCharacteristic(RX_UUID);
            txCharacteristic = await service.getCharacteristic(TX_UUID);
            addLogMessage('[UI] Nasluchiwanie na powiadomienia...', 'info');
            await txCharacteristic.startNotifications();
            txCharacteristic.addEventListener('characteristicvaluechanged', handleBleNotification);
            document.getElementById('connectionStatus').className = 'status-indicator status-ok';
            document.getElementById('connectionText').textContent = 'Polaczony';
            addLogMessage('[UI] Polaczono! Automatyczna synchronizacja stanu robota...', 'info');
            sendBleMessage({ type: 'request_state' });
            if (configSyncTimeout) clearTimeout(configSyncTimeout);
            configSyncTimeout = setTimeout(() => {
                addLogMessage('[UI] Blad: Timeout synchronizacji. Nie otrzymano danych od robota.', 'error');
                configSyncTimeout = null;
            }, 5000);
        } catch (error) {
            addLogMessage(`[UI] Blad polaczenia BLE: ${error}`, 'error');
            document.getElementById('connectionStatus').className = 'status-indicator status-error';
            document.getElementById('connectionText').textContent = 'Blad polaczenia';
            document.getElementById('connectBleBtn').disabled = false;
        }
    }

    function onDisconnected() {
        addLogMessage('[UI] Rozlaczono z robotem.', 'warn');
        if (configSyncTimeout) { clearTimeout(configSyncTimeout); configSyncTimeout = null; }
        document.getElementById('connectionStatus').className = 'status-indicator status-disconnected';
        document.getElementById('connectionText').textContent = 'Rozlaczony';
        ['balanceSwitch', 'holdPositionSwitch', 'speedModeSwitch', 'lqrEnabledSwitch'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.checked = false;
        });
        document.getElementById('systemStatus').className = 'status-indicator status-disconnected';
        document.getElementById('systemText').textContent = 'Nieznany';
        document.getElementById('connectBleBtn').disabled = false;
        rxCharacteristic = null;
        txCharacteristic = null;
        chunkBuffers = {};
        if (isSequenceRunning) {
            stopSequenceExecution();
            addLogMessage('[UI] Sekwencja przerwana z powodu rozlaczenia.', 'warn');
        }
    }

    function handleBleNotification(event) {
        const value = event.target.value;
        const decoder = new TextDecoder('utf-8');
        const jsonString = decoder.decode(value);
        handleIncomingData(jsonString);
    }

    function handleIncomingData(jsonString) {
        try {
            const data = JSON.parse(jsonString);
            if (data.type === 'chunk') {
                if (data.i === 0) {
                     addLogMessage(`[UI] Odbieram fragmentowana wiadomosc (ID: ${data.id}, ${data.total} czesci)...`, 'info');
                }
                if (!chunkBuffers[data.id]) {
                    chunkBuffers[data.id] = {
                        chunks: new Array(data.total),
                        receivedCount: 0,
                        totalCount: data.total
                    };
                }
                const buffer = chunkBuffers[data.id];
                if (!buffer.chunks[data.i]) {
                    buffer.chunks[data.i] = data.data;
                    buffer.receivedCount++;
                }
                if (buffer.receivedCount === buffer.totalCount) {
                    const completeMessageString = buffer.chunks.join('');
                    addLogMessage(`[UI] Zlozono wiadomosc (ID: ${data.id}) z ${data.total} czesci. Rozmiar: ${completeMessageString.length} B.`, 'info');
                    delete chunkBuffers[data.id];
                    handleIncomingData(completeMessageString);
                }
            } else {
                processCompleteMessage(data);
            }
        } catch (e) {
            addLogMessage(`[UI] Blad parsowania JSON: ${e}. Dane: ${jsonString}`, 'error');
        }
    }

    function processCompleteMessage(data) {
        switch (data.type) {
            case 'telemetry':
                let previousRobotState = lastKnownRobotState;
                if(data.robot_state) {
                    lastKnownRobotState = data.robot_state;
                }
                updateUI(data);
                updateChart(data);
                checkAndExecuteNextSequenceStep(previousRobotState);
                break;
            case 'full_config':
                if (configSyncTimeout) {
                    clearTimeout(configSyncTimeout);
                    configSyncTimeout = null;
                }
                applyInitialState(data);
                break;
            case 'ack':
                if (isPresetSequenceRunning && presetAckResolver) {
                    if (presetAckTimeout) clearTimeout(presetAckTimeout);
                    presetAckResolver();
                    presetAckResolver = null;
                }
                break;
            case 'log':
                addLogMessage(`[ROBOT] ${data.message}`, data.level);
                break;
            case 'memory_info':
                updateMemoryInfo(data);
                break;
        }
    }

    async function sendBleMessage(message) {
        if (!rxCharacteristic) { addLogMessage("[UI] Brak polaczenia z robotem!", "error"); return; }
        try {
            const encoder = new TextEncoder();
            await rxCharacteristic.writeValueWithoutResponse(encoder.encode(JSON.stringify(message)));
        } catch (error) { addLogMessage(`[UI] Blad wysylania danych BLE: ${error}`, 'error'); }
    }

    function applyInitialState(data) {
        document.getElementById('balanceSwitch').checked = data.balancingEnabled;
        document.getElementById('holdPositionSwitch').checked = data.holdPositionEnabled;
        document.getElementById('speedModeSwitch').checked = data.speedModeEnabled;
        document.getElementById('lqrEnabledSwitch').checked = data.lqrEnabled;
        const params = {
            expoJoystick: data.expo_joystick, maxSpeedJoystick: data.max_speed_joystick, joystickOutputScale: data.joystick_output_scale, turnFactor: data.turn_factor, joystickAngleSensitivity: data.joystick_angle_sensitivity, 
            minPwmLeftFwd: data.min_pwm_left_fwd, minPwmLeftBwd: data.min_pwm_left_bwd, minPwmRightFwd: data.min_pwm_right_fwd, minPwmRightBwd: data.min_pwm_right_bwd, 
            q1Angle: data.q1_angle, q2AngularVel: data.q2_angular_vel, q3Position: data.q3_position, q4Velocity: data.q4_velocity, rControl: data.r_control, lqrOutputScalar: data.lqr_output_scalar, 
            mBody: data.m_body, mWheel: data.m_wheel, L: data.L, 
            wheelDiameterCm: data.wheel_diameter_cm, trackWidthCm: data.track_width_cm, encoderPpr: data.encoder_ppr,
            headingCorrectionFactor: data.heading_correction_factor,
            speedToAngleFactor: data.speed_to_angle_factor,
            positionPGain: data.position_p_gain,
            positionDGain: data.position_d_gain,
            rotationPGain: data.rotation_p_gain
        };
        for (const [key, value] of Object.entries(params)) {
            const inputId = `${key}Input`;
            const input = document.getElementById(inputId);
            if (input && value !== undefined) {
                if (key === 'expoJoystick' || key === 'joystickOutputScale' || key === 'turnFactor') {
                    input.value = value * 100;
                } else {
                    input.value = value;
                }
            }
        }
        addLogMessage("[UI] Parametry robota zsynchronizowane z panelem.", "info");
    }

    function updateUI(data) {
        if (data.robot_state !== undefined) document.getElementById('robotStateVal').textContent = data.robot_state;
        if (data.pitch !== undefined) {
            const displayPitch = data.pitch;
            document.getElementById('angleVal').textContent = displayPitch.toFixed(1) + ' \u00B0';
            document.getElementById('angleIndicator').style.transform = 'rotate(' + displayPitch + 'deg)';
        }
        if (data.speed !== undefined) document.getElementById('speedVal').textContent = parseFloat(data.speed).toFixed(0);
        if (data.target_angle !== undefined) {
            finalTargetAngleForDisplay = data.target_angle;
            document.getElementById('targetAngleVal').textContent = parseFloat(data.target_angle).toFixed(1) + ' \u00B0';
        }
        if (data.lqr_output !== undefined) document.getElementById('lqrOutputVal').textContent = parseFloat(data.lqr_output).toFixed(2);
        if (data.left_motor !== undefined) document.getElementById('leftMotorVal').textContent = Math.round(data.left_motor);
        if (data.right_motor !== undefined) document.getElementById('rightMotorVal').textContent = Math.round(data.right_motor);
        if (data.loop_time !== undefined) document.getElementById('loopTimeVal').textContent = data.loop_time + ' \u00B5s';
        if (data.encoder_left !== undefined) document.getElementById('encoderLeftVal').textContent = data.encoder_left;
        if (data.encoder_right !== undefined) document.getElementById('encoderRightVal').textContent = data.encoder_right;
        ['balanceSwitch', 'holdPositionSwitch', 'speedModeSwitch'].forEach(id => {
            const el = document.getElementById(id);
            if (!lastUserInteraction[id] || (Date.now() - lastUserInteraction[id] > INTERACTION_TIMEOUT)) {
                if (data[id.replace('Switch', 'Enabled')] !== undefined) {
                    el.checked = data[id.replace('Switch', 'Enabled')];
                }
            }
        });
        const systemStatus = document.getElementById('systemStatus'), systemText = document.getElementById('systemText'), emergencyBanner = document.getElementById('emergency-banner');
        if (data.emergency_stop) {
            systemStatus.className = 'status-indicator status-error';
            systemText.textContent = 'STOP AWARYJNY';
            emergencyBanner.style.display = 'block';
        } else {
            systemStatus.className = 'status-indicator status-ok';
            systemText.textContent = 'OK';
            emergencyBanner.style.display = 'none';
        }
    }

    function updateMemoryInfo(data) {
        if (data.free_heap !== undefined) document.getElementById('freeHeapVal').textContent = `${data.free_heap} B`;
        if (data.ctrl_stack_hwm !== undefined) document.getElementById('stackHwmVal').textContent = `${data.ctrl_stack_hwm} B`;
    }

    function addLogMessage(message, level = 'info') {
        const entry = { message, level, timestamp: new Date().toLocaleTimeString() };
        logBuffer.unshift(entry);
        if (logBuffer.length > MAX_LOG_LINES) logBuffer.pop();
        filterLogs();
    }

    function filterLogs() {
        const logHistory = document.getElementById('log-history');
        const filterLevel = document.getElementById('logLevelFilter').value;
        const filtered = logBuffer.filter(entry => filterLevel === 'all' || entry.level === filterLevel);
        logHistory.innerHTML = filtered.map(entry => {
            let color = '#fff';
            if (entry.level === 'error') color = '#ff6347';
            else if (entry.level === 'warn') color = '#f7b731';
            return `<div style="color:${color};">[${entry.timestamp}] ${entry.message}</div>`;
        }).join('');
    }

    function clearLogs() {
        logBuffer = [];
        filterLogs();
    }

    const telemetryChart = new Chart(document.getElementById('telemetryChart'), {
        type: 'line', data: { labels: Array(100).fill(''), datasets: [] }, options: { animation: false, responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { type: 'linear', display: true, position: 'left', ticks: { color: '#61dafb' }, title: { display: true, text: 'Wartosc', color: '#61dafb' } }, y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#a2f279' }, title: { display: true, text: 'Wyjscie LQR / PWM', color: '#a2f279' }, grid: { drawOnChartArea: false }, } }, plugins: { legend: { labels: { color: '#fff' } } } }
    });

    function updateChart(data) {
        const chartData = telemetryChart.data;
        if (chartData.labels.length >= 100) chartData.labels.shift();
        chartData.labels.push('');
        let localData = { ...data, 'target_angle': finalTargetAngleForDisplay };
        for (const [key, localDataValue] of Object.entries(localData)) {
            if (availableTelemetry[key] && localDataValue !== undefined) {
                let dataset = chartData.datasets.find(ds => ds.label === availableTelemetry[key].label);
                if (!dataset) {
                    const axisId = (key.includes('output') || key.includes('motor')) ? 'y1' : 'y';
                    dataset = { label: availableTelemetry[key].label, data: Array(chartData.labels.length).fill(null), borderColor: availableTelemetry[key].color, fill: false, tension: 0.1, pointRadius: 0, yAxisID: axisId };
                    chartData.datasets.push(dataset);
                }
                if (dataset.data.length >= 100) dataset.data.shift();
                dataset.data.push(localDataValue);
            }
        }
        chartData.datasets.forEach(ds => {
            if (ds.data.length < chartData.labels.length) {
                if (ds.data.length >= 100) ds.data.shift();
                ds.data.push(null);
            }
        });
        telemetryChart.update('none');
    }

    function setupManualTuningControls() {
        document.querySelectorAll('.manual-tune-row').forEach(row => {
            const input = row.querySelector('.tune-input');
            const step = 10;
            const testBtn = row.querySelector('.test-btn');
            const stopBtn = row.querySelector('.stop-btn');
            row.querySelector('.tune-plus').addEventListener('click', () => {
                input.value = Math.min(parseInt(input.value) + step, 1023);
                input.dispatchEvent(new Event('change'));
            });
            row.querySelector('.tune-minus').addEventListener('click', () => {
                input.value = Math.max(parseInt(input.value) - step, 0);
                input.dispatchEvent(new Event('change'));
            });
            testBtn.addEventListener('click', (e) => {
                const button = e.currentTarget; if (button.disabled) return;
                button.disabled = true; setTimeout(() => button.disabled = false, 500);
                sendBleMessage({ type: 'set_direct_motor_control', motor: row.dataset.motor, direction: row.dataset.direction, pwm: parseInt(input.value) });
            });
            stopBtn.addEventListener('click', (e) => {
                const button = e.currentTarget; if (button.disabled) return;
                button.disabled = true; setTimeout(() => button.disabled = false, 500);
                sendBleMessage({ type: 'set_direct_motor_control', motor: row.dataset.motor, direction: row.dataset.direction, pwm: 0 });
            });
        });
        document.getElementById('manualTuneStopAll').addEventListener('click', (e) => {
            const button = e.currentTarget; if (button.disabled) return;
            button.disabled = true; setTimeout(() => button.disabled = false, 1000);
            sendBleMessage({ type: 'set_direct_motor_control', motor: 'all', pwm: 0 });
        });
    }

    const setupGroupedInput = (ids, msgType) => {
        const sendGroupUpdate = () => {
            let msg = { type: msgType, params: {} };
            let payload = {};
            ids.forEach(i => {
                const inputElement = document.getElementById(i + 'Input');
                if (inputElement) {
                    let key = i.replace(/([A-Z])/g, "_$1").toLowerCase();
                    let value = parseFloat(inputElement.value);
                    if (key === 'expo_joystick' || key === 'joystick_output_scale' || key === 'turn_factor') {
                        value = value / 100.0;
                    }
                    payload[key] = value;
                }
            });
            msg.params = payload;
            sendBleMessage(msg);
        };
        ids.forEach(id => {
            const input = document.getElementById(id + 'Input'),
                  minusBtn = document.getElementById(id + 'Minus'),
                  plusBtn = document.getElementById(id + 'Plus');
            if (!input || !minusBtn || !plusBtn) return;
            const step = parseFloat(input.step) || 1;
            const isFloat = input.step.includes('.');
            const updateValue = (amount) => {
                let current = parseFloat(input.value),
                    newValue = current + amount;
                if (isFloat) {
                    const dp = (step.toString().split('.')[1] || '').length;
                    newValue = parseFloat(newValue.toFixed(dp));
                }
                input.value = Math.max(parseFloat(input.min), Math.min(parseFloat(input.max), newValue));
                sendGroupUpdate();
            };
            minusBtn.addEventListener('click', () => updateValue(-step));
            plusBtn.addEventListener('click', () => updateValue(step));
            input.addEventListener('change', sendGroupUpdate);
        });
    };
    
    async function runPresetSequence(commands) {
        if (isPresetSequenceRunning) {
            addLogMessage('[UI] Sekwencja jest juz w toku.', 'warn');
            return;
        }

        isPresetSequenceRunning = true;
        const applyBtn = document.getElementById('applyLqrPresetBtn');
        applyBtn.disabled = true;
        applyBtn.textContent = 'Wysylanie...';

        for (let i = 0; i < commands.length; i++) {
            const command = commands[i];
            addLogMessage(`[UI] Wysylanie grupy [${i + 1}/${commands.length}]: ${command.type}`, 'info');
            sendBleMessage(command);

            try {
                await new Promise((resolve, reject) => {
                    presetAckResolver = resolve;
                    presetAckTimeout = setTimeout(() => {
                        reject(new Error(`Timeout oczekiwania na potwierdzenie dla ${command.type}`));
                    }, PRESET_ACK_TIMEOUT_MS);
                });
                addLogMessage(`[UI] Otrzymano potwierdzenie dla ${command.type}.`, 'info');

            } catch (error) {
                addLogMessage(`[UI] BLAD: ${error.message}`, 'error');
                addLogMessage('[UI] Przerwano sekwencje presetow z powodu bledu.', 'error');
                break;
            }
        }

        isPresetSequenceRunning = false;
        presetAckResolver = null;
        if (presetAckTimeout) clearTimeout(presetAckTimeout);
        applyBtn.disabled = false;
        applyBtn.textContent = 'Zastosuj i Wczytaj do Panelu';
        addLogMessage('[UI] Zakonczono proces wysylania presetu.', 'info');
    }

    function applyPreset() {
        const select = document.getElementById('lqrPresetSelect');
        const key = select.value;
        if (!key) return;

        let presetName = select.options[select.selectedIndex].text;

        if (lqrBuiltInPresets[key]) {
            const preset = lqrBuiltInPresets[key];
            const mapping = { q1: 'q1AngleInput', q2: 'q2AngularVelInput', q3: 'q3PositionInput', q4: 'q4VelocityInput', r: 'rControlInput' };
            for (const [param, id] of Object.entries(mapping)) {
                const input = document.getElementById(id);
                if (input && preset.values[param] !== undefined) {
                    input.value = preset.values[param];
                }
            }
        } else if (key.startsWith(CUSTOM_PRESET_PREFIX)) {
            const presetDataString = localStorage.getItem(key);
            if (presetDataString) {
                const valuesToApply = JSON.parse(presetDataString);
                for (const [id, value] of Object.entries(valuesToApply)) {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = value;
                    }
                }
            }
        } else {
            return;
        }
        
        addLogMessage(`[UI] Zastosowano preset '${presetName}' do panelu. Rozpoczynam wysylanie sekwencyjne...`, 'info');

        const commandGroups = {
            'lqr_update': ['q1Angle', 'q2AngularVel', 'q3Position', 'q4Velocity', 'rControl', 'lqrOutputScalar'],
            'physics_update': ['mBody', 'mWheel', 'L'],
            'calibration_update': ['wheelDiameterCm', 'trackWidthCm', 'encoderPpr', 'headingCorrectionFactor', 'speedToAngleFactor', 'positionPGain', 'positionDGain', 'rotationPGain'],
            'set_joystick_tuning': ['joystickOutputScale', 'expoJoystick', 'maxSpeedJoystick', 'joystickAngleSensitivity', 'turnFactor'],
            'set_min_pwm': ['minPwmLeftFwd', 'minPwmLeftBwd', 'minPwmRightFwd', 'minPwmRightBwd']
        };

        const commandsToSend = [];
        Object.entries(commandGroups).forEach(([msgType, ids]) => {
            let msg = { type: msgType, params: {} };
            let payload = {};
            ids.forEach(i => {
                const inputElement = document.getElementById(i + 'Input');
                if (inputElement) {
                    let paramKey = i.replace(/([A-Z])/g, "_$1").toLowerCase();
                    let value = parseFloat(inputElement.value);
                    if (['expo_joystick', 'joystick_output_scale', 'turn_factor'].includes(paramKey)) {
                        value = value / 100.0;
                    }
                    payload[paramKey] = value;
                }
            });
            msg.params = payload;
            commandsToSend.push(msg);
        });
        
        runPresetSequence(commandsToSend);
    }

    function setupControls() {
        const debounceWrapper = (fn, delay = 1000) => {
            return function (...args) {
                const button = args[0].currentTarget;
                if (button.disabled) return;
                button.disabled = true;
                setTimeout(() => { button.disabled = false; }, delay);
                fn.apply(this, args);
            };
        };
        document.getElementById('connectBleBtn').addEventListener('click', debounceWrapper((e) => { connectBLE(); }));
        document.getElementById('balanceSwitch').addEventListener('change', e => { lastUserInteraction['balanceSwitch'] = Date.now(); sendBleMessage({ type: 'balance_toggle', enabled: e.target.checked }); });
        document.getElementById('holdPositionSwitch').addEventListener('change', e => {
            lastUserInteraction['holdPositionSwitch'] = Date.now();
            sendBleMessage({ type: 'hold_position_toggle', enabled: e.target.checked });
            document.getElementById('speedModeSwitch').disabled = e.target.checked;
            if (e.target.checked) {
                document.getElementById('speedModeSwitch').checked = false;
                sendBleMessage({ type: 'speed_mode_toggle', enabled: false });
            }
        });
        document.getElementById('speedModeSwitch').addEventListener('change', e => {
            sendBleMessage({ type: 'speed_mode_toggle', enabled: e.target.checked });
            document.getElementById('holdPositionSwitch').disabled = e.target.checked;
            if (e.target.checked) {
                document.getElementById('holdPositionSwitch').checked = false;
                sendBleMessage({ type: 'hold_position_toggle', enabled: false });
            }
        });
        document.getElementById('lqrEnabledSwitch').addEventListener('change', e => sendBleMessage({ type: 'lqr_enabled_toggle', enabled: e.target.checked }));
        document.getElementById('resetZeroBtn').addEventListener('click', debounceWrapper((e) => { sendBleMessage({ type: 'reset_zero' }); }));
        document.getElementById('trimPlusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_zero', value: 1 }));
        document.getElementById('trimMinusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_zero', value: -1 }));
        document.getElementById('trimRollPlusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_roll', value: 1 }));
        document.getElementById('trimRollMinusBtn').addEventListener('click', () => sendBleMessage({ type: 'adjust_roll', value: -1 }));
        document.getElementById('saveBtn').addEventListener('click', debounceWrapper((e) => { if (confirm("Czy na pewno chcesz nadpisac ustawienia w pamieci robota?")) { sendBleMessage({ type: 'save_tunings' }); addLogMessage('[UI] Wyslano polecenie ZAPISU do EEPROM.', 'info'); } }));
        document.getElementById('loadBtn').addEventListener('click', debounceWrapper((e) => { if (confirm("UWAGA! Spowoduje to nadpisanie wszystkich niezapisanych zmian. Kontynuowac?")) { sendBleMessage({ type: 'load_from_eeprom' }); addLogMessage('[UI] Wyslano polecenie ODCZYTU z EEPROM.', 'info'); } }));
        document.getElementById('emergencyStopBtn').addEventListener('click', debounceWrapper((e) => { sendBleMessage({ type: 'emergency_stop' }); }));
        document.getElementById('resetEncodersBtn').addEventListener('click', debounceWrapper((e) => { sendBleMessage({ type: 'reset_encoders' }); }));
        document.getElementById('calibrateMpuBtn').addEventListener('click', debounceWrapper((e) => { sendBleMessage({ type: 'calibrate_mpu' }); }));
        
        setupGroupedInput(['joystickOutputScale', 'expoJoystick', 'maxSpeedJoystick', 'joystickAngleSensitivity', 'turnFactor'], 'set_joystick_tuning');
        setupGroupedInput(['q1Angle', 'q2AngularVel', 'q3Position', 'q4Velocity', 'rControl', 'lqrOutputScalar'], 'lqr_update');
        setupGroupedInput(['mBody', 'mWheel', 'L'], 'physics_update');
        setupGroupedInput(['wheelDiameterCm', 'trackWidthCm', 'encoderPpr', 'headingCorrectionFactor', 'speedToAngleFactor', 'positionPGain', 'positionDGain', 'rotationPGain'], 'calibration_update');
        setupGroupedInput(['minPwmLeftFwd', 'minPwmLeftBwd', 'minPwmRightFwd', 'minPwmRightBwd'], 'set_min_pwm');
        setupManualTuningControls();
        setupDpadControls();
        setupSequenceControls();
    }

    function setupDpadControls() {
        document.querySelectorAll('.dpad-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const button = e.currentTarget; if (button.disabled) return;
                button.disabled = true; setTimeout(() => button.disabled = false, 500);
                const id = e.target.id;
                if (id === 'dpad-up') sendBleMessage({ type: 'execute_move', distance_cm: parseFloat(document.getElementById('dpadDistInput').value) });
                else if (id === 'dpad-down') sendBleMessage({ type: 'execute_move', distance_cm: -parseFloat(document.getElementById('dpadDistInput').value) });
                else if (id === 'dpad-left') sendBleMessage({ type: 'execute_rotate', angle_deg: -parseFloat(document.getElementById('dpadAngleInput').value) });
                else if (id === 'dpad-right') sendBleMessage({ type: 'execute_rotate', angle_deg: parseFloat(document.getElementById('dpadAngleInput').value) });
                else if (id === 'dpad-stop') sendBleMessage({ type: 'command_stop' });
            });
        });
    }

    function setupSequenceControls() {
        document.getElementById('add-sequence-step-btn').addEventListener('click', addSequenceStep);
        document.getElementById('run-sequence-btn').addEventListener('click', runSequence);
        document.getElementById('stop-sequence-btn').addEventListener('click', stopSequenceExecution);
        document.getElementById('clear-sequence-btn').addEventListener('click', clearSequence);
    }

    function addSequenceStep() {
        const list = document.getElementById('sequence-list');
        if (list.children.length >= MAX_SEQUENCE_STEPS) {
            addLogMessage(`[UI] Osiagnieto maksymalna liczbe krokow w sekwencji (${MAX_SEQUENCE_STEPS}).`, 'warn');
            return;
        }

        const stepDiv = document.createElement('div');
        stepDiv.className = 'sequence-step';
        stepDiv.innerHTML = `
            <select class="sequence-type">
                <option value="move_fwd">Przod (cm)</option>
                <option value="move_bwd">Tyl (cm)</option>
                <option value="rotate_r">Obrot w Prawo (st.)</option>
                <option value="rotate_l">Obrot w Lewo (st.)</option>
            </select>
            <input type="number" class="sequence-value" value="10">
            <button class="remove-step-btn">&times;</button>
        `;
        
        list.appendChild(stepDiv);

        const accordionContent = list.closest('.accordion-content');
        if (accordionContent) {
            updateAccordionHeight(accordionContent);
        }
        
        stepDiv.querySelector('.remove-step-btn').addEventListener('click', () => {
            stepDiv.remove();
            if (accordionContent) {
                updateAccordionHeight(accordionContent);
            }
        });
    }

    function runSequence() {
        if (isSequenceRunning) {
            addLogMessage('[UI] Sekwencja jest juz w toku.', 'warn');
            return;
        }
        const normalizedState = lastKnownRobotState.includes("BEZCZYN") ? "IDLE" : lastKnownRobotState;
        if (normalizedState !== 'IDLE' && normalizedState !== 'HOLDING_POSITION') {
            addLogMessage(`[UI] Nie mozna rozpoczac sekwencji. Robot jest w stanie '${lastKnownRobotState}'.`, 'error');
            return;
        }

        sequence = [];
        const steps = document.querySelectorAll('.sequence-step');
        if (steps.length === 0) {
            addLogMessage('[UI] Dodaj przynajmniej jeden krok do sekwencji.', 'warn');
            return;
        }

        steps.forEach(step => {
            sequence.push({
                type: step.querySelector('.sequence-type').value,
                value: parseFloat(step.querySelector('.sequence-value').value)
            });
        });

        isSequenceRunning = true;
        currentSequenceStep = 0;
        updateSequenceUI();
        addLogMessage(`[UI] Rozpoczeto sekwencje zlozoną z ${sequence.length} krokow.`, 'info');
        executeNextSequenceStep();
    }
    
    function stopSequenceExecution() {
        if (!isSequenceRunning) return;
        isSequenceRunning = false;
        sendBleMessage({ type: 'command_stop' });
        updateSequenceUI();
        addLogMessage('[UI] Sekwencja zatrzymana przez uzytkownika.', 'warn');
    }

    function clearSequence() {
        if (isSequenceRunning) {
            stopSequenceExecution();
        }
        const list = document.getElementById('sequence-list');
        const accordionContent = list.closest('.accordion-content');
        list.innerHTML = '';
        sequence = [];
        if (accordionContent) {
            updateAccordionHeight(accordionContent);
        }
    }
    
    function updateSequenceUI() {
        document.querySelectorAll('.sequence-step').forEach((step, index) => {
            if (isSequenceRunning && index === currentSequenceStep) {
                step.classList.add('executing');
            } else {
                step.classList.remove('executing');
            }
        });
        document.getElementById('run-sequence-btn').disabled = isSequenceRunning;
        document.getElementById('add-sequence-step-btn').disabled = isSequenceRunning;
        document.getElementById('clear-sequence-btn').disabled = isSequenceRunning;
        document.getElementById('stop-sequence-btn').disabled = !isSequenceRunning;
    }

    function checkAndExecuteNextSequenceStep(previousState) {
        if (!isSequenceRunning) return;
        
        const normalizedCurrent = lastKnownRobotState.includes('BEZCZYN') ? 'IDLE' : (lastKnownRobotState.includes('UTRZYMUJE') ? 'HOLDING_POSITION' : lastKnownRobotState);
        const normalizedPrevious = previousState.includes('RUCH') ? 'EXECUTING_MOVE' : (previousState.includes('OBROT') ? 'EXECUTING_ROTATE' : previousState);

        const isRobotIdle = normalizedCurrent === 'IDLE' || normalizedCurrent === 'HOLDING_POSITION';
        const wasRobotWorking = normalizedPrevious === 'EXECUTING_MOVE' || normalizedPrevious === 'EXECUTING_ROTATE';

        if (isRobotIdle && wasRobotWorking) {
            addLogMessage(`[UI] Krok ${currentSequenceStep + 1} zakonczony.`, 'info');
            currentSequenceStep++;
            executeNextSequenceStep();
        }
    }

    function executeNextSequenceStep() {
        if (!isSequenceRunning || currentSequenceStep >= sequence.length) {
            if (isSequenceRunning) { 
                isSequenceRunning = false;
                addLogMessage('[UI] Sekwencja zostala pomyslnie ukonczona.', 'info');
            }
            updateSequenceUI();
            return;
        }

        updateSequenceUI();
        const step = sequence[currentSequenceStep];
        let command = {};

        switch (step.type) {
            case 'move_fwd':
                command = { type: 'execute_move', distance_cm: step.value };
                break;
            case 'move_bwd':
                command = { type: 'execute_move', distance_cm: -step.value };
                break;
            case 'rotate_r':
                command = { type: 'execute_rotate', angle_deg: step.value };
                break;
            case 'rotate_l':
                command = { type: 'execute_rotate', angle_deg: -step.value };
                break;
        }
        
        addLogMessage(`[UI] Wysylanie kroku ${currentSequenceStep + 1}/${sequence.length}: ${command.type} (${step.value}).`, 'info');
        sendBleMessage(command);
    }
    
    function loadPresets() {
        const select = document.getElementById('lqrPresetSelect');
        select.innerHTML = '';
        const builtInGroup = document.createElement('optgroup');
        builtInGroup.label = 'Gotowe Zestawy';
        for (const [key, preset] of Object.entries(lqrBuiltInPresets)) {
            const option = document.createElement('option');
            option.value = key; option.textContent = preset.name;
            builtInGroup.appendChild(option);
        }
        select.appendChild(builtInGroup);
        const customGroup = document.createElement('optgroup');
        customGroup.label = 'Moje Ustawienia';
        let customPresetsFound = false;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(CUSTOM_PRESET_PREFIX)) {
                const option = document.createElement('option');
                option.value = key; option.textContent = key.replace(CUSTOM_PRESET_PREFIX, '');
                customGroup.appendChild(option);
                customPresetsFound = true;
            }
        }
        if (customPresetsFound) { select.appendChild(customGroup); }
        updateDeleteButtonState();
    }

    function updateDeleteButtonState() {
        const select = document.getElementById('lqrPresetSelect');
        const deleteBtn = document.getElementById('deletePresetBtn');
        deleteBtn.disabled = !select.value.startsWith(CUSTOM_PRESET_PREFIX);
    }

    function savePreset() {
        const nameInput = document.getElementById('newPresetNameInput');
        const name = nameInput.value.trim();
        if (!name) { alert('Wpisz nazwe dla nowego presetu!'); return; }
        const presetData = {};
        document.querySelectorAll('.config-value').forEach(input => { presetData[input.id] = input.value; });
        localStorage.setItem(CUSTOM_PRESET_PREFIX + name, JSON.stringify(presetData));
        addLogMessage(`[UI] Zapisano nowy preset: '${name}'`, 'info');
        nameInput.value = '';
        loadPresets();
    }

    function deletePreset() {
        const select = document.getElementById('lqrPresetSelect');
        const key = select.value;
        if (!key.startsWith(CUSTOM_PRESET_PREFIX)) { addLogMessage('[UI] Nie mozna usunac wbudowanego presetu.', 'warn'); return; }
        if (confirm(`Czy na pewno chcesz usunac preset '${key.replace(CUSTOM_PRESET_PREFIX, '')}'?`)) {
            localStorage.removeItem(key);
            addLogMessage(`[UI] Usunieto preset: '${key.replace(CUSTOM_PRESET_PREFIX, '')}'`, 'info');
            loadPresets();
        }
    }
    
    function setupHelpIcons() {
        document.querySelectorAll('.help-icon').forEach(icon => {
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                const container = icon.closest('.setting-container');
                const helpText = container.querySelector('.help-text');
                if (helpText) {
                    helpText.classList.toggle('visible');
                    const accordionContent = container.closest('.accordion-content');
                    if (accordionContent && accordionContent.classList.contains('active')) {
                        updateAccordionHeight(accordionContent);
                    }
                }
            });
        });
    }

    function setupChartControls() {
        const container = document.getElementById('chartControls');
        container.innerHTML = '';
        Object.keys(availableTelemetry).forEach((key) => {
            const label = document.createElement('label'), checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.value = key;
            checkbox.checked = (key === 'pitch' || key === 'target_angle' || key === 'lqr_output');
            checkbox.addEventListener('change', (e) => {
                const varName = e.target.value;
                sendBleMessage({ type: e.target.checked ? 'subscribe_variable' : 'unsubscribe_variable', name: varName });
                if (!e.target.checked) {
                    const chartData = telemetryChart.data, datasetIndex = chartData.datasets.findIndex(ds => ds.label === availableTelemetry[varName].label);
                    if (datasetIndex > -1) { chartData.datasets.splice(datasetIndex, 1); telemetryChart.update(); }
                }
            });
            label.appendChild(checkbox);
            label.append(` ${availableTelemetry[key].label}`);
            container.appendChild(label);
        });
    }

    function resizeJoystick() {
        const wrapper = document.getElementById('joystickWrapper');
        joystickCanvas.width = wrapper.offsetWidth;
        joystickCanvas.height = wrapper.offsetHeight;
        joystickCenter = { x: joystickCanvas.width / 2, y: joystickCanvas.height / 2 };
        joystickRadius = Math.min(joystickCanvas.width, joystickCanvas.height) / 2 * 0.9;
        knobRadius = joystickRadius / 3;
        drawJoystick(0, 0);
    }

    function drawJoystick(x, y) {
        joystickCtx.clearRect(0, 0, joystickCanvas.width, joystickCanvas.height);
        joystickCtx.beginPath();
        joystickCtx.arc(joystickCenter.x, joystickCenter.y, joystickRadius, 0, Math.PI * 2);
        joystickCtx.fillStyle = '#4a4f58';
        joystickCtx.fill();
        joystickCtx.beginPath();
        joystickCtx.arc(joystickCenter.x + x, joystickCenter.y + y, knobRadius, 0, Math.PI * 2);
        joystickCtx.fillStyle = '#a2f279';
        joystickCtx.fill();
    }

    function handleJoystickMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        const rect = joystickCanvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
        const x = clientX - rect.left - joystickCenter.x;
        const y = clientY - rect.top - joystickCenter.y;
        const distance = Math.sqrt(x * x + y * y);
        let finalX = x, finalY = y;
        if (distance > joystickRadius) {
            const angle = Math.atan2(y, x);
            finalX = joystickRadius * Math.cos(angle);
            finalY = joystickRadius * Math.sin(angle);
        }
        drawJoystick(finalX, finalY);
        const now = Date.now();
        if (now - lastJoystickSendTime > JOYSTICK_SEND_INTERVAL) {
            sendBleMessage({ type: 'joystick', x: finalX / joystickRadius, y: -finalY / joystickRadius });
            lastJoystickSendTime = now;
        }
    }

    function startJoystickDrag(e) { isDragging = true; handleJoystickMove(e); }

    function endJoystickDrag(e) {
        if (!isDragging) return;
        isDragging = false;
        drawJoystick(0, 0);
        sendBleMessage({ type: 'joystick', x: 0, y: 0 });
        lastJoystickSendTime = 0;
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupControls();
        resizeJoystick();
        setupChartControls();
        setupHelpIcons();
        loadPresets();
        const debounceWrapper = (fn, delay = 1000) => (e) => {
            const btn = e.currentTarget;
            if (btn.disabled) return;
            btn.disabled = true;
            setTimeout(() => btn.disabled = false, delay);
            fn(e);
        };
        document.getElementById('applyLqrPresetBtn').addEventListener('click', (e) => {
            applyPreset();
        });
        document.getElementById('savePresetBtn').addEventListener('click', debounceWrapper(savePreset));
        document.getElementById('deletePresetBtn').addEventListener('click', debounceWrapper(deletePreset));
        document.getElementById('lqrPresetSelect').addEventListener('change', updateDeleteButtonState);
        joystickCanvas.addEventListener('mousedown', startJoystickDrag);
        joystickCanvas.addEventListener('touchstart', startJoystickDrag, { passive: false });
        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('touchmove', handleJoystickMove, { passive: false });
        document.addEventListener('mouseup', endJoystickDrag);
        document.addEventListener('touchend', endJoystickDrag);
        document.querySelectorAll('.accordion-header.active').forEach(header => {
            const content = header.nextElementSibling;
            if (content) {
                setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; }, 100);
            }
        });
    });
    window.onresize = () => { resizeJoystick(); };
</script>
</body>
</html>```