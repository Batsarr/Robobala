<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RoboBala - Test: Refactored Interface Logic</title>
</head>
<body>
  <h2>Test: Refactored Interface Logic</h2>
  
  <h3>1. Sensor Mounting Presets</h3>
  <div style="margin: 10px 0;">
    <label>Test preset configurations:</label>
    <select id="testMountingSelect">
      <option value="standard">Standard mounting</option>
      <option value="rotated_90_cw">Rotated 90° CW</option>
      <option value="rotated_90_ccw">Rotated 90° CCW</option>
      <option value="rotated_180">Rotated 180°</option>
      <option value="inverted">Inverted</option>
    </select>
    <button id="testApplyPreset">Apply Preset</button>
  </div>
  <div id="presetResult" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
    Result: <span id="presetResultText">Not tested</span>
  </div>
  
  <h3>2. Manual Trim Correction Logic</h3>
  <div style="margin: 10px 0;">
    <p>Current manual correction: <span id="trimValueDisplay">0.00</span>°</p>
    <p>Current angle: <span id="angleVal">0.0°</span></p>
    <div>
      <button id="testSetZero">Set Zero (should reset to 0.00)</button>
      <button id="testTrimPlus">Add +0.1° correction</button>
      <button id="testTrimMinus">Add -0.1° correction</button>
    </div>
  </div>
  
  <h3>Test Log:</h3>
  <div id="testLog" style="border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
  
  <script>
    // Setup test environment
    window.sentMessages = [];
    window.AppState = { isConnected: true };
    window.telemetryData = { 
      trim_angle: 0,
      roll_trim: 0,
      qw: 1, qx: 0, qy: 0, qz: 0  // Identity quaternion (no rotation)
    };
    
    // Mock functions
    window.sendBleMessage = function(msg) {
      window.sentMessages.push(msg);
      logTest('sendBleMessage: ' + JSON.stringify(msg));
    };
    
    window.addLogMessage = function(msg, level) {
      logTest('[' + (level || 'info') + '] ' + msg);
    };
    
    function logTest(msg) {
      const log = document.getElementById('testLog');
      const entry = document.createElement('div');
      entry.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    
    // Define sensor mounting presets (from main.js)
    const sensorMountingPresets = {
      'standard': { pitch: { source: 0, sign: 1 }, yaw: { source: 1, sign: 1 }, roll: { source: 2, sign: 1 } },
      'rotated_90_cw': { pitch: { source: 2, sign: -1 }, yaw: { source: 1, sign: 1 }, roll: { source: 0, sign: 1 } },
      'rotated_90_ccw': { pitch: { source: 2, sign: 1 }, yaw: { source: 1, sign: 1 }, roll: { source: 0, sign: -1 } },
      'rotated_180': { pitch: { source: 0, sign: -1 }, yaw: { source: 1, sign: 1 }, roll: { source: 2, sign: -1 } },
      'inverted': { pitch: { source: 0, sign: -1 }, yaw: { source: 1, sign: -1 }, roll: { source: 2, sign: -1 } }
    };
    
    // Test 1: Sensor mounting presets
    document.getElementById('testApplyPreset').addEventListener('click', () => {
      const selectedPreset = document.getElementById('testMountingSelect').value;
      window.sentMessages = [];
      
      if (sensorMountingPresets[selectedPreset]) {
        const mapping = sensorMountingPresets[selectedPreset];
        window.sendBleMessage({ type: 'set_imu_mapping', mapping });
        
        document.getElementById('presetResultText').textContent = 
          'PASS - Message sent: ' + JSON.stringify(mapping);
        document.getElementById('presetResult').style.backgroundColor = '#d4edda';
      } else {
        document.getElementById('presetResultText').textContent = 'FAIL - Preset not found';
        document.getElementById('presetResult').style.backgroundColor = '#f8d7da';
      }
    });
    
    // Test 2: Manual trim correction
    let manualPitchCorrection = 0;
    let pitchTrimBase = null;
    
    function updateAndSendTrim(delta) {
      const telemetryTrim = window.telemetryData.trim_angle || 0;
      const newTrim = telemetryTrim + delta;
      
      manualPitchCorrection += delta;
      
      const span = document.getElementById('trimValueDisplay');
      if (span) span.textContent = manualPitchCorrection.toFixed(2);
      
      window.sendBleMessage({ type: 'set_param', key: 'trim_angle', value: newTrim });
      window.addLogMessage(`Manual correction: ${delta > 0 ? '+' : ''}${delta.toFixed(2)}°, total: ${manualPitchCorrection.toFixed(2)}°`);
    }
    
    function setPitchZero() {
      // Simulate raw pitch from quaternion (identity = 0)
      const rawPitch = 0;
      const newTrim = -rawPitch;
      
      pitchTrimBase = newTrim;
      manualPitchCorrection = 0;
      
      window.sendBleMessage({ type: 'set_param', key: 'trim_angle', value: newTrim });
      window.sendBleMessage({ type: 'set_pitch_zero' });
      
      const span = document.getElementById('trimValueDisplay');
      if (span) span.textContent = '0.00';
      
      const val = document.getElementById('angleVal');
      if (val) val.textContent = '0.0 °';
      
      window.addLogMessage('Set Zero: Manual correction reset to 0.00°', 'success');
    }
    
    document.getElementById('testSetZero').addEventListener('click', () => {
      window.sentMessages = [];
      setPitchZero();
      logTest('✓ Test: Set Zero should reset manual correction to 0.00');
      logTest('Result: trimValueDisplay = ' + document.getElementById('trimValueDisplay').textContent);
    });
    
    document.getElementById('testTrimPlus').addEventListener('click', () => {
      window.sentMessages = [];
      updateAndSendTrim(0.1);
      logTest('✓ Test: Added +0.1° correction');
      logTest('Result: trimValueDisplay = ' + document.getElementById('trimValueDisplay').textContent);
    });
    
    document.getElementById('testTrimMinus').addEventListener('click', () => {
      window.sentMessages = [];
      updateAndSendTrim(-0.1);
      logTest('✓ Test: Added -0.1° correction');
      logTest('Result: trimValueDisplay = ' + document.getElementById('trimValueDisplay').textContent);
    });
    
    logTest('Test environment initialized');
    logTest('Ready to run tests...');
  </script>
</body>
</html>
