<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RoboBala - Test 3D Floor Movement</title>
  <style>
    body { background: #111; color: #fff; font-family: Arial, sans-serif; padding: 20px }
    .controls { display:flex; gap:8px; align-items:center; margin: 10px 0; }
    #robot3d-container { width: 640px; height: 360px; background: #222; margin-bottom: 10px; }
    button { padding:8px 14px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
  <h3>Test 3D Floor Movement</h3>
  <div id="robot3d-container"></div>
  <div class="controls">
    <button id="connectBtn">Mock Connect</button>
    <button id="init3dBtn">Init 3D</button>
  <button id="toggleMoveBtn">Toggle Movement</button>
  <!-- 3D UI controls (expected by main.js) -->
  <button id="reset3dViewBtn" style="display:none;">Reset 3D View</button>
  <button id="toggle3dAnimationBtn" style="display:none;">Toggle 3D Anim</button>
  <button id="toggle3dMovementBtn" style="display:none;">Toggle 3D Move</button>
    <button id="forwardBtn">Simulate Forward</button>
    <button id="backBtn">Simulate Backward</button>
    <button id="resetEncBtn">Reset Enc</button>
  </div>
  <div style="margin-top:10px;">
  <label>Encoder PPR: <input type="number" id="encoderPprInput" value="820"></label>
  <label>Wheel diam (cm): <input type="number" id="wheelDiameterInput" value="8.2"></label>
  <label>Robot Perspective: <input type="checkbox" id="robotPerspectiveCheckbox"></label>
  </div>
  <div style="margin-top:10px;">
    <div>Position X: <span id="robot3d-position-x">0</span></div>
    <div>Position Z: <span id="robot3d-position-z">0</span></div>
    <div>Left encoder: <span id="encoderLeftVal">0</span></div>
    <div>Right encoder: <span id="encoderRightVal">0</span></div>
  </div>
  <div id="log" style="white-space:pre; margin-top: 10px; color: #0f0;"></div>

  <script>
    // Minimal mocks used by main.js
    window.AppState = { isConnected: false, tempStates: {} };
    window.DocumentedDevices = window.DocumentedDevices || {};
    window.addLogMessage = function(msg, level) { const l = document.getElementById('log'); l.textContent = (new Date()).toISOString() + ' ' + msg + '\n' + l.textContent; };

    // Simple mock connect handler
    document.getElementById('connectBtn').addEventListener('click', async () => {
      AppState.isConnected = true;
      addLogMessage('[TEST] Mock connected', 'info');
    });

    // Load main.js after a minimal stub to avoid errors
  </script>
  <script src="../main.js"></script>
  <script>
    // Ensure minimal UI elements exist for main.js to use
    document.getElementById('init3dBtn').addEventListener('click', () => {
      if (typeof init3DVisualization === 'function') init3DVisualization();
      if (typeof animate3D === 'function') animate3D();
      addLogMessage('[TEST] 3D init + animation started', 'info');
    });
    document.getElementById('toggleMoveBtn').addEventListener('click', () => {
      // Simulate clicking the UI toggle in the real app
      const btn = document.getElementById('toggle3dMovementBtn');
      if (btn) btn.click();
      addLogMessage('[TEST] toggled movement', 'info');
    });
    document.getElementById('forwardBtn').addEventListener('click', () => {
      // Use global variables from main.js
      window.currentEncoderLeft = (window.currentEncoderLeft || 0) + 50;
      window.currentEncoderRight = (window.currentEncoderRight || 0) + 50;
      document.getElementById('encoderLeftVal').textContent = window.currentEncoderLeft;
      document.getElementById('encoderRightVal').textContent = window.currentEncoderRight;
      addLogMessage('[TEST] incremented encoders +50', 'info');
    });
    document.getElementById('backBtn').addEventListener('click', () => {
      window.currentEncoderLeft = (window.currentEncoderLeft || 0) - 50;
      window.currentEncoderRight = (window.currentEncoderRight || 0) - 50;
      document.getElementById('encoderLeftVal').textContent = window.currentEncoderLeft;
      document.getElementById('encoderRightVal').textContent = window.currentEncoderRight;
      addLogMessage('[TEST] decremented encoders -50', 'info');
    });
    document.getElementById('resetEncBtn').addEventListener('click', () => {
      window.currentEncoderLeft = window.currentEncoderRight = 0;
      document.getElementById('encoderLeftVal').textContent = 0;
      document.getElementById('encoderRightVal').textContent = 0;
      addLogMessage('[TEST] Reset encoders', 'info');
    });

    // Hook into UI positions to display tracked values
    const originalUpdatePositions = () => {
      const px = document.getElementById('robot3d-position-x');
      const pz = document.getElementById('robot3d-position-z');
      const encL = document.getElementById('encoderLeftVal');
      const encR = document.getElementById('encoderRightVal');
      if (!px || !pz || !encL || !encR) return;
      // Poll values
      setInterval(() => {
        px.textContent = (document.getElementById('robot3d-position-x')?.textContent || '0');
        pz.textContent = (document.getElementById('robot3d-position-z')?.textContent || '0');
      }, 200);
    };

    // Try to keep encoder input fields in sync
    setInterval(() => {
      const pprEl = document.getElementById('encoderPprInput');
      const wheelEl = document.getElementById('wheelDiameterInput');
      if (pprEl) document.getElementById('encoderPprInput').value = pprEl.value;
      if (wheelEl) document.getElementById('wheelDiameterInput').value = wheelEl.value;
    }, 500);

  </script>
</body>
</html>
